<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å”ç£Šçš„ä¸ªäººåšå®¢</title>
  
  <subtitle>è®°å½•æˆ‘çš„å­¦ä¹ ã€ç”Ÿæ´»ã€å·¥ä½œã€‚</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.tanglei.name/"/>
  <updated>2020-10-11T15:25:42.107Z</updated>
  <id>https://www.tanglei.name/</id>
  
  <author>
    <name>tanglei</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ç»™ JDK æŠ¥äº†ä¸€ä¸ª P4 çš„ Bugï¼Œç»“æœå±…ç„¶â€¦â€¦</title>
    <link href="https://www.tanglei.name/blog/a-jdk-bug-releate-to-URI.html"/>
    <id>https://www.tanglei.name/blog/a-jdk-bug-releate-to-URI.html</id>
    <published>2020-09-27T00:00:00.000Z</published>
    <updated>2020-10-11T15:25:42.107Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å…³äºä½œè€…ï¼šç¨‹åºçŒ¿çŸ³å¤´(ID: tangleithu)ï¼Œç°ä»»é˜¿é‡Œå·´å·´æŠ€æœ¯ä¸“å®¶ï¼Œæ¸…åå­¦æ¸£ï¼Œå‰å¤§ç–†åç«¯ Leaderã€‚ä»¥æ¯ç¯‡æ–‡ç« éƒ½è®©äººæœ‰æ”¶è·ä¸ºç›®çš„ï¼Œæ¬¢è¿å…³æ³¨ï¼Œäº¤æµå’ŒæŒ‡å¯¼ï¼æ–‡ç« é¦–å‘äºå¾®ä¿¡å…¬ä¼—å·ï¼Œæ¬¢è¿å…³æ³¨ã€‚</p></blockquote><p>åˆ†äº«ä¸€ä¸‹ä¹‹å‰è¸©çš„ä¸€ä¸ªå‘ï¼ŒèƒŒæ™¯æ˜¯è¿™æ ·çš„ï¼š </p><p>æˆ‘ä»¬çš„é¡¹ç›®ä¾èµ–äºä¸€ä¸ªå¤–éƒ¨æœåŠ¡ï¼Œè¯¥å¤–éƒ¨æœåŠ¡æä¾› REST æ¥å£ä¾›æˆ‘æ–¹è°ƒç”¨ï¼Œè¿™æ˜¯å¾ˆå¸¸è§çš„ä¸€ä¸ªåœºæ™¯ã€‚æœ¬åœ°å’Œæµ‹è¯•ç¯å¢ƒæµ‹è¯•éƒ½æ²¡æœ‰é—®é¢˜ï¼Œä¸€åˆ‡å°±ç»ªä¸Šäº†ç”Ÿäº§åï¼Œç¨‹åºè°ƒç”¨æ¥å£å°±æ€»æ˜¯ç½‘ç»œä¸é€šã€‚</p><p>éœ€è¦è¯´æ˜çš„æ˜¯æœ¬åœ°ã€æµ‹è¯•ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒé€šè¿‡ä¸åŒçš„åŸŸåè®¿é—®è¯¥å¤–éƒ¨æœåŠ¡ã€‚ç”Ÿäº§ç¨‹åºè°ƒç”¨ä¸é€šï¼Œç¥å¥‡çš„æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒé€šè¿‡ <code>curl</code> ç­‰å‘½ä»¤å´èƒ½å¤Ÿæ­£å¸¸è°ƒç”¨å¯¹æ–¹æ¥å£ã€‚</p><p><img src="/resources/a-jdk-bug-releate-to-URI/whatjpg.png" alt="img"></p><p>è¿™ TM å°±ç¥å¥‡äº†ï¼Œå”¯ä¸€ä¸åŒçš„å°±æ˜¯å‘èµ· HTTP è¯·æ±‚çš„å®¢æˆ·ç«¯äº†ï¼Œä¼°è®¡å°±æ˜¯ httpå®¢æˆ·ç«¯æœ‰é—®é¢˜äº†ï¼Ÿ é€šè¿‡æœ€åæ’æŸ¥å‘ç°ï¼Œå±…ç„¶å‘ç°äº†ä¸€æš â€œ JDK çš„ bugâ€â€¦â€¦</p><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥é‡ç°ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚ </p><h2 id="server-ç«¯å‡†å¤‡"><a href="#server-ç«¯å‡†å¤‡" class="headerlink" title="server ç«¯å‡†å¤‡"></a>server ç«¯å‡†å¤‡</h2><p>è¿™é‡Œç”¨ Nginx æ¨¡æ‹Ÿäº†ä¸€ä¸‹ ä¸Šæ–‡æåˆ°çš„ REST æœåŠ¡, å‡è®¾è°ƒç”¨æ­£å¸¸è¿”å› <code>&quot;Hello, World\n&quot;</code>ï¼ŒNginx é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen    80;</span><br><span class="line">    server_name test_1.tanglei.name;</span><br><span class="line">    location /testurl &#123;</span><br><span class="line">        add_header Content-Type &apos;text/plain; charset=utf-8&apos;;</span><br><span class="line">        return 200 &quot;Hello, World\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸åŒçš„-client-è¯·æ±‚"><a href="#ä¸åŒçš„-client-è¯·æ±‚" class="headerlink" title="ä¸åŒçš„ client è¯·æ±‚"></a>ä¸åŒçš„ client è¯·æ±‚</h2><p>ä¸‹é¢ç”¨ä¸åŒçš„ Http client ï¼ˆåˆ†åˆ«ç”¨å‘½ä»¤è¡Œ<code>curl</code>ï¼Œpythonçš„ <code>requests</code>åŒ…ï¼Œå’Œ Java çš„ URL ç­‰å°è¯•ï¼‰å»è¯·æ±‚ã€‚</p><ul><li><code>curl</code> è¯·æ±‚ï¼Œæ­£å¸¸ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@VM_77_245_centos vhost]<span class="comment"># curl -i "http://test_1.tanglei.name/testurl"</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx</span><br><span class="line">Date: Wed, 31 May 2017 09:53:01 GMT</span><br><span class="line">Content-Length: 13</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Type: text/plain; charset=utf-8</span><br><span class="line"></span><br><span class="line">Hello, World</span><br><span class="line">[root@VM_77_245_centos vhost]<span class="comment">#</span></span><br></pre></td></tr></table></figure><ul><li><code>python requests</code>  æ­£å¸¸ã€‚</li></ul><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> requests</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">"http://test_1.tanglei.name/testurl"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.text</span><br><span class="line"><span class="string">u'Hello, World\n'</span></span><br></pre></td></tr></table></figure><ul><li>Java çš„  <code>java.net.URLConnection</code> åŒæ ·æ­£å¸¸ã€‚</li></ul><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹é€šè¿‡ Java è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> String <span class="title">getContent</span><span class="params">(java.net.URL url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    java.net.URLConnection conn = url.openConnection();</span><br><span class="line">    java.io.InputStreamReader in = <span class="keyword">new</span> java.io.InputStreamReader(conn.getInputStream(), <span class="string">"utf-8"</span>);</span><br><span class="line">    java.io.BufferedReader reader = <span class="keyword">new</span> java.io.BufferedReader(in);    </span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">int</span> c = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> ((c = reader.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">        sb.append((<span class="keyword">char</span>)c);</span><br><span class="line">    &#125;</span><br><span class="line">    reader.close();</span><br><span class="line">    in.close();</span><br><span class="line">    String response = sb.toString();</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„è¿™ä¸ªæ–¹æ³• <code>String getContent(java.net.URL url)</code> ä¼ å…¥ä¸€ä¸ªæ„é€ å¥½çš„ <code>java.net.URL</code> ç„¶å get è¯·æ±‚ï¼Œå¹¶ä»¥ <code>String</code> æ–¹å¼è¿”å› responseã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String srcUrl = <span class="string">"http://test_1.tanglei.name/testurl"</span>;</span><br><span class="line">java.net.URL url = <span class="keyword">new</span> java.net.URL(srcUrl);</span><br><span class="line">System.out.println(<span class="string">"\nurl result:\n"</span> + getContent(url)); <span class="comment">// OK</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„è¯­å¥è¾“å‡ºæ­£å¸¸ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url result:</span><br><span class="line">Hello, World</span><br></pre></td></tr></table></figure><p>è¿™å°±å°¼ç›ç¥å¥‡äº†å§ã€‚çœ‹çœ‹æˆ‘ä»¬ç¨‹åºä¸­ç”¨çš„ httpclient çš„å®ç°ï¼Œç»“æœå‘ç°æ˜¯æœ‰ç”¨ <code>java.net.URI</code>ï¼Œå¿ƒæƒ³ï¼Œè¿™ä¸è‡³äºå§ï¼Œç”¨ URI å°±ä¸è¡Œäº†ä¹ˆã€‚ </p><p><img src="/resources/a-jdk-bug-releate-to-URI/buzhiyu.png" alt="img"></p><p>æ¢ <code>java.net.URI</code> è¯•è¯•?  ï¼ˆè¿™é‡Œä¸å±•å¼€è®²URLå’ŒURIçš„åŒºåˆ«è”ç³»äº†ï¼Œå¯ä»¥ç®€å•çš„è®¤ä¸ºURLæ˜¯URIçš„ä¸€ä¸ªå­é›†ï¼Œè¯¦ç»†çš„å¯å‚è€ƒ <a href="https://www.ibm.com/developerworks/cn/xml/x-urlni.html" target="_blank" rel="noopener">URIã€URL å’Œ URN</a>, <a href="https://en.wikipedia.org/wiki/Uniform_Resource_Identifier" target="_blank" rel="noopener">wiki URI</a>ï¼‰</p><p>ç›´æ¥é€šè¿‡<code>java.net.URI</code>æ„é€ ï¼Œå†è°ƒç”¨ <code>URI.toURL</code> å¾—åˆ° <code>URL</code>ï¼Œè°ƒç”¨åŒæ ·æ­£å¸¸ã€‚</p><p>å…³é”®çš„æ¥äº†ï¼Œhttpclient æºç ä¸­ç”¨çš„æ„é€ å‡½æ•°æ˜¯å¦å¤–ä¸€ä¸ªï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">URI(String scheme, String host, String path, String fragment)</span><br><span class="line">Constructs a hierarchical URI from the given components.</span><br></pre></td></tr></table></figure><p>æˆ‘ç”¨è¿™ä¸ªæ–¹æ³•æ„é€ <code>URI</code>ï¼Œä¼šæ„é€ å¤±è´¥ï¼š </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> java.net.URI(uri.getScheme(), uri.getHost(), uri.getPath(), <span class="keyword">null</span>) error: protocol = http host = <span class="keyword">null</span></span><br><span class="line"><span class="keyword">new</span> java.net.URI(url.getProtocol(), url.getHost(), url.getPath(), <span class="keyword">null</span>) error: Illegal character in hostname at index <span class="number">11</span>: http:<span class="comment">//test_1.tanglei.name/testurl</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥é—®é¢˜å‘ç°äº†ï¼Œæˆ‘ä»¬çš„é¡¹ç›®ä¸­ä¾èµ–çš„ç¬¬ä¸‰æ–¹ httpclientåŒ…åº•å±‚ç”¨åˆ°äº† <code>java.net.URI</code>ï¼Œæ°å¥½åœ¨ <code>java.net.URI</code> ä¸­æ˜¯ä¸å…è®¸ä»¥ä¸‹åˆ’çº¿(<code>_</code>)ä½œä¸º <code>hostname</code> å­—æ®µçš„ã€‚</p><p>å³ <code>uri.getHost()</code> å’Œ <code>uri.toURL().getHost()</code> å±…ç„¶èƒ½ä¸ç›¸ç­‰ã€‚</p><h2 id="è¿™æ˜¯-JDK-çš„-Bug-å§ï¼Ÿ"><a href="#è¿™æ˜¯-JDK-çš„-Bug-å§ï¼Ÿ" class="headerlink" title="è¿™æ˜¯ JDK çš„ Bug å§ï¼Ÿ"></a>è¿™æ˜¯ JDK çš„ Bug å§ï¼Ÿ</h2><p>æœ‰ç†ç”±æ€€ç–‘ï¼Œè¿™æ˜¯ JDK çš„ Bug å—ï¼Ÿ</p><p><img src="/Users/tanglei/github/hexo.tanglei.name/source/resources/a-jdk-bug-releate-to-URI/bug.png" alt="image-20200919102937998"></p><p>ä»å®˜ç½‘ä¸Šè¿˜çœŸæ‰¾åˆ°äº†å…³äºåŒ…å«ä¸‹åˆ’çº¿ä½œä¸ºhostnameçš„bugæäº¤issueï¼Œæˆ³è¿™é‡Œ <a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=8132508" target="_blank" rel="noopener">JDK-8132508 : Bug JDK-8029354 reproduces with underscore in hostname</a>ï¼Œç„¶åå‘ç°è¯¥ â€œbugâ€ reporter çš„æƒ…å†µè²Œä¼¼è·Ÿæˆ‘çš„å·®ä¸å¤šï¼Œåªä¸è¿‡å¼•çˆ†bugçš„ç‚¹ä¸ä¸€æ ·ã€‚</p><p>è¯¥ â€œbugâ€ reviewer æœ€åä»¥ â€œNot an Issueâ€ å…³é—­ï¼Œç»™å‡ºçš„ç†ç”±æ˜¯ï¼š</p><blockquote><p>RFC 952 disallows _ underscores in hostnames. So, this is not a bug. </p></blockquote><p>ç¡®å®ï¼Œ<a href="https://tools.ietf.org/html/rfc952" target="_blank" rel="noopener">rfc952</a> æ˜ç¡®è¯´äº†åŸŸååªèƒ½ç”± å­—æ¯ <code>(A-Z)</code>ã€ æ•°å­—<code>(0-9)</code>ã€ å‡å· <code>(-)</code> å’Œ ç‚¹ <code>(.)</code> ç»„æˆã€‚</p><p>é‚£ OK å§ï¼Œæ—¢ç„¶æ˜ç¡®è§„å®šäº† hostname ä¸èƒ½åŒ…å«ä¸‹åˆ’çº¿ï¼Œä¸ºå•¥ <code>java.net.URL</code> ç¡®å…è®¸å‘¢ï¼Ÿ</p><p>é€ æˆ <code>java.net.URI</code> å’Œ <code>java.net.URL</code> åœ¨å¤„ç† hostname æ—¶çš„æ ‡å‡†ä¸ä¸€è‡´ï¼Œä¸”æœ¬èº« <code>java.net.URI</code> åœ¨æ„é€ çš„æ—¶å€™ä¹Ÿå¸¦äº† â€œæœ‰è‰²â€çœ¼é•œï¼ŒåŒä¸€ä¸ªurlå­—ç¬¦ä¸² é€šè¿‡é™æ€æ–¹æ³• <code>java.net.URI.create(String)</code> æˆ–è€…é€šè¿‡å¸¦1ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³• <code>java.net.URI(String)</code> éƒ½èƒ½æˆåŠŸæ„é€ å‡º URI çš„å®ä¾‹ï¼Œä½†é€šè¿‡å¸¦4ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•å°±ä¸èƒ½æ„é€ äº†ã€‚ </p><p>è¦çŸ¥é“ï¼Œåœ¨ coding è¿‡ç¨‹ä¸­ï¼Œ<strong>å°½æ—©</strong>åé¦ˆå¼‚å¸¸ä¿¡æ¯æ›´æœ‰åˆ©äºè½¯ä»¶å¼€å‘æŒç»­è¿­ä»£çš„è¿‡ç¨‹ã€‚æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¹Ÿåº”è¯¥éµå¾ªè¿™ä¸€ç‚¹åŸåˆ™ã€‚ </p><p>äºæ˜¯æˆ‘å°±å» JDK å®˜ç½‘æäº¤äº†ä¸€ä¸ª bugï¼Œå¤§æ„æ˜¯è¯´ <code>java.net.URI</code> å’Œ <code>java.net.URL</code> åœ¨å¤„ç†hostnameçš„æ—¶å€™æ ‡å‡†ä¸ä¸€è‡´ï¼Œå®¹æ˜“ä½¿å¼€å‘äººå‘˜åŸ‹è—ä¸€äº›æ½œåœ¨çš„bugï¼ŒåŒæ—¶ä¹Ÿè¿˜æŠŠè¿™ä¸ªé—®é¢˜åé¦ˆåˆ°  <a href="https://stackoverflow.com/questions/44226003/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-conta" target="_blank" rel="noopener">stackoverflow</a> äº†ã€‚</p><blockquote><p>I am wondering, if hostname with underscore is not valid, why the result is differrent between java.net.URI and java.net.URL? Is it a bug or a feature? Here is the example.</p><p>java.net.URL url = new java.net.URL(â€œ<a href="http://test_1.tanglei.name&quot;)" target="_blank" rel="noopener">http://test_1.tanglei.name&quot;)</a>;<br>System.out.println(url.getHost()); //test_1.tanglei.name<br>java.net.URI uri = new java.net.URI(â€œ<a href="http://test_1.tanglei.name&quot;)" target="_blank" rel="noopener">http://test_1.tanglei.name&quot;)</a>;<br>System.out.println(uri.getHost()); //null<br>è¿™ä¸ª JDK bug issue è¯¦ç»†ä¿¡æ¯è§ <a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=8170265" target="_blank" rel="noopener">JDK-8170265 : underscore is allowed in java.net.URL while not in java.net.URI</a>, (<a href="https://bugs.openjdk.java.net/browse/JDK-8170265" target="_blank" rel="noopener">openjdk JDK-8170265</a> æ›´è¯¦ç»†ï¼‰ã€‚</p></blockquote><p><img src="/resources/a-jdk-bug-releate-to-URI/jdk-bug.png" alt></p><p>ç»è¿‡åˆæ­¥ Reviewï¼Œè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ª P4 çš„ Bugï¼Œè¯´çš„æ˜¯ <code>java.net.URL</code> éµå¾ªçš„æ˜¯ <code>RFC 2396</code> è§„èŒƒï¼Œç¡®å®ä¸å…è®¸å«æœ‰ä¸‹åˆ’çº¿çš„ hostnameï¼Œ<code>java.net.URI</code> åšåˆ°äº†ï¼Œ è€Œ <code>java.net.URL</code> æ²¡æœ‰åšåˆ°ã€‚</p><blockquote><p>As per RFC 2396:<br>â€œHostnames take the form described in Section 3 of [RFC1034] and<br>Section 2.1 of [RFC1123]: a sequence of domain labels separated by<br>â€œ.â€, each domain label starting and ending with an alphanumeric<br>character and possibly also containing â€œ-â€œ characters.  The rightmost<br>domain label of a fully qualified domain name will never start with a<br>digit, thus syntactically distinguishing domain names from IPv4<br>addresses, and may be followed by a single â€œ.â€ if it is necessary to<br>distinguish between the complete domain name and any local domain.<br>To actually be â€œUniformâ€ as a resource locator, a URL hostname should<br>be a fully qualified domain name.  In practice, however, the host<br>component may be a local domain literal.â€</p></blockquote><blockquote><p>URI class is following the above, but URL class doesnâ€™t seem to follow the same rules.</p></blockquote><blockquote><p>To reproduce the issue , run the attached test case.<br>Following is the output on various JDK versions:<br>JDK 8 - Fail<br>JDK 8u112 - Fail<br>JDK 8u122-ea - Fail<br>JDK 9-ea + 141 - Fail</p></blockquote><p>é‡ç‚¹æ¥äº†ï¼Œç„¶åï¼Œå´è¢«å¦å¤–ä¸€ä¸ª Reviewer ç›´æ¥ä¸ªæ¯™äº†ã€‚ç»™å‡ºçš„åŸå› æ˜¯ <code>java.net.URL</code> æ„é€ æ–¹æ³•ä¸­ï¼ŒAPI æ–‡æ¡£ä¸­è¯´äº†æœ¬æ¥ä¹Ÿä¸ä¼šåšéªŒè¯å³ <code>No validation of the inputs is performed by this constructor.</code> <a href="https://docs.oracle.com/javase/8/docs/api/java/net/URL.html" target="_blank" rel="noopener">åœ¨çº¿ api doc æˆ³è¿™é‡Œ</a> (å¯ä»¥ç‚¹è¿æ¥ï¼Œè¿›å»æœç´¢å…³é”®å­— â€œNo validationâ€)</p><blockquote><p>The constructors of URL class (e.g., <a href="http://download.java.net/java/jdk9/docs/api/java/net/URL.html#URL-java.lang.String-java.lang.String-java.lang.String-" target="_blank" rel="noopener">http://download.java.net/java/jdk9/docs/api/java/net/URL.html#URL-java.lang.String-java.lang.String-java.lang.String-</a>) specifically mention about the validation: </p></blockquote><blockquote><p>â€œNo validation of the inputs is performed by this constructor.â€ </p></blockquote><blockquote><p>So not throwing an exception isnâ€™t an issue here.</p></blockquote><p><img src="/resources/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-contains-underscore/nonsense.jpg" alt></p><p>å½“åˆæ²¡æœ‰æ”¶åˆ°åŠæ—¶åé¦ˆï¼Œå°±æ²¡æœ‰æ¥å¾—åŠæ€¼å›å»ã€‚</p><p>å…¶å®å°±ç®— â€œNo validation of the inputs is performed by this constructor.â€ æ˜¯åˆç†çš„ï¼Œé‡Œé¢ä¹Ÿåªæœ‰3ä¸ªæ„é€ å‡½æ•°æœ‰è¿™æ ·çš„è¯´æ˜ï¼ŒæŒ‰ç…§è¿™æ ·çš„é€»è¾‘æ˜¯ä¸æ˜¯è¯´å¦å¤–çš„æ„é€ å‡½æ•°æœ‰éªŒè¯å‘¢â€¦.. (ç¤ºä¾‹ä¸­çš„é»˜è®¤çš„æ„é€ å‡½æ•°éƒ½æ²¡æœ‰è¯´å‘€)</p><p><a href="http://www.docjar.com/html/api/java/net/URL.java.html" target="_blank" rel="noopener">è¿™é‡Œæœ‰java.net.URL çš„æºç </a>ï¼Œçœ‹å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ã€‚</p><p>æ©ï¼Œä»¥ä¸Šå°±æ˜¯ç»“è®ºäº†ã€‚</p><p>ä¸è¿‡ï¼Œåæ­£æˆ‘è‡ªå·±æ„Ÿè§‰ç›®å‰Java API å…³äºè¿™é‡Œçš„è®¾è®¡ä¸å¤ªåˆç†ï¼Œæ¬¢è¿å¤§å®¶è®¨è®ºã€‚</p><p><a href="https://stackoverflow.com/questions/44226003/conflicts-between-java-net-url-and-java-net-uri-when-dealing-with-hostname-conta?answertab=active#tab-top" target="_blank" rel="noopener">æˆ‘åœ¨SOæé—®çš„è¿™ä¸ªå›ç­”</a>æ¯”è¾ƒæœ‰æ„æ€ï¼Œå“ˆå“ˆã€‚</p><blockquote><p>The review is somewhat terse, but the reviewerâ€™s point is the URL constructor is behaving in accordance with its specification. Since the specification explicitly states that no validation is performed, this is not a bug in the code. This is indisputable.</p></blockquote><blockquote><p>What he didnâ€™t spell out is that fixing this inconsistency (by changing the URL class specification) would break lots of peoplesâ€™ 20+ year old code Java code. That would be a really bad idea. It canâ€™t happen.</p></blockquote><blockquote><p>So â€¦ this inconsistency is a â€œfeatureâ€.</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;å…³äºä½œè€…ï¼šç¨‹åºçŒ¿çŸ³å¤´(ID: tangleithu)ï¼Œç°ä»»é˜¿é‡Œå·´å·´æŠ€æœ¯ä¸“å®¶ï¼Œæ¸…åå­¦æ¸£ï¼Œå‰å¤§ç–†åç«¯ Leaderã€‚ä»¥æ¯ç¯‡æ–‡ç« éƒ½è®©äººæœ‰æ”¶è·ä¸ºç›®çš„ï¼Œæ¬¢è¿å…³æ³¨ï¼Œäº¤æµå’ŒæŒ‡å¯¼ï¼æ–‡ç« é¦–å‘äºå¾®ä¿¡å…¬ä¼—å·ï¼Œæ¬¢è¿å…³æ³¨ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åˆ†äº«ä¸€ä¸‹
      
    
    </summary>
    
      <category term="ç»éªŒæŠ€å·§" scheme="https://www.tanglei.name/categories/%E7%BB%8F%E9%AA%8C%E6%8A%80%E5%B7%A7/"/>
    
    
      <category term="Java" scheme="https://www.tanglei.name/tags/Java/"/>
    
      <category term="ç»éªŒæŠ€å·§" scheme="https://www.tanglei.name/tags/%E7%BB%8F%E9%AA%8C%E6%8A%80%E5%B7%A7/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†æäº†è·å¾—å®¶åº­æ‘‡å·æ–°èƒ½æºæŒ‡æ ‡çš„æ•°æ®åï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªç§˜å¯†</title>
    <link href="https://www.tanglei.name/blog/data-analysis-of-first-new-energy-car-tickets.html"/>
    <id>https://www.tanglei.name/blog/data-analysis-of-first-new-energy-car-tickets.html</id>
    <published>2020-09-17T00:00:00.000Z</published>
    <updated>2020-10-11T15:25:42.107Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å…³äºä½œè€…ï¼šç¨‹åºçŒ¿çŸ³å¤´(ID: tangleithu)ï¼Œç°ä»»é˜¿é‡Œå·´å·´æŠ€æœ¯ä¸“å®¶ï¼Œæ¸…åå­¦æ¸£ï¼Œå‰å¤§ç–†åç«¯ Leaderã€‚ä»¥æ¯ç¯‡æ–‡ç« éƒ½è®©äººæœ‰æ”¶è·ä¸ºç›®çš„ï¼Œæ¬¢è¿å…³æ³¨ï¼Œäº¤æµå’ŒæŒ‡å¯¼ï¼æ–‡ç« é¦–å‘äºå¾®ä¿¡å…¬ä¼—å·ï¼Œæ¬¢è¿å…³æ³¨ã€‚</p></blockquote><p>è¿™ä¸¤å¤©å…¬å¸ƒäº†åŒ—äº¬é¦–æ‰¹å®¶åº­æ–°èƒ½æºå°å®¢è½¦æŒ‡æ ‡ç§¯åˆ†æ’åºç»“æœã€‚</p><p>å½“ç„¶ï¼Œæ„æ–™ä¹‹ä¸­ï¼Œå¾ˆé—æ†¾ï¼Œæœ¬äººå¹¶æœªå…¥å›´ï¼Œæ’å 8W å·¦å³ã€‚çœ‹æ ·å­ï¼Œè¦æƒ³æ–°èƒ½æºç§¯åˆ†æ’åºä¸Šå»ï¼Œè¿˜å¾—æŠ“ç´§å¢åŠ å®¶åº­ä»£é™…æ•°å•Šã€‚ </p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/ZMXDhhGnYibv6ysV7I9y3B0ZUNWNKuSR3MB5qmicS3EJI9OBbATewyZ83VuP8oLKa0T3icFibU9icYJVJ76nKhmVIvA/640.jpg" alt="img"></p><p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™äº›æ•°æ®éƒ½æ˜¯æ€æ ·çš„ï¼Ÿ</p><p>ç½‘ç«™ä¸‹è½½äº† pdfï¼Œä¸ä¾¿äºåˆ†æï¼Œæ˜¾ç„¶ä½œä¸ºç¨‹åºçŒ¿è¿˜æ˜¯ä¹ æƒ¯ç”¨ç¨‹åºå‘˜çš„æ–¹å¼æ¥è¿›è¡Œåˆ†æï¼Œé¦–å…ˆè¿˜æ˜¯å…ˆè½¬ä¸ºçº¯æ–‡æœ¬æ–‡ä»¶å§ï¼Œå¯è½¬æ¢ä¸º csvã€‚</p><ol><li>ç½‘ä¸Šæœ‰å·¥å…·ï¼Œå¯ä¸Šä¼  pdfï¼Œè½¬ csvã€‚</li><li>å¯ä»¥ç›´æ¥ copy å‡ºæ¥ï¼Œç²˜è´´çº¯æ–‡æœ¬å³å¯ã€‚ç¬”è€…é‡‡ç”¨äº†è¿™ç§æ–¹å¼å¾ˆå¿«ã€‚</li></ol><p>æœ‰äº†å‰é¢è¿™ä¸¤ç¯‡æ–‡ç« ä½œä¸ºåŸºç¡€ï¼Œä¸‹é¢è¿™äº›æ•°æ®å¯è½»æ˜“è·å¾—ï¼š</p><ol><li><a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247489026&amp;idx=1&amp;sn=cf1650652a44d65730c5ee04258ad9e1&amp;chksm=eb4717e6dc309ef037674943645abe8356aa726416ea46f3349ba227520bd40c95f8a49aa3e5&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">æå‡å¼€å‘æ•ˆç‡Nå€çš„20+å‘½ä»¤è¡Œç¥å™¨!(é™„ demo)</a></li><li><a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247488114&amp;idx=1&amp;sn=b6191483135ecd7f7c0b735bc2dbe7a7&amp;chksm=eb471396dc309a80ba8df35f9e04ab585a80cb3f9e485fdf4c9afd380200c2d109b28335a00b&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">æ²¡æƒ³åˆ° Shell å‘½ä»¤ç«Ÿç„¶è¿˜èƒ½è¿™ä¹ˆç©ï¼Ÿ| Shell ç©è½¬å¤§æ•°æ®åˆ†æ</a></li></ol><p>å› ä¸º copy å‡ºæ¥çº¯æ–‡æœ¬ï¼Œå§“åå’Œèº«ä»½è¯è¿åœ¨ä¸€èµ·äº†ï¼Œéœ€è¦æ‹†åˆ†ä¸€ä¸‹ï¼Œå¾ˆç®€å•ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat car2020.csv | awk &apos;&#123;print substr($3, 1, match($3,/[0-9]/)-1) &quot;\t&quot;  substr($3, match($3,/[0-9]/)) &quot;\t&quot; $4 &quot;\t&quot; $5 &quot;\t&quot; $6 &quot;\t&quot; $7&#125;&apos; &gt; car-2020.csv</span><br></pre></td></tr></table></figure><p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/ZMXDhhGnYibv6ysV7I9y3B0ZUNWNKuSR3ibL5T5lRuGK6u8J6M4IXbLWaficXw4c7qWlM3hUZELc2ILHEAicRDtic9g/640" alt="æ‘‡å·æ•°æ®é›†csv"></p><h4 id="åˆ†æ•°åˆ†æ"><a href="#åˆ†æ•°åˆ†æ" class="headerlink" title="åˆ†æ•°åˆ†æ"></a>åˆ†æ•°åˆ†æ</h4><p>é¦–å…ˆï¼Œæ–‡ä»¶ç»“æœç›´æ¥æŒ‰ç…§åˆ†æ•°å€’åºçš„ã€‚</p><ul><li>æœ€é«˜åˆ† 228 åˆ†ï¼Œå®¶åº­å…± 7 ä¸ªäººç»„æˆã€‚</li><li>æœ€ä½åˆ† 72 åˆ†ï¼Œ2 ä»£ 4 äººçš„å®¶åº­å±…å¤šï¼Œä¹Ÿæœ‰ 3 ä»£ 4 äººçš„ã€‚</li></ul><p>çœ‹çœ‹åˆ†æ•°çš„åˆ†å¸ƒï¼Œå¤§å¤šæ•°å›´ç»•ç€ 70 -120 åˆ†ä¹‹é—´ï¼Œå æ¯” 80%ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat car-2020.csv | awk '&#123;print $5&#125;'  | uniq -c  | sort -k 1 -nr</span><br></pre></td></tr></table></figure><p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/ZMXDhhGnYibv6ysV7I9y3B0ZUNWNKuSR3LpFNHXjGIosO9TOBW9cibJqf6icmJehOSdzK7CCe4gpMTfSSTic96cZYQ/640" alt="ç§¯åˆ†åˆ†å¸ƒ"></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/ZMXDhhGnYibv6ysV7I9y3B0ZUNWNKuSR3eibFsp7PwzDgibkgotibibIp4pHnricjSm5LJicBFUbE6uMG7icZkErXfunMw/640" alt></p><h4 id="å®¶åº­æƒ…å†µ"><a href="#å®¶åº­æƒ…å†µ" class="headerlink" title="å®¶åº­æƒ…å†µ"></a>å®¶åº­æƒ…å†µ</h4><ul><li><p>å®¶åº­ä»£æ•°ï¼Œ è¿‘ 70% ä¸º 3 ä»£äººã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">âœ Downloads cat car-2020.csv | awk '&#123;print $4&#125;'  | sort | uniq -c</span><br><span class="line">6621 2</span><br><span class="line">13379 3</span><br></pre></td></tr></table></figure><p><img src="https://mmbiz.qpic.cn/mmbiz_png/ZMXDhhGnYibv6ysV7I9y3B0ZUNWNKuSR3IPMnRyHkjxCXgZgD9dIlhxAR0sSLneJXqr6wYibJlia9aHxFebDk6QibA/640" alt></p></li><li><p>å®¶åº­äººå£æ•°ï¼Œå±…ç„¶è¿˜æœ‰ 9 å£äººçš„ã€‚çœ‹äº†ä¸‹ï¼Œ9 å£äºº 3 ä»£ï¼ŒçŒœæµ‹ åŒæ–¹çˆ¶æ¯ 4 + ä¸¤å£ 2 + 3 å°å­©ï¼Ÿè¿˜æ˜¯æ€æ ·çš„ï¼Œæˆ‘çœ‹å®¶åº­ä¸»è¦ç”³è¯·äººä¹Ÿæ˜¯ä»ç¬¬ä¸€æœŸå°±å¼€å§‹ç”³è¯·æ‘‡å·äº†ï¼Œè¿™ä¹ˆå¤§ä¸€å®¶äººï¼Œä¹Ÿæ²¡ä¸ªè½¦ç‰Œï¼Œä¹Ÿæ˜¯ä¸å®¹æ˜“å•Šã€‚ </p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/ZMXDhhGnYibv6ysV7I9y3B0ZUNWNKuSR366icJickZFKaibZoctAmkib1k3MDQIFibLskNV9hqibRcREqiaarezGXWP3Ng/640" alt></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">âœ  Downloads cat car-2020.csv | awk '&#123;print $3&#125;'  | sort | uniq -c</span><br><span class="line">4245 3</span><br><span class="line">5124 4</span><br><span class="line">6912 5</span><br><span class="line">2284 6</span><br><span class="line">1240 7</span><br><span class="line"> 193 8</span><br><span class="line">   2 9</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ‘‡å·ä¸»ç”³è¯·äºº"><a href="#æ‘‡å·ä¸»ç”³è¯·äºº" class="headerlink" title="æ‘‡å·ä¸»ç”³è¯·äºº"></a>æ‘‡å·ä¸»ç”³è¯·äºº</h4><p>å¤ªå¤šäººä»ç¬¬ä¸€å¹´å°±å¼€å§‹äº†å‚ä¸æ‘‡å·äº†ã€‚ </p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">âœ  Downloads cat car-2020.csv | awk '&#123;print substr($6, 1, 4)&#125;'  | sort | uniq -c</span><br><span class="line">6874 2011</span><br><span class="line">7401 2012</span><br><span class="line">3729 2013</span><br><span class="line">1384 2014</span><br><span class="line"> 482 2015</span><br><span class="line"> 111 2016</span><br><span class="line">  19 2017</span><br></pre></td></tr></table></figure><p><img src="https://mmbiz.qpic.cn/mmbiz_png/ZMXDhhGnYibv6ysV7I9y3B0ZUNWNKuSR3cy2Md9RNibsEo1WYRlpM2mv4mK0zxIBRTM9qh9LhQKShTxv4Rn1ADYw/640" alt="img"></p><p>çœ‹äº†ä¸‹ï¼Œä»ç¬¬ä¸€æœŸæ‘‡å·çš„å°±æœ‰ 1367 ä¸ªã€‚ </p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">âœ  Downloads cat car-2020.csv | awk '&#123;print substr($6, 1, 7)&#125;'  | sort | uniq -c </span><br><span class="line">1367 2011-01</span><br><span class="line"> 797 2011-02</span><br><span class="line"> 665 2011-03</span><br><span class="line"> 519 2011-04</span><br><span class="line"> 473 2011-05</span><br><span class="line"> 356 2011-06</span><br><span class="line"> 424 2011-07</span><br><span class="line"> 448 2011-08</span><br><span class="line"> 407 2011-09</span><br><span class="line"> 516 2011-10</span><br><span class="line"> 434 2011-11</span><br><span class="line"> 468 2011-12</span><br></pre></td></tr></table></figure><h4 id="ä¸­ç­¾è€…è€å®¶å“ªé‡Œçš„ï¼Ÿ"><a href="#ä¸­ç­¾è€…è€å®¶å“ªé‡Œçš„ï¼Ÿ" class="headerlink" title="ä¸­ç­¾è€…è€å®¶å“ªé‡Œçš„ï¼Ÿ"></a>ä¸­ç­¾è€…è€å®¶å“ªé‡Œçš„ï¼Ÿ</h4><p>è¿™ä¸ªï¼Œéœ€è¦å€ŸåŠ©èº«ä»½è¯å·å¯¹åº”çš„è¡Œæ”¿åŒºåŸŸäº†ï¼Œæ€è·¯è·Ÿä¹‹å‰ <a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247488114&amp;idx=1&amp;sn=b6191483135ecd7f7c0b735bc2dbe7a7&amp;chksm=eb471396dc309a80ba8df35f9e04ab585a80cb3f9e485fdf4c9afd380200c2d109b28335a00b&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">æ²¡æƒ³åˆ° Shell å‘½ä»¤ç«Ÿç„¶è¿˜èƒ½è¿™ä¹ˆç©ï¼Ÿ| Shell ç©è½¬å¤§æ•°æ®åˆ†æ</a> è¿™ç¯‡æ–‡ç« ä¸Šä¸€æ ·ï¼Œç›´æ¥ç»™ç»“è®ºå§ã€‚å…ˆçœ‹æŒ‰ç…§çœè¿™ä¸ªçº§åˆ«æ¥åˆ’åˆ†çš„ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">âœ  Downloads join -1 2 -2 1 &lt;(cat car-2020.csv | awk '&#123;print substr($2, 1, 2)&#125;' |sort | uniq -c | sort -k1 -nr | head -n 30 | sort -k2) id-area.code2.sort.txt | sort -k2 -nr</span><br><span class="line">11 14792 åŒ—äº¬å¸‚</span><br><span class="line">13 1101 æ²³åŒ—çœ</span><br><span class="line">37 638 å±±ä¸œçœ</span><br><span class="line">41 360 æ²³å—çœ</span><br><span class="line">14 330 å±±è¥¿çœ</span><br><span class="line">23 296 é»‘é¾™æ±Ÿçœ</span><br><span class="line">21 291 è¾½å®çœ</span><br><span class="line">42 239 æ¹–åŒ—çœ</span><br><span class="line">15 224 å†…è’™å¤è‡ªæ²»åŒº</span><br><span class="line">22 217 å‰æ—çœ</span><br><span class="line">43 175 æ¹–å—çœ</span><br><span class="line">61 174 é™•è¥¿çœ</span><br><span class="line">34 169 å®‰å¾½çœ</span><br><span class="line">32 162 æ±Ÿè‹çœ</span><br><span class="line">51 161 å››å·çœ</span><br><span class="line">36 135 æ±Ÿè¥¿çœ</span><br><span class="line">12 107 å¤©æ´¥å¸‚</span><br><span class="line">62 82 ç”˜è‚ƒçœ</span><br><span class="line">33 64 æµ™æ±Ÿçœ</span><br><span class="line">35 53 ç¦å»ºçœ</span><br><span class="line">65 46 æ–°ç–†ç»´å¾å°”æ—è‡ªæ²»åŒº</span><br><span class="line">64 34 å®å¤å›æ—è‡ªæ²»åŒº</span><br><span class="line">45 33 å¹¿è¥¿å£®æ—è‡ªæ²»åŒº</span><br><span class="line">50 21 é‡åº†å¸‚</span><br><span class="line">63 19 é’æµ·çœ</span><br><span class="line">53 19 äº‘å—çœ</span><br><span class="line">44 19 å¹¿ä¸œçœ</span><br><span class="line">52 17 è´µå·çœ</span><br><span class="line">31 12 ä¸Šæµ·å¸‚</span><br><span class="line">46 6 æµ·å—çœ</span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€åˆ—ï¼šèº«ä»½è¯å¼€å¤´çš„ä¸¤ä½ï¼ŒåŸºæœ¬å®šä½åˆ°çœï¼›</li><li>ç¬¬äºŒåˆ—ï¼šå¯¹åº”çš„äººæ•°</li><li>ç¬¬ä¸‰åˆ—ï¼šå¯¹åº”çœ</li></ul><p><img src="https://mmbiz.qpic.cn/mmbiz_png/ZMXDhhGnYibv6ysV7I9y3B0ZUNWNKuSR3C48bfHnDacmPqt5uCq60TkbTdSJcibtwgX3Xv2LFUGBof2ia8vyL1eJA/640" alt></p><p>ä»ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿˜æ˜¯è€åŒ—äº¬å æ¯”æœ€å¤§ï¼Œå æ¯”74%äº†ã€‚çŸ³å¤´æƒ³æ‰¾ä¸ªå…è´¹çš„çƒ­åŠ›åœ°å›¾ç”Ÿæˆå·¥å…·å±•ç¤ºä¸€ä¸‹çš„ï¼ŒçŸ­æ—¶é—´ä¹‹ç±»æ²¡æ‰¾åˆ°ï¼Œå…ˆæ”¾å¼ƒäº†ã€‚</p><ul><li>å†çœ‹çœ‹åˆ°å¸‚åŒºçº§åˆ«çš„ï¼Œå‚è€ƒèº«ä»½è¯å‰ 6 ä½ã€‚</li></ul><p>å…ˆçœ‹çœ‹å‰ 30 çš„å§ï¼ŒåŸºæœ¬ä¹Ÿå°±æ˜¯å›´ç»•ç€åŒ—äº¬äº†ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">âœ  Downloads join -1 2 -2 1 &lt;(cat car-2020.csv | awk '&#123;print substr($2, 1, 6)&#125;' |sort | uniq -c | sort -k1 -nr | head -n 30 | sort -k2) address_code_uniq.csv | sort -k2 -nr</span><br><span class="line">110111 1592 æˆ¿å±±åŒº</span><br><span class="line">110223 1531 é€šå¿</span><br><span class="line">110224 1439 å¤§å…´å¿</span><br><span class="line">110108 1109 æµ·æ·€åŒº</span><br><span class="line">110105 1108 æœé˜³åŒº</span><br><span class="line">110222 1075 é¡ºä¹‰å¿</span><br><span class="line">110229 846 å»¶åº†å¿</span><br><span class="line">110106 734 ä¸°å°åŒº</span><br><span class="line">110221 725 æ˜Œå¹³å¿</span><br><span class="line">110226 610 å¹³è°·å¿</span><br><span class="line">110228 599 å¯†äº‘å¿</span><br><span class="line">110102 570 è¥¿åŸåŒº</span><br><span class="line">110227 557 æ€€æŸ”å¿</span><br><span class="line">110101 475 ä¸œåŸåŒº</span><br><span class="line">110104 471 å®£æ­¦åŒº</span><br><span class="line">110109 415 é—¨å¤´æ²ŸåŒº</span><br><span class="line">110103 382 å´‡æ–‡åŒº</span><br><span class="line">110107 332 çŸ³æ™¯å±±åŒº</span><br><span class="line">110225 189 æˆ¿å±±å¿</span><br><span class="line">131082 43 ä¸‰æ²³å¸‚</span><br><span class="line">230103 34 å—å²—åŒº</span><br><span class="line">140202 28 åŸåŒº</span><br><span class="line">110110 25 ç‡•å±±åŒº</span><br><span class="line">220104 24 æœé˜³åŒº</span><br><span class="line">150102 23 æ–°åŸåŒº</span><br><span class="line">130102 23 é•¿å®‰åŒº</span><br><span class="line">610103 22 ç¢‘æ—åŒº</span><br><span class="line">130203 21 è·¯åŒ—åŒº</span><br><span class="line">420106 19 æ­¦æ˜ŒåŒº</span><br><span class="line">130681 18 æ¶¿å·å¸‚</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œaddress_code_uniq.csv æ¥è‡ª <a href="https://raw.githubusercontent.com/jxlwqq/address-code-of-china/master/address_code.csvï¼Œæœ‰ä¸ªå‘çš„åœ°æ–¹å°±æ˜¯æ”¿åºœå®˜æ–¹ç½‘ç«™ä¸‹è½½çš„è¡Œæ”¿åŒºåŸŸä»£ç æ•°æ®" target="_blank" rel="noopener">https://raw.githubusercontent.com/jxlwqq/address-code-of-china/master/address_code.csvï¼Œæœ‰ä¸ªå‘çš„åœ°æ–¹å°±æ˜¯æ”¿åºœå®˜æ–¹ç½‘ç«™ä¸‹è½½çš„è¡Œæ”¿åŒºåŸŸä»£ç æ•°æ®</a> <a href="http://www.mca.gov.cn//article/sj/xzqh/2020/" target="_blank" rel="noopener">http://www.mca.gov.cn//article/sj/xzqh/2020/</a>æ˜¯æœ€æ–°çš„ï¼Œæœ‰çš„è¡Œæ”¿åŒºåŸŸä»£ç å·²æ’¤é”€ï¼Œä¸å†ä½¿ç”¨ã€‚ï¼ˆå¹¸äºçŸ³å¤´æ ¡éªŒäº†ä¸€ä¸‹ç»“æœæ•°æ®ï¼Œå‘ç°ç›¸å·®æ¯”è¾ƒå¤§ï¼‰</p><p>ä½†ä¹‹å‰å·²ç»æ ¸å‘çš„èº«ä»½è¯ä¸­ä¸èƒ½ä½œåºŸå§ã€‚ä¸¾ä¸ªä¾‹å­ï¼šè¡Œæ”¿åŒºåˆ’ä»£ç 110223(åŒ—äº¬å¸‚ é€šå¿)å·²æ’¤é”€ï¼Œæ–°å‘çš„èº«ä»½è¯ä¸­ä¸å†ä½¿ç”¨ã€‚</p><p>å¦å¤–ï¼Œè¿˜å‘ç°æœ‰ä¸€ä¾‹ä¸æ˜¯ç”¨èº«ä»½è¯å·ç ä½œä¸ºè¯ä»¶å·ç çš„ï¼Ÿçœ‹æ ·å­æ˜¯æŠ¤ç…§ï¼Ÿ<code>CH1HFP********</code>  è¿™ä¸ªï¼Œæˆ‘ä¹Ÿä¸æ‡‚äº†ã€‚ </p><p>å…ˆå°±è¿™ä¹ˆå¤šå§ã€‚å¦å¤–ï¼Œè‹¥æ„Ÿå…´è¶£çš„æœ‹å‹éœ€è¦æœ¬æ–‡åˆ†æçš„æ•°æ®é›†åˆç”¨ä½œäº¤æµå­¦ä¹ ä½¿ç”¨ï¼Œå¯å›å¤â€œç§¯åˆ†æ’åºâ€è·å–å¤„ç†çš„ Excelå’Œ CSV æ–‡ä»¶ã€‚</p><p>é™„ã€Šæ‘‡å·è§£é¢˜ç§¯åˆ†å¯¹ç…§è¡¨ã€‹</p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/ZMXDhhGnYibv6ysV7I9y3B0ZUNWNKuSR3eXbBD5fTYbiaRNowT5XL2icqqRnXDBKjvIbibiao8O1vnoicB88zLbKmiaOg/640" alt="img"></p><p>å›åˆ°é¢˜ç›®æœ¬èº«ï¼Œè¿™ä¸ªãŠ™ï¸ç§˜å¯†å°±æ˜¯ï¼šå¦‚æœè¦æƒ³å®¶åº­æ‘‡å·å°½æ—©â€œä¸­ç­¾â€ï¼Œé‚£å°±èµ¶ç´§ç”Ÿå¨ƒå§ï¼Œå“ˆå“ˆå“ˆğŸ˜ï¼Œåˆ«æ‰“æˆ‘ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;å…³äºä½œè€…ï¼šç¨‹åºçŒ¿çŸ³å¤´(ID: tangleithu)ï¼Œç°ä»»é˜¿é‡Œå·´å·´æŠ€æœ¯ä¸“å®¶ï¼Œæ¸…åå­¦æ¸£ï¼Œå‰å¤§ç–†åç«¯ Leaderã€‚ä»¥æ¯ç¯‡æ–‡ç« éƒ½è®©äººæœ‰æ”¶è·ä¸ºç›®çš„ï¼Œæ¬¢è¿å…³æ³¨ï¼Œäº¤æµå’ŒæŒ‡å¯¼ï¼æ–‡ç« é¦–å‘äºå¾®ä¿¡å…¬ä¼—å·ï¼Œæ¬¢è¿å…³æ³¨ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™ä¸¤å¤©å…¬
      
    
    </summary>
    
      <category term="ç»éªŒæŠ€å·§" scheme="https://www.tanglei.name/categories/%E7%BB%8F%E9%AA%8C%E6%8A%80%E5%B7%A7/"/>
    
    
      <category term="Shell" scheme="https://www.tanglei.name/tags/Shell/"/>
    
      <category term="Mac" scheme="https://www.tanglei.name/tags/Mac/"/>
    
      <category term="MyLife" scheme="https://www.tanglei.name/tags/MyLife/"/>
    
      <category term="å¼€å‘æ•ˆç‡" scheme="https://www.tanglei.name/tags/%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87/"/>
    
  </entry>
  
  <entry>
    <title>æå‡å¼€å‘æ•ˆç‡Nå€çš„20+å‘½ä»¤è¡Œç¥å™¨!(é™„ demo)</title>
    <link href="https://www.tanglei.name/blog/make-dev-more-efficiency-with-20-shell.html"/>
    <id>https://www.tanglei.name/blog/make-dev-more-efficiency-with-20-shell.html</id>
    <published>2020-09-10T00:00:00.000Z</published>
    <updated>2020-10-11T15:25:42.107Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å…³äºä½œè€…ï¼šç¨‹åºçŒ¿çŸ³å¤´(ID: tangleithu)ï¼Œç°ä»»é˜¿é‡Œå·´å·´æŠ€æœ¯ä¸“å®¶ï¼Œæ¸…åå­¦æ¸£ï¼Œå‰å¤§ç–†åç«¯ Leaderã€‚ä»¥æ¯ç¯‡æ–‡ç« éƒ½è®©äººæœ‰æ”¶è·ä¸ºç›®çš„ï¼Œæ¬¢è¿å…³æ³¨ï¼Œäº¤æµå’ŒæŒ‡å¯¼ï¼æ–‡ç« é¦–å‘äºå¾®ä¿¡å…¬ä¼—å·ï¼Œæ¬¢è¿å…³æ³¨ã€‚</p></blockquote><p>è¯»è€…ç¦åˆ©ï¼š<a href="https://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247488892&amp;idx=1&amp;sn=1b026c5a8688b880ca06c51c816265b1&amp;chksm=eb471498dc309d8eaac5bd296a3971901e624e9abfc5a0add8928f5ebc3a83b8402ebfadd95d&amp;scene=21&amp;token=1758347384&amp;lang=zh_CN#wechat_redirect" target="_blank" rel="noopener">ç‚¹è¿™é‡Œé€å‡ æœ¬æˆ‘ä»¬éƒ¨é—¨å‡ºçš„æ–°ä¹¦â€”â€”ã€Šå¼¹æ€§è®¡ç®—ï¼šæ— å¤„ä¸åœ¨çš„ç®—åŠ›ã€‹</a>ï¼Œå…è´¹åŒ…é‚®åˆ°å®¶ï¼Œæ¬¢è¿å¤§å®¶æ¥æŠ½å¥–ï¼Œä¹Ÿå¸®å¿™ review ä¸‹æŠ½å¥–çš„ä»£ç ã€‚</p><p>æœ¬æ–‡ä¸»è¦æ¥æºäºåœ¨ä¹‹å‰å…¬å¸çš„å°ç»„å†…éƒ¨çš„ä¸€ä¸ªå°åˆ†äº«ï¼Œæ•´ç†æˆä¸€ç¯‡æ–‡ç« poå‡ºæ¥ã€‚<br>é¢˜ç›®å« â€œShell åŠ©åŠ›å¼€å‘æ•ˆç‡æå‡â€ï¼Œæ›´åˆ‡é¢˜çš„åº”è¯¥æ˜¯å«â€œå‘½ä»¤è¡Œâ€æå‡å¼€å‘æ•ˆç‡ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰è®²åˆ° Shell ç¼–ç¨‹ï¼Œè€Œæ˜¯ä¸»è¦ä»‹ç» Linux æˆ–è€… Mac ä¸‹å¸¸ç”¨çš„ä¸€äº›åŸºæœ¬å·¥å…·å‘½ä»¤æ¥å¸®åŠ©å¤„ç†ä¸€äº›æ—¥å¸¸äº‹åŠ¡ã€‚</p><p>é€šè¿‡æœ¬æ–‡çš„ä»‹ç»ï¼Œä½ åº”è¯¥å¯¹ç›¸å…³å‘½ä»¤æœ‰ä¸€ä¸ªåˆæ­¥çš„äº†è§£ï¼ŒçŸ¥é“æ¯”å¦‚ç”¨ä»€ä¹ˆå‘½ä»¤å¯ä»¥å®Œæˆæ€æ ·çš„æ“ä½œï¼Œ<br>è‡³äºå…·ä½“çš„å‚æ•°ï¼Œä¸éœ€è¦åˆ»æ„åœ°èƒŒè¯µï¼Œç­‰åˆ°éœ€è¦ç”¨åˆ°çš„æ—¶å€™ï¼Œå†å» <code>cmd --help</code> æˆ–è€… <code>man cmd</code>ï¼Œç”¨å¾—å¤šäº†ï¼Œå¸¸ç”¨çš„å‘½ä»¤ä¹Ÿå°±è‡ªç„¶è®°ä½äº†ã€‚ </p><p>æœ¬æ–‡é¦–å…ˆä»‹ç»äº† Linux/Mac ä¸‹ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç„¶åç”¨å…·ä½“çš„ç¤ºä¾‹é˜è¿°äº†å¸¸ç”¨çš„å‘½ä»¤ç”¨æ³•ï¼Œæœ€åé€šè¿‡ä¸€ä¸¤ä¸ªæ¡ˆä¾‹æ¥è¯´æ˜è¿™äº›å·¥å…·çš„å¼ºå¤§ä¹‹å¤„ï¼š</p><ul><li>æ¯”å¦‚ç»™å®šä¸€ä¸ª nginx æ—¥å¿—æ–‡ä»¶ï¼Œèƒ½å¤Ÿæ‰¾å‡º HTTP 404 è¯·æ±‚æœ€å¤šçš„ top 10 æ˜¯ä»€ä¹ˆ? æ¯”å¦‚èƒ½æ‰¾åˆ°è¯·æ±‚è€—æ—¶æœ€å¤šçš„ top 10æ˜¯ä»€ä¹ˆ? </li><li>å†æ¯”å¦‚èƒ½å¤Ÿç®€å•çš„å¾—åˆ°æ¯å°æ—¶çš„â€PVâ€æ˜¯å¤šå°‘? å†æ¯”å¦‚æ‹¿åˆ°ä¸€ç¯‡æ–‡ç« ï¼Œ èƒ½å¦ç®€å•ç»Ÿè®¡ä¸€ä¸‹è¿™ç¯‡æ–‡ç« å•æ¬¡è¯é¢‘æœ€é«˜çš„10ä¸ªè¯è¯­æ˜¯ä»€ä¹ˆ?</li><li>éœ€è¦æ‰¹é‡æ”¹æŸä¸ªæ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶åï¼Œæ‰¹é‡å°†æ–‡ä»¶å¤¹ä¸‹çš„å›¾ç‰‡å‹ç¼©æˆå›ºå®šå¤§å°çš„ï¼Œç­‰ç­‰ã€‚</li></ul><h2 id="Mac-ç¯å¢ƒ"><a href="#Mac-ç¯å¢ƒ" class="headerlink" title="Mac ç¯å¢ƒ"></a>Mac ç¯å¢ƒ</h2><ul><li>zsh</li><li>on-my-zsh</li><li>plugin <ul><li>git</li><li>autojump</li><li>osx(man-preview/quick-look/pfd(print Finder director)/cdf(cd Finder))</li></ul></li><li>å¸¸ç”¨å¿«æ·é”®(<code>bindkey</code>)</li><li>æ¼”ç¤º: é«˜äº®/git/æ™ºèƒ½è¡¥å…¨/è·³è½¬(j, d)â€¦</li></ul><p>è¿™é‡Œç»™å¤§å®¶å±•ç¤ºä¸€ä¸ªå° Demoï¼Œä¹‹å‰åœ¨è§†é¢‘å·ï¼ˆç¨‹åºçŒ¿çŸ³å¤´ï¼Œæ¬¢è¿å…³æ³¨ï¼‰ä¸­åˆ†äº«çš„ä¸€ä¸ªå°è§†é¢‘ï¼Œæ¼”ç¤ºäº†å¦‚ä½•åœ¨ç›®å½•ä¹‹é—´å¿«é€Ÿè·³è½¬ã€‚</p><p>å…³äº Mac ç¨‹åºçŒ¿æé«˜æ•ˆç‡çš„ç›¸å…³æŠ€å·§ï¼Œæ›´å¤šçš„å¯ä»¥å‚è€ƒä»¥ä¸‹ä¸‰ç¯‡æ–‡ç« ï¼š</p><ul><li><a href="https://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247485871&amp;idx=1&amp;sn=c877775df684d8ab8c90bf2d38eee98a&amp;chksm=eb47084bdc30815d19182c51571b096a20b79bdee0956f68167ebc8ed3117364ac0602f83658&amp;token=551126633&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ â€“ Mac è½¯ä»¶æ¨èï¼ˆåºï¼‰</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247486659&amp;idx=1&amp;sn=b574d3f2a6af4544ceab48aadaa0a726&amp;chksm=eb470d27dc308431e8789a87e32a597c72cc0f2fe02d6fc80424aec11e41e712326b62603f27&amp;token=551126633&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">æœ‰äº†è¿™å‡ ä¸ªç¥å™¨ï¼Œç¬é—´é€¼æ ¼å°±ä¸Šå»äº†</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247487786&amp;idx=1&amp;sn=842202cc524477ec1546b4747bdbf1a8&amp;chksm=eb4710cedc3099d86953451729c7f569866e6e58abbbec5c7ebe7423d12e1f11e189bb417f80&amp;token=242044315&amp;lang=zh_CN#rd" target="_blank" rel="noopener">ä¼˜ç§€çš„ç¨‹åºå‘˜æ˜¯å¦‚ä½•åˆ©ç”¨å·¥å…·æ¥æå‡å·¥ä½œæ•ˆç‡çš„ï¼Ÿ</a></li></ul><h2 id="Shell-åŸºç¡€å‘½ä»¤"><a href="#Shell-åŸºç¡€å‘½ä»¤" class="headerlink" title="Shell åŸºç¡€å‘½ä»¤"></a>Shell åŸºç¡€å‘½ä»¤</h2><ul><li><p>which/whereisï¼Œ å¸¸ç”¨ <code>whatis</code>ï¼Œ <code>man</code>ï¼Œ <code>--help</code></p>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  .oh-my-zsh git:(master)$ whereis ls</span><br><span class="line">/bin/ls</span><br><span class="line">âœ  .oh-my-zsh git:(master)$ <span class="built_in">which</span> ls</span><br><span class="line">ls: aliased to ls -G</span><br></pre></td></tr></table></figure></li><li><p>åŸºæœ¬æ–‡ä»¶ç›®å½•æ“ä½œ</p>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rmï¼Œ mkdirï¼Œ mvï¼Œ cpï¼Œ <span class="built_in">cd</span>ï¼Œ lsï¼Œ lnï¼Œ fileï¼Œ <span class="built_in">stat</span>ï¼Œ wc(-l/w/c)ï¼Œ headï¼Œ moreï¼Œ tailï¼Œ cat...</span><br></pre></td></tr></table></figure></li><li><p>åˆ©å™¨ ç®¡é“: <code>|</code></p></li></ul><h2 id="Shell-æ–‡æœ¬å¤„ç†"><a href="#Shell-æ–‡æœ¬å¤„ç†" class="headerlink" title="Shell æ–‡æœ¬å¤„ç†"></a>Shell æ–‡æœ¬å¤„ç†</h2><p>è¿™é‡Œå°±æ˜¯é€šè¿‡æ¡ˆä¾‹è®²äº†ä¸€ä¸‹12ä¸ªå‘½ä»¤çš„å¤§è‡´ç”¨æ³•å’Œå‚æ•°ï¼Œå¯ä»¥é€šè¿‡ç‚¹å‡»å³è¾¹çš„ç›®å½•ï¼ˆæˆ‘åšå®¢æœ‰ç›®å½•ï¼Œå…¬ä¼—å·ä¸Šæœ¨æœ‰ï¼‰ç›´è¾¾ä½ æƒ³è¦äº†è§£çš„å‘½ä»¤ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find, grep, xargs, cut, paste, comm</span><br><span class="line">join, sort, uniq, tr, sed, awk</span><br></pre></td></tr></table></figure><h3 id="find"><a href="#find" class="headerlink" title="find"></a>find</h3><ul><li>å¸¸ç”¨å‚æ•°<ul><li>æ–‡ä»¶å <code>-name</code>ï¼Œ æ–‡ä»¶ç±»å‹<code>-type</code>ï¼Œ æŸ¥æ‰¾æœ€å¤§æ·±åº¦<code>-maxdepth</code></li><li>æ—¶é—´è¿‡æ»¤(create/access/modify) <code>-[cam]time</code></li><li>æ‰§è¡ŒåŠ¨ä½œ <code>-exec</code></li></ul></li><li><p>ç¤ºä¾‹</p>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find ./ -name <span class="string">"*.json"</span></span><br><span class="line">find . -maxdepth 7 -name <span class="string">"*.json"</span> -<span class="built_in">type</span> f</span><br><span class="line">find . -name <span class="string">"*.log.gz"</span> -ctime +7 -size +1M -delete (atime/ctime/mtime)</span><br><span class="line">find . -name <span class="string">"*.scala"</span> -atime -7 -<span class="built_in">exec</span> du -h &#123;&#125; \;</span><br></pre></td></tr></table></figure></li></ul><h3 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h3><ul><li><p>å¸¸ç”¨å‚æ•°</p><ul><li>-v(invert-match)ï¼Œ </li><li>-c(count)ï¼Œ </li><li>-n(line-number)ï¼Œ </li><li>-i(ignore-case)ï¼Œ </li><li>-lï¼Œ -Lï¼Œ -R(-rï¼Œ â€“recursive)ï¼Œ -e</li></ul></li><li><p>ç¤ºä¾‹</p>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grep <span class="string">'partner'</span> ./*.scala -l</span><br><span class="line">grep -e <span class="string">'World'</span> -e <span class="string">'first'</span> -i -R ./  (-e: or)</span><br></pre></td></tr></table></figure></li><li><p>ç›¸å…³å‘½ä»¤: <code>grep -z / zgrep / zcat xx | grep</code></p></li></ul><h3 id="xargs"><a href="#xargs" class="headerlink" title="xargs"></a>xargs</h3><ul><li><p>å¸¸ç”¨å‚æ•°</p><ul><li>-n(æ¯è¡Œåˆ—æ•°)ï¼Œ </li><li>-I(å˜é‡æ›¿æ¢)</li><li>-d(åˆ†éš”ç¬¦)ï¼Œ Mac ä¸æ”¯æŒï¼Œæ³¨æ„ä¸GNUç‰ˆæœ¬çš„åŒºåˆ«</li></ul></li><li><p>ç¤ºä¾‹    </p>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find . -<span class="built_in">type</span> f -name <span class="string">"*.jpg"</span> | xargs -n1 -I &#123;&#125; du -sh &#123;&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="cut"><a href="#cut" class="headerlink" title="cut"></a>cut</h3><ul><li><p>å¸¸ç”¨å‚æ•°</p><ul><li>-b(å­—èŠ‚)</li><li>-c(å­—ç¬¦)</li><li>-f(ç¬¬å‡ åˆ—)ï¼Œ-d(åˆ†éš”ç¬¦)ï¼Œf èŒƒå›´: <code>n, n-, -m, n-m</code></li></ul></li><li><p>ç¤ºä¾‹    </p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"helloworldhellp"</span> | cut -c1-10</span><br><span class="line">cut -dï¼Œ -f2-8 csu.db.export.csv</span><br></pre></td></tr></table></figure></li></ul><h3 id="paste"><a href="#paste" class="headerlink" title="paste"></a>paste</h3><ul><li><p>å¸¸ç”¨å‚æ•°</p><ul><li>-d åˆ†éš”ç¬¦</li><li>-s åˆ—è½¬è¡Œ</li></ul></li><li><p>ç¤ºä¾‹</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  Documents$ cat file1</span><br><span class="line">1 11</span><br><span class="line">2 22</span><br><span class="line">3 33</span><br><span class="line">4 44</span><br><span class="line">âœ  Documents$ cat file2</span><br><span class="line">one     1</span><br><span class="line">two     2</span><br><span class="line">three   3</span><br><span class="line">one1    4</span><br><span class="line"></span><br><span class="line">âœ  Documents$ paste -d, file1 file2</span><br><span class="line">1 11, one     1</span><br><span class="line">2 22, two     2</span><br><span class="line">3 33, three   3</span><br><span class="line">4 44, one1    4</span><br><span class="line">âœ  Documents$ paste -s -d: file1 file2</span><br><span class="line">a 11:b bb:3 33:4 44</span><br><span class="line">one     1:two     2:three   3:one1    4</span><br></pre></td></tr></table></figure></li></ul><h3 id="join"><a href="#join" class="headerlink" title="join"></a>join</h3><p>ç±»ä¼¼sqlä¸­çš„ <code>...inner join ...on ...</code>ï¼Œ <code>-t</code> åˆ†éš”ç¬¦ï¼Œé»˜è®¤ä¸ºç©ºæ ¼æˆ–tab</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  Documents$ cat j1</span><br><span class="line">1 11</span><br><span class="line">2 22</span><br><span class="line">3 33</span><br><span class="line">4 44</span><br><span class="line">5 55</span><br><span class="line">âœ  Documents$ cat j2</span><br><span class="line">one     1   0</span><br><span class="line">one     2   1</span><br><span class="line">two     4   2</span><br><span class="line">three   5   3</span><br><span class="line">one1    5   4</span><br><span class="line">âœ  Documents$ join -1 1 -2 3 j1 j2</span><br><span class="line">1 11 one 2</span><br><span class="line">2 22 two 4</span><br><span class="line">3 33 three 5</span><br><span class="line">4 44 one1 5</span><br></pre></td></tr></table></figure><h3 id="comm"><a href="#comm" class="headerlink" title="comm"></a>comm</h3><ul><li><p>å¸¸ç”¨å‚æ•°</p><ul><li>ç”¨æ³• <code>comm [-123i] file1 file2</code></li><li><strong>å­—å…¸åºåˆ—</strong>ï¼Œ 3åˆ—: åªåœ¨file1/file2/both</li><li><code>-</code> å»æ‰æŸåˆ—ï¼Œ<code>i</code> å¿½ç•¥å¤§å°å†™</li></ul></li><li><p>ç¤ºä¾‹</p>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  Documents$ seq 1 5 &gt;file11</span><br><span class="line">âœ  Documents$ seq 2 6 &gt;file22</span><br><span class="line">âœ  Documents$ cat file11</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">âœ  Documents$ cat file22</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">âœ  Documents$ comm file11 file22</span><br><span class="line">1</span><br><span class="line">        2</span><br><span class="line">        3</span><br><span class="line">        4</span><br><span class="line">        5</span><br><span class="line">    6</span><br><span class="line">âœ  Documents$ comm -1 file11 file22</span><br><span class="line">    2</span><br><span class="line">    3</span><br><span class="line">    4</span><br><span class="line">    5</span><br><span class="line">6</span><br><span class="line">âœ  Documents$ comm -2 file11 file22</span><br><span class="line">1</span><br><span class="line">    2</span><br><span class="line">    3</span><br><span class="line">    4</span><br><span class="line">    5</span><br><span class="line">âœ  Documents$ comm -23 file11 file22</span><br><span class="line">1</span><br></pre></td></tr></table></figure></li></ul><p>ç›¸å…³å‘½ä»¤ <strong>diff</strong>(ç±»ä¼¼<em>git diff</em>)</p><h3 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h3><ul><li>å¸¸ç”¨å‚æ•°<ul><li>-dï¼Œ â€“dictionary-order</li><li>-nï¼Œ â€“numeric-sort</li><li>-rï¼Œ â€“reverse</li><li>-bï¼Œ â€“ignore-leading-blanks</li><li>-kï¼Œ â€“key</li></ul></li><li><p>ç¤ºä¾‹</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  Documents$ cat file2</span><br><span class="line">one     1</span><br><span class="line">two     2</span><br><span class="line">three   3</span><br><span class="line">one1    4</span><br><span class="line">âœ  Documents$ sort file2</span><br><span class="line">one     1</span><br><span class="line">one1    4</span><br><span class="line">three   3</span><br><span class="line">two     2</span><br><span class="line">âœ  Documents$ sort -b -k2 -r file2</span><br><span class="line">one1    4</span><br><span class="line">three   3</span><br><span class="line">two     2</span><br><span class="line">one     1</span><br></pre></td></tr></table></figure></li></ul><h3 id="uniq"><a href="#uniq" class="headerlink" title="uniq"></a>uniq</h3><ul><li>å¸¸ç”¨å‚æ•°<ul><li>-c é‡å¤æ¬¡æ•°</li><li>-d é‡å¤çš„</li><li>-u æ²¡é‡å¤çš„</li><li>-f å¿½ç•¥å‰å‡ åˆ—</li></ul></li><li><p>ç¤ºä¾‹</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  Documents$ cat file4</span><br><span class="line">11</span><br><span class="line">22</span><br><span class="line">33</span><br><span class="line">11</span><br><span class="line">11</span><br><span class="line">âœ  Documents$ sort file4 | uniq -c</span><br><span class="line">   3 11</span><br><span class="line">   1 22</span><br><span class="line">   1 33</span><br><span class="line">âœ  Documents$ sort file4 | uniq -d</span><br><span class="line">11</span><br><span class="line">âœ  Documents$ sort file4 | uniq -u</span><br><span class="line">22</span><br><span class="line">33</span><br><span class="line">âœ  Documents$ cat file3</span><br><span class="line">one     1</span><br><span class="line">two     1</span><br><span class="line">three   3</span><br><span class="line">one1    4</span><br><span class="line">âœ  Documents$ uniq -c -f 1 file3</span><br><span class="line">   2 one     1</span><br><span class="line">   1 three   3</span><br><span class="line">   1 one1    4</span><br></pre></td></tr></table></figure></li></ul><p>æ³¨æ„ï¼š<code>uniq</code>æ¯”è¾ƒç›¸é‚»çš„æ˜¯å¦é‡å¤ï¼Œä¸€èˆ¬ä¸<code>sort</code>è”ç”¨</p><h3 id="tr"><a href="#tr" class="headerlink" title="tr"></a>tr</h3><ul><li><p>å¸¸ç”¨å‚æ•°</p><ul><li>-c è¡¥é›†</li><li>-d åˆ é™¤</li><li>-s å‹ç¼©ç›¸é‚»é‡å¤çš„</li></ul></li><li><p>ç¤ºä¾‹</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  Documents$ <span class="built_in">echo</span> <span class="string">'1111234444533hello'</span> | tr  <span class="string">'[1-3]'</span> <span class="string">'[a-c]'</span></span><br><span class="line">aaaabc44445cchello</span><br><span class="line">âœ  Documents$ <span class="built_in">echo</span> <span class="string">'1111234444533hello'</span> | tr -d <span class="string">'[1-3]'</span></span><br><span class="line">44445hello</span><br><span class="line">âœ  Documents$ <span class="built_in">echo</span> <span class="string">'1111234444533hello'</span> | tr -dc <span class="string">'[1-3]'</span></span><br><span class="line">11112333</span><br><span class="line">âœ  Documents$ <span class="built_in">echo</span> <span class="string">'1111234444533hello'</span> | tr -s <span class="string">'[0-9]'</span></span><br><span class="line">123453hello</span><br><span class="line">âœ  Documents$ <span class="built_in">echo</span> <span class="string">'helloworld'</span> | tr <span class="string">'[:lower:]'</span> <span class="string">'[:upper:]'</span></span><br><span class="line">HELLOWORLD</span><br></pre></td></tr></table></figure></li></ul><h3 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h3><ul><li>å¸¸ç”¨å‚æ•°<ul><li>-d åˆ é™¤</li><li>-s æ›¿æ¢ï¼Œ g å…¨å±€</li><li>-e å¤šä¸ªå‘½ä»¤å åŠ </li><li>-i ä¿®æ”¹åŸæ–‡ä»¶(Macä¸‹åŠ å‚æ•° â€œâ€ï¼Œå¤‡ä»½)</li></ul></li><li><p>ç¤ºä¾‹</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  Documents$ cat file2</span><br><span class="line">one     1</span><br><span class="line">two     2</span><br><span class="line">three   3</span><br><span class="line">one1    4</span><br><span class="line">âœ  Documents$ sed <span class="string">"2,3d"</span> file2</span><br><span class="line">one     1</span><br><span class="line">one1    4</span><br><span class="line">âœ  Documents$ sed <span class="string">'/one/d'</span> file2</span><br><span class="line">two     2</span><br><span class="line">three   3</span><br><span class="line">âœ  Documents$ sed <span class="string">'s/one/111/g'</span> file2</span><br><span class="line">111     1</span><br><span class="line">two     2</span><br><span class="line">three   3</span><br><span class="line">1111    4</span><br><span class="line"><span class="comment">#å°†oneæ›¿æ¢æˆ111 å¹¶å°†å«æœ‰twoçš„è¡Œåˆ é™¤</span></span><br><span class="line">âœ  Documents$ sed -e <span class="string">'s/one/111/g'</span> -e <span class="string">'/two/d'</span> file2</span><br><span class="line">111     1</span><br><span class="line">three   3</span><br><span class="line">1111    4</span><br><span class="line"><span class="comment"># ()æ ‡è®°(è½¬ä¹‰), \1 å¼•ç”¨</span></span><br><span class="line">âœ  Documents$ sed <span class="string">'s/\([0-9]\)/\1.html/g'</span> file2</span><br><span class="line">one     1.html</span><br><span class="line">two     2.html</span><br><span class="line">three   3.html</span><br><span class="line">one1.html    4.html</span><br><span class="line"><span class="comment"># ä¸ä¸Šé¢ä¸€æ · &amp; æ ‡è®°åŒ¹é…çš„å­—ç¬¦</span></span><br><span class="line">âœ  Documents$ sed <span class="string">'s/[0-9]/&amp;.html/g'</span> file2</span><br><span class="line">one     1.html</span><br><span class="line">two     2.html</span><br><span class="line">three   3.html</span><br><span class="line">one1.html    4.html</span><br><span class="line">âœ  Documents$ cat mobile.csv</span><br><span class="line"><span class="string">"13090246026"</span></span><br><span class="line"><span class="string">"18020278026"</span></span><br><span class="line"><span class="string">"18520261021"</span></span><br><span class="line"><span class="string">"13110221022"</span></span><br><span class="line">âœ  Documents$ sed <span class="string">'s/\([0-9]\&#123;3\&#125;\)[0-9]\&#123;4\&#125;/\1xxxx/g'</span> mobile.csv</span><br><span class="line"><span class="string">"130xxxx6026"</span></span><br><span class="line"><span class="string">"180xxxx8026"</span></span><br><span class="line"><span class="string">"185xxxx1021"</span></span><br><span class="line"><span class="string">"131xxxx1022"</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h3><ul><li><p>åŸºæœ¬å‚æ•°å’Œè¯­æ³•</p><ul><li>NR è¡Œå·ï¼Œ NF åˆ—æ•°é‡</li><li><code>$1</code> ç¬¬1åˆ—ï¼Œ <code>$2, $3</code>â€¦</li><li>-F fs  fsåˆ†éš”ç¬¦ï¼Œå­—ç¬¦ä¸²æˆ–æ­£åˆ™</li><li>è¯­æ³•:  <code>awk &#39;BEGIN{ commands } pattern{ commands } END{ commands }&#39;</code>ï¼Œ æµç¨‹å¦‚ä¸‹:<ol><li>æ‰§è¡Œbegin</li><li>å¯¹è¾“å…¥æ¯ä¸€è¡Œæ‰§è¡Œ <code>pattern{ commands }</code>ï¼Œ pattern å¯ä»¥æ˜¯ æ­£åˆ™<code>/reg exp/</code>ï¼Œ å…³ç³»è¿ç®—ç­‰</li><li>å¤„ç†å®Œæ¯•ï¼Œ æ‰§è¡Œ end</li></ol></li></ul></li><li><p>ç¤ºä¾‹</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  Documents$ cat file5</span><br><span class="line">11  11 aa cc</span><br><span class="line">22  22 bb</span><br><span class="line">33  33 d</span><br><span class="line">11  11</span><br><span class="line">11  11</span><br><span class="line"><span class="comment">#è¡Œå·ï¼Œ åˆ—æ•°é‡ï¼Œ ç¬¬3åˆ—</span></span><br><span class="line">âœ  Documents$ awk <span class="string">'&#123;print NR"("NF"):"ï¼Œ $3&#125;'</span> file5</span><br><span class="line">1(4): aa</span><br><span class="line">2(3): bb</span><br><span class="line">3(3): d</span><br><span class="line">4(2):</span><br><span class="line">5(2):</span><br><span class="line"><span class="comment">#å­—ç¬¦ä¸²åˆ†å‰²ï¼Œ æ‰“å°1ï¼Œ2åˆ—</span></span><br><span class="line">âœ  Documents$ awk -F<span class="string">"xxxx"</span> <span class="string">'&#123;print $1ï¼Œ $2&#125;'</span> mobile.csv</span><br><span class="line"><span class="string">"130 6026"</span></span><br><span class="line"><span class="string">"180 8026"</span></span><br><span class="line"><span class="string">"185 1021"</span></span><br><span class="line"><span class="string">"131 1022"</span></span><br><span class="line"><span class="comment">#æ·»åŠ è¡¨è¾¾å¼</span></span><br><span class="line">âœ  Documents$ awk <span class="string">'$1&gt;=22 &#123;print NR":"ï¼Œ $3&#125;'</span> file5</span><br><span class="line">2: bb</span><br><span class="line">3: d</span><br><span class="line"><span class="comment">#ç´¯åŠ 1åˆ°36ï¼Œå¥‡æ•°ï¼Œå¶æ•°</span></span><br><span class="line">âœ  Documents$ seq 36 | awk <span class="string">'BEGIN&#123;sum=0; print "question:"&#125; &#123;print $1" +"; sum+=$1&#125; END&#123;print "="; print sum&#125;'</span> | xargs | sed <span class="string">'s/+ =/=/'</span></span><br><span class="line">question: 1 + 2 + 3 + 4 + 5 + 6 + 7 + 8 + 9 + 10 + 11 + 12 + 13 + 14 + 15 + 16 + 17 + 18 + 19 + 20 + 21 + 22 + 23 + 24 + 25 + 26 + 27 + 28 + 29 + 30 + 31 + 32 + 33 + 34 + 35 + 36 = 666</span><br><span class="line">âœ  Documents$ seq 36 | awk <span class="string">'BEGIN&#123;sum=0; print "question:"&#125; $1 % 2 ==1 &#123;print $1" +"; sum+=$1&#125; END&#123;print "="; print sum&#125;'</span> | xargs | sed <span class="string">'s/+ =/=/'</span></span><br><span class="line">question: 1 + 3 + 5 + 7 + 9 + 11 + 13 + 15 + 17 + 19 + 21 + 23 + 25 + 27 + 29 + 31 + 33 + 35 = 324</span><br><span class="line">âœ  Documents$ seq 36 | awk <span class="string">'BEGIN&#123;sum=0; print "question:"&#125; $1 % 2 !=1 &#123;print $1" +"; sum+=$1&#125; END&#123;print "="; print sum&#125;'</span> | xargs | sed <span class="string">'s/+ =/=/'</span></span><br><span class="line">question: 2 + 4 + 6 + 8 + 10 + 12 + 14 + 16 + 18 + 20 + 22 + 24 + 26 + 28 + 30 + 32 + 34 + 36 = 342</span><br></pre></td></tr></table></figure></li></ul><p>å…¶ä»–é«˜çº§è¯­æ³•ï¼š<code>for, while</code> ç­‰ï¼Œ å„ç§å‡½æ•°ç­‰ï¼Œæœ¬èº«<code>awk</code>æ˜¯ä¸€ä¸ªå¼ºå¤§çš„è¯­è¨€ï¼Œå¯ä»¥æŒæ¡ä¸€äº›åŸºæœ¬çš„ç”¨æ³•ã€‚</p><h2 id="å®é™…åº”ç”¨"><a href="#å®é™…åº”ç”¨" class="headerlink" title="å®é™…åº”ç”¨"></a>å®é™…åº”ç”¨</h2><h3 id="æ—¥å¿—ç»Ÿè®¡åˆ†æ"><a href="#æ—¥å¿—ç»Ÿè®¡åˆ†æ" class="headerlink" title="æ—¥å¿—ç»Ÿè®¡åˆ†æ"></a>æ—¥å¿—ç»Ÿè®¡åˆ†æ</h3><p>ä¾‹å¦‚æ‹¿åˆ°ä¸€ä¸ªnginxæ—¥å¿—æ–‡ä»¶ï¼Œå¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼Œæ¯”å¦‚çœ‹å“ªäº›è¯·æ±‚æ˜¯è€—æ—¶æœ€ä¹…çš„è¿›è€Œè¿›è¡Œä¼˜åŒ–ï¼Œæ¯”å¦‚çœ‹æ¯å°æ—¶çš„â€PVâ€æ•° ç­‰ç­‰ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  Documents$ head -n5 std.nginx.log</span><br><span class="line">106.38.187.225 - - [20/Feb/2017:03:31:01 +0800] www.tanglei.name <span class="string">"GET /baike/208344.html HTTP/1.0"</span> 301 486 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 1.1.4322) 360JK yunjiankong 975382"</span> <span class="string">"106.38.187.225, 106.38.187.225"</span> - 0.000</span><br><span class="line">106.38.187.225 - - [20/Feb/2017:03:31:02 +0800] www.tanglei.name <span class="string">"GET /baike/208344.html HTTP/1.0"</span> 301 486 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 1.1.4322) 360JK yunjiankong 975382"</span> <span class="string">"106.38.187.225, 106.38.187.225"</span> - 0.000</span><br><span class="line">10.130.64.143 - - [20/Feb/2017:03:31:02 +0800] stdbaike.bdp.cc <span class="string">"POST /baike/wp-cron.php?doing_wp_cron=1487532662.2058920860290527343750 HTTP/1.1"</span> 200 182 <span class="string">"-"</span> <span class="string">"WordPress/4.5.6; http://www.tanglei.name/baike"</span> <span class="string">"10.130.64.143"</span> 0.205 0.205</span><br><span class="line">10.130.64.143 - - [20/Feb/2017:03:31:02 +0800] www.tanglei.name <span class="string">"GET /external/api/login-status HTTP/1.0"</span> 200 478 <span class="string">"-"</span> <span class="string">"-"</span> <span class="string">"10.130.64.143"</span> 0.003 0.004</span><br><span class="line">10.130.64.143 - - [20/Feb/2017:03:31:02 +0800] www.tanglei.name <span class="string">"GET /content_util/authorcontents?count=5&amp;offset=0&amp;israndom=1&amp;author=9 HTTP/1.0"</span> 200 11972 <span class="string">"-"</span> <span class="string">"-"</span> <span class="string">"10.130.64.143"</span> 0.013 0.013</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯nginxçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼Œ ä¾‹å¦‚å¸Œæœ›æ‰¾åˆ°top 10 è¯·æ±‚çš„path:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">head -n 10000 std.nginx.log | awk <span class="string">'&#123;print $8 ", " $10&#125;'</span> | grep <span class="string">',404'</span> | sort | uniq -c | sort -nr -k1 | head -n 10</span><br><span class="line"><span class="comment">#or</span></span><br><span class="line">head -n 10000 std.nginx.log | awk <span class="string">'$10==404 &#123;print $8&#125;'</span> |sort | uniq -c | sort -nr -k1 | head -n 10</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œä½ å¯èƒ½ä¸€æ¬¡ä¸ä¼šç›´æ¥å¤„ç†æˆåŠŸï¼Œä¸€èˆ¬ä¼šå…ˆå°‘æ‹¿ä¸€éƒ¨åˆ†æ•°æ®è¿›è¡Œå¤„ç†çœ‹é€»è¾‘æ˜¯å¦æ­£å¸¸ï¼Œ æˆ–è€…ä½ å¯ä»¥ç¼“å­˜ä¸€äº›ä¸­é—´ç»“æœ. </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat std.nginx.log | awk <span class="string">'&#123;print $8 "," $10&#125;'</span> | grep <span class="string">',404'</span> &gt;404.log</span><br><span class="line">sort 404.log | uniq -c | sort -nr -k1 | head -n 10</span><br></pre></td></tr></table></figure><p>å†æ¯”å¦‚æ¯å°æ—¶è¯·æ±‚æ•°é‡ï¼Œè¯·æ±‚è€—æ—¶ç­‰ç­‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  Documents$ head -n 100000 std.nginx.log | awk -F: <span class="string">'&#123;print $1 $2&#125;'</span> | cut -f3 -d/ | uniq -c</span><br><span class="line">8237 201703</span><br><span class="line">15051 201704</span><br><span class="line">16083 201705</span><br><span class="line">18561 201706</span><br><span class="line">22723 201707</span><br><span class="line">19345 201708</span><br></pre></td></tr></table></figure><p>å…¶ä»–å®é™…æ¡ˆä¾‹ ip block</p><h3 id="æ¡ˆä¾‹-dbæ•°æ®è®¢æ­£"><a href="#æ¡ˆä¾‹-dbæ•°æ®è®¢æ­£" class="headerlink" title="æ¡ˆä¾‹: dbæ•°æ®è®¢æ­£"></a>æ¡ˆä¾‹: dbæ•°æ®è®¢æ­£</h3><p>èƒŒæ™¯: å› ä¸ºæŸæœåŠ¡bugï¼Œå¯¼è‡´æ’å…¥åˆ°dbçš„å›¾ç‰‡è·¯å¾„ä¸å¯¹ï¼Œéœ€è¦å°†å½¢å¦‚(å®‰å…¨éœ€è¦å·²ç»å°†æ•æ„Ÿæ•°æ®æ›¿æ¢)<br><code>https://www.tanglei.name/upload/photos/129630//internal-public/shangtongdai/2017-02-19-abcdefg-eb85-4c24-883e-hijklmn.jpg</code><br>æ›¿æ¢æˆ<br><code>http://www.tanglei.me/internal-public/shangtongdai/2017-02-19-abcdefg-eb85-4c24-883e-hijklmn.jpg</code>ï¼Œå› ä¸ºmysqlç­‰dbè²Œä¼¼ä¸æ”¯æŒç›´æ¥æ­£åˆ™çš„æ›¿æ¢ï¼Œæ‰€ä»¥ä¸èƒ½å¤Ÿå¾ˆæ–¹ä¾¿çš„è¿›è¡Œå†™sqlè¿›è¡Œæ›¿æ¢ï¼ˆå°±ç®—æ”¯æŒï¼Œç›´æ¥æ”¹ä¹Ÿæœ‰é£é™©çš„ï¼Œè¿˜æ˜¯å…ˆå¤‡ä»½å†ä¿®æ”¹ç•™ä¸ªâ€œåæ‚”è¯â€ï¼‰ã€‚</p><p>å½“ç„¶å°†æ•°æ®å¯¼å‡ºï¼Œç„¶åå†™ python ç­‰è„šæœ¬å¤„ç†ä¹Ÿæ˜¯ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œä½†å¦‚æœç”¨ä¸Šé¢çš„å‘½ä»¤è¡Œå¤„ç†ï¼Œåªéœ€è¦å‡ åç§’å³å¯å®Œæˆã€‚</p><p>æ­¥éª¤:</p><ol><li><p>å‡†å¤‡æ•°æ®</p> <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, photo_url_1, photo_url_2, photo_url_3 <span class="keyword">from</span> somedb.sometable <span class="keyword">where</span> </span><br><span class="line">photo_url_1 <span class="keyword">like</span> <span class="string">'https://www.tanglei.name/upload/photos/%//internal-public/%'</span> <span class="keyword">or</span></span><br><span class="line">photo_url_2 <span class="keyword">like</span> <span class="string">'https://www.tanglei.name/upload/photos/%//internal-public/%'</span> <span class="keyword">or</span></span><br><span class="line">photo_url_3 <span class="keyword">like</span> <span class="string">'https://www.tanglei.name/upload/photos/%//internal-public/%'</span>;</span><br></pre></td></tr></table></figure></li><li><p>æ›¿æ¢åŸæ–‡ä»¶<br> ä¸€èˆ¬åœ¨ç”¨sedæ›¿æ¢çš„æ—¶å€™ï¼Œå…ˆæµ‹è¯•ä¸€ä¸‹æ˜¯å¦æ­£å¸¸æ›¿æ¢ã€‚ </p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æµ‹è¯•æ˜¯å¦OK</span></span><br><span class="line">head -n 5 customers.csv | sed <span class="string">'s|https://www.tanglei.name/upload/photos/[0-9]\&#123;1,\&#125;/|http://www.tanglei.me|g'</span></span><br><span class="line"><span class="comment"># ç›´æ¥æ›¿æ¢åŸæ–‡ä»¶ï¼Œ å¯ä»¥sed -i ".bak" æ›¿æ¢æ—¶ä¿ç•™åŸå§‹å¤‡ä»½æ–‡ä»¶</span></span><br><span class="line">sed -i <span class="string">""</span> <span class="string">'s|https://www.tanglei.name/upload/photos/[0-9]\&#123;1,\&#125;/|http://www.tanglei.me|g'</span> customers.csv</span><br></pre></td></tr></table></figure></li><li><p>æ‹¼æ¥sqlï¼Œ ç„¶åæ‰§è¡Œ</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk -Fï¼Œ <span class="string">'&#123;print "update sometable set photo_url_1 = " $2, ", photo_url_2 = " $3, ", photo_url_3 = " $4, " where id = " $1 ";" &#125;'</span> customers.csv &gt; customer.sql</span><br><span class="line"><span class="comment">#ç„¶åæ‰§è¡Œsql å³å¯</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><ul><li><p>play framework session</p><ul><li><p>è€æ–¹å¼: éœ€è¦å¯playç¯å¢ƒï¼Œ æ…¢</p><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">sbt <span class="string">"project site"</span> consoleQuick</span><br><span class="line"><span class="keyword">import</span> play.api.libs._</span><br><span class="line"><span class="keyword">val</span> sec = <span class="string">"secret...secret"</span></span><br><span class="line"><span class="keyword">var</span> uid = <span class="string">"10086"</span></span><br><span class="line"><span class="type">Crypto</span>.sign(<span class="string">s"uid=<span class="subst">$uid</span>"</span>ï¼Œ sec.getBytes(<span class="string">"UTF-8"</span>)) + <span class="string">s"-uid=<span class="subst">$uid</span>"</span></span><br></pre></td></tr></table></figure></li><li><p>æ–°æ–¹å¼: </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  Documents$  ~/stdcookie.sh 97522</span><br><span class="line">918xxxxdf64abcfcxxxxc465xx7554dxxxx21e-uid=97522</span><br><span class="line">âœ  Documents$ cat ~/stdcookie.sh</span><br><span class="line"><span class="comment">#!/bin/bash ##  cannot remove this line</span></span><br><span class="line">uid=<span class="variable">$1</span></span><br><span class="line"><span class="built_in">hash</span>=`<span class="built_in">echo</span> -n <span class="string">"uid=<span class="variable">$uid</span>"</span> | openssl dgst -sha1 -hmac <span class="string">"secret...secret"</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$hash</span>-uid=<span class="variable">$uid</span>"</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>ç»Ÿè®¡æ–‡ç« å•è¯é¢‘ç‡: ä¸‹é¢æ¡ˆä¾‹ç»Ÿè®¡äº†å·æ™®å°±èŒæ¼”è®²åŸæ–‡ä¸­è¯é¢‘æœ€é«˜çš„10ä¸ªè¯ã€‚</p>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  Documents$ head -n3 chuanpu.txt</span><br><span class="line">Chief Justice Robertsï¼Œ President Carterï¼Œ President Clintonï¼Œ President Bushï¼Œ President Obamaï¼Œ fellow Americans and people of the worldï¼Œ thank you.</span><br><span class="line"></span><br><span class="line">Weï¼Œ the citizens of Americaï¼Œ are now joined <span class="keyword">in</span> a great national effort to rebuild our country and restore its promise <span class="keyword">for</span> all of our people. Together we will determine the course of America and the world <span class="keyword">for</span> manyï¼Œ many years to come.</span><br><span class="line">âœ  Documents$ cat chuanpu.txt | tr -dc <span class="string">'a-zA-Z '</span> | xargs -n 1 | sort | uniq -c | sort -nr -k1 | head -n 20</span><br><span class="line">  65 the</span><br><span class="line">  63 and</span><br><span class="line">  48 of</span><br><span class="line">  46 our</span><br><span class="line">  42 will</span><br><span class="line">  37 to</span><br><span class="line">  21 We</span><br><span class="line">  20 is</span><br><span class="line">  18 we</span><br><span class="line">  17 America</span><br><span class="line">  15 a</span><br><span class="line">  14 all</span><br><span class="line">  13 <span class="keyword">in</span></span><br><span class="line">  13 <span class="keyword">for</span></span><br><span class="line">  13 be</span><br><span class="line">  13 are</span><br><span class="line">  10 your</span><br><span class="line">  10 not</span><br><span class="line">  10 And</span><br><span class="line">  10 American</span><br></pre></td></tr></table></figure></li><li><p>éšæœºæ•°ï¼šæ¯”å¦‚å¸¸å¸¸æ–°æ³¨å†Œä¸€ä¸ªç½‘ç«™ï¼Œéšæœºç”Ÿæˆä¸€ä¸ªå¯†ç ä¹‹ç±»çš„ã€‚  </p>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  Documents$ cat /dev/urandom | LC_CTYPE=C tr -dc <span class="string">'a-zA-Z0-9'</span> | fold -w 32 | head -n 5</span><br><span class="line">cpBnvC0niwTybSSJhUUiZwIz6ykJxBvu</span><br><span class="line">VDP56NlHnugAt2yDySAB9HU2Nd0LlYCW</span><br><span class="line">0WEDzpjPop32T5STvR6K6SfZMyT6KvAI</span><br><span class="line">a9xBwBat7tJVaad279fOPdA9fEuDEqUd</span><br><span class="line">hTLrOiTH5FNP2nU3uflsjPUXJmfleI5c</span><br><span class="line">âœ  Documents$ cat /dev/urandom | head -c32 | base64</span><br><span class="line">WoCqUye9mSXI/WhHODHDjzLaSb09xrOtbrJagG7Kfqc=</span><br></pre></td></tr></table></figure></li><li><p>å›¾ç‰‡å¤„ç†å‹ç¼©ï¼Œå¯æ‰¹é‡æ”¹å›¾ç‰‡å¤§å°ç­‰ç­‰ <code>sips</code></p>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  linux-shell-more-effiency$ sips -g all <span class="built_in">which</span>-whereis.png</span><br><span class="line">/Users/tanglei/Documents/linux-shell-more-effiency/<span class="built_in">which</span>-whereis.png</span><br><span class="line">  pixelWidth: 280</span><br><span class="line">  pixelHeight: 81</span><br><span class="line">  typeIdentifier: public.png</span><br><span class="line">  format: png</span><br><span class="line">  formatOptions: default</span><br><span class="line">  dpiWidth: 72.000</span><br><span class="line">  dpiHeight: 72.000</span><br><span class="line">  samplesPerPixel: 4</span><br><span class="line">  bitsPerSample: 8</span><br><span class="line">  hasAlpha: yes</span><br><span class="line">  space: RGB</span><br><span class="line">  profile: DELL U2412M</span><br><span class="line">âœ  linux-shell-more-effiency$ sips -Z 250 <span class="built_in">which</span>-whereis.png</span><br><span class="line">/Users/tanglei/Documents/linux-shell-more-effiency/<span class="built_in">which</span>-whereis.png</span><br><span class="line">  /Users/tanglei/Documents/linux-shell-more-effiency/<span class="built_in">which</span>-whereis.png</span><br><span class="line">âœ  linux-shell-more-effiency$ sips -g all <span class="built_in">which</span>-whereis.png</span><br><span class="line">/Users/tanglei/Documents/linux-shell-more-effiency/<span class="built_in">which</span>-whereis.png</span><br><span class="line">  pixelWidth: 250</span><br><span class="line">  pixelHeight: 72</span><br><span class="line">  typeIdentifier: public.png</span><br><span class="line">  format: png</span><br><span class="line">  formatOptions: default</span><br><span class="line">  dpiWidth: 72.000</span><br><span class="line">  dpiHeight: 72.000</span><br><span class="line">  samplesPerPixel: 4</span><br><span class="line">  bitsPerSample: 8</span><br><span class="line">  hasAlpha: yes</span><br><span class="line">  space: RGB</span><br><span class="line">  profile: DELL U2412M</span><br><span class="line">âœ  linux-shell-more-effiency$ sips -z 100 30 <span class="built_in">which</span>-whereis.png</span><br><span class="line">/Users/tanglei/Documents/linux-shell-more-effiency/<span class="built_in">which</span>-whereis.png</span><br><span class="line">  /Users/tanglei/Documents/linux-shell-more-effiency/<span class="built_in">which</span>-whereis.png</span><br><span class="line">âœ  linux-shell-more-effiency$ sips -g pixelWidth -g pixelHeight <span class="built_in">which</span>-whereis.png</span><br><span class="line">/Users/tanglei/Documents/linux-shell-more-effiency/<span class="built_in">which</span>-whereis.png</span><br><span class="line">  pixelWidth: 30</span><br><span class="line">  pixelHeight: 100</span><br></pre></td></tr></table></figure></li><li><p>å‘½ä»¤è¡Œå¤„ç† JSON çš„ç¥å™¨ï¼šéšç€ JSON é€šç”¨æ€§ï¼Œå¸¸å¸¸éœ€è¦å¤„ç† JSON æ•°æ®ï¼Œè¿™é‡Œæ¨èè¿™ä¸ªå‘½ä»¤è¡Œ JSON å¤„ç†ç¥å™¨<a href="https://stedolan.github.io/jq/" title="jq is a lightweight and flexible command-line JSON processor" target="_blank" rel="noopener">jq is a lightweight and flexible command-line JSON processor</a></p></li><li>å…¶ä»–è¿˜æœ‰ä¸€ä¸ªç»¼åˆåº”ç”¨å¯å‚è€ƒï¼š<a href="https://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247488114&amp;idx=1&amp;sn=b6191483135ecd7f7c0b735bc2dbe7a7&amp;chksm=eb471396dc309a80ba8df35f9e04ab585a80cb3f9e485fdf4c9afd380200c2d109b28335a00b&amp;token=242044315&amp;lang=zh_CN#rd" target="_blank" rel="noopener">æ²¡æƒ³åˆ° Shell å‘½ä»¤ç«Ÿç„¶è¿˜èƒ½è¿™ä¹ˆç©ï¼Ÿ| Shell ç©è½¬å¤§æ•°æ®åˆ†æ</a></li></ul><p>æ¨èä»¥ä¸‹å‚è€ƒææ–™ï¼š</p><ul><li>[1] JSON processor: <a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener">https://stedolan.github.io/jq/</a></li><li>[2] Linuxå·¥å…·å¿«é€Ÿæ•™ç¨‹: <a href="http://linuxtools-rst.readthedocs.io/zh_CN/latest/index.html" target="_blank" rel="noopener">http://linuxtools-rst.readthedocs.io/zh_CN/latest/index.html</a></li><li>[3] Linuxå‘½ä»¤å¤§å…¨: <a href="http://man.linuxde.net/" target="_blank" rel="noopener">http://man.linuxde.net/</a></li><li>[4] Advanced Bash-Scripting Guide: <a href="http://tldp.org/LDP/abs/html/" target="_blank" rel="noopener">http://tldp.org/LDP/abs/html/</a></li><li>[5] UNIXç¯å¢ƒé«˜çº§ç¼–ç¨‹: <a href="https://book.douban.com/subject/25900403" target="_blank" rel="noopener">https://book.douban.com/subject/25900403</a></li></ul><p>â€‹é€å‡ æœ¬æˆ‘ä»¬éƒ¨é—¨å‡ºçš„æ–°ä¹¦ï¼Œå…è´¹åŒ…é‚®åˆ°å®¶ï¼Œæ¬¢è¿å¤§å®¶æ¥æŠ½å¥–ï¼ˆä¸¤ç§æŠ½å¥–æ–¹å¼ï¼Œè¯¦æƒ…è§ä¸‹æ–‡ï¼‰ï¼Œä¹Ÿå¸®å¿™reviewä¸‹æŠ½å¥–çš„ä»£ç ã€‚</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247488892&amp;idx=1&amp;sn=1b026c5a8688b880ca06c51c816265b1&amp;chksm=eb471498dc309d8eaac5bd296a3971901e624e9abfc5a0add8928f5ebc3a83b8402ebfadd95d&amp;scene=21&amp;token=1758347384&amp;lang=zh_CN#wechat_redirect" target="_blank" rel="noopener">å…³äº AI çš„æ•°ç™¾ä¸ªé—®é¢˜ï¼Œæ¸…åç”·ç¥åˆ˜äº‘æµ©æ•™æˆçš„ 3 ä¸‡å­—å›å¤ç»™æ•´å¾—æ˜æ˜ç™½ç™½|é™„æŠ½å¥–é€ä¹¦</a></p><p>ä¸Šæ–‡æ˜¯ä¸€ä¸ªè¶…çº§å¤§ç‰›å…³äºAIçš„ç›¸å…³é—®é¢˜è§£ç­”ï¼ŒæŠ½å¥–æ´»åŠ¨åœ¨æ–‡æœ«ã€‚ç›´æ¥å…¬ä¼—å·åå°å›å¤â€œæŠ½å¥–â€ ä¹Ÿæ˜¯å…¶ä¸­ä¸€ç§æŠ½å¥–æ–¹å¼å“¦ã€‚ </p><p>è§‰å¾—æœ¬å·åˆ†äº«çš„æ–‡ç« æœ‰ä»·å€¼ï¼Œè®°å¾—æ·»åŠ æ˜Ÿæ ‡å“¦ã€‚å‘¨æ›´å¾ˆç´¯ï¼Œä¸è¦ç™½ piaoï¼Œéœ€è¦æ¥ç‚¹æ­£åé¦ˆï¼Œå®‰æ’ä¸ª â€œä¸€é”®ä¸‰è¿â€ï¼ˆç‚¹èµã€åœ¨çœ‹ã€åˆ†äº«ï¼‰å¦‚ä½•ï¼ŸğŸ˜ è¿™å°†æ˜¯æˆ‘æŒç»­è¾“å‡ºä¼˜è´¨æ–‡ç« çš„æœ€å¼ºåŠ¨åŠ›ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;å…³äºä½œè€…ï¼šç¨‹åºçŒ¿çŸ³å¤´(ID: tangleithu)ï¼Œç°ä»»é˜¿é‡Œå·´å·´æŠ€æœ¯ä¸“å®¶ï¼Œæ¸…åå­¦æ¸£ï¼Œå‰å¤§ç–†åç«¯ Leaderã€‚ä»¥æ¯ç¯‡æ–‡ç« éƒ½è®©äººæœ‰æ”¶è·ä¸ºç›®çš„ï¼Œæ¬¢è¿å…³æ³¨ï¼Œäº¤æµå’ŒæŒ‡å¯¼ï¼æ–‡ç« é¦–å‘äºå¾®ä¿¡å…¬ä¼—å·ï¼Œæ¬¢è¿å…³æ³¨ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¯»è€…ç¦åˆ©
      
    
    </summary>
    
      <category term="ç»éªŒæŠ€å·§" scheme="https://www.tanglei.name/categories/%E7%BB%8F%E9%AA%8C%E6%8A%80%E5%B7%A7/"/>
    
    
      <category term="Shell" scheme="https://www.tanglei.name/tags/Shell/"/>
    
      <category term="Mac" scheme="https://www.tanglei.name/tags/Mac/"/>
    
      <category term="MyLife" scheme="https://www.tanglei.name/tags/MyLife/"/>
    
  </entry>
  
  <entry>
    <title>10 å¹´ bloger å‘Šè¯‰ä½ è¦ä¸è¦å†™åšå®¢ï¼Œåˆè¯¥å¦‚ä½•ä¼˜é›…åœ°å†™åšå®¢ï¼Ÿ</title>
    <link href="https://www.tanglei.name/blog/how-to-blog-elegantly-as-a-software-engineer.html"/>
    <id>https://www.tanglei.name/blog/how-to-blog-elegantly-as-a-software-engineer.html</id>
    <published>2020-08-23T00:00:00.000Z</published>
    <updated>2020-10-11T15:25:42.107Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å…³äºä½œè€…ï¼šç¨‹åºçŒ¿çŸ³å¤´(ID: tangleithu)ï¼Œç°ä»»é˜¿é‡Œå·´å·´æŠ€æœ¯ä¸“å®¶ï¼Œæ¸…åå­¦æ¸£ï¼Œå‰å¤§ç–†åç«¯ Leaderã€‚ç”¨ä¸åŒçš„è§†è§’åˆ†äº«é«˜è´¨é‡æŠ€æœ¯æ–‡ç« ï¼Œä»¥æ¯ç¯‡æ–‡ç« éƒ½è®©äººæœ‰æ”¶è·ä¸ºç›®çš„ï¼Œæ¬¢è¿å…³æ³¨ï¼Œäº¤æµå’ŒæŒ‡å¯¼ï¼å…¬ä¼—å·åå°å›å¤å…³é”®å­— â€œ1024â€ è·å–ç¨‹åºå‘˜å¤§å‚é¢è¯•æŒ‡å—ã€‚</p></blockquote><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>çŸ³å¤´å¤§çº¦åœ¨ 2010 å¹´å·¦å³æœ‰äº†è‡ªå·±çš„ç¬¬ä¸€ä¸ªåŸŸåï¼Œä¹Ÿæ˜¯ä»é‚£ä¸ªæ—¶å€™å¼€å§‹å†™åšå®¢çš„ã€‚è‡³ä»Šç¡®å®æœ‰ 10 å¹´æ—¶é—´äº†ã€‚</p><p>æœ€åˆç© blogï¼Œå…¶å®æ›´å¤šçš„è¿˜æ˜¯æŠ±ç€å­¦ä¹ çš„æ€åº¦ã€‚æ¯”å¦‚åˆšå­¦ä¹ å®Œäº† DNS è§£æï¼ŒHTML è¯­æ³•ï¼Œä¸ â€œå®æˆ˜â€ä¸€æŠŠä¹ˆï¼Ÿåç»­é™†é™†ç»­ç»­æŠŠè¯»ä¹¦ç¬”è®°ã€è¯¾ç¨‹æ€»ç»“éƒ½å¾€åšå®¢ä¸Šæ”¾ã€‚</p><p>ä¸ºä»€ä¹ˆè¦å†™ blogï¼ŒçŸ³å¤´è§‰å¾—æœ‰å¦‚ä¸‹å‡ ä¸ªå¥½å¤„ï¼š</p><ul><li>å¯ä»¥æŠŠå®ƒä½œä¸ºæ•´ç†å­¦ä¹ ç¬”è®°çš„åœ°æ–¹ï¼Œæ–¹ä¾¿æ²‰æ·€å­¦ä¹ ï¼Œå°±è·Ÿå½“åˆæˆ‘å¼€å§‹ç©ä¸€æ ·ã€‚æ›´å¤šçš„æ˜¯å†™ç»™è‡ªå·±çœ‹ï¼Œç©ç©â€œå»ºç«™â€æµç¨‹ï¼ˆç‹¬ç«‹åšå®¢ï¼‰ï¼Œä¹Ÿç®—ä¸€ä¸ªå°æŠ€èƒ½ã€‚ï¼ˆå…¶å®è¦ä¸è¦å†™åšå®¢çœ‹ä¸ªäººå…´è¶£ï¼Œ<strong>ä½†å­¦ä¼šæ€»ç»“æ²‰æ·€æ˜¯å¿…é¡»çš„</strong>ï¼‰</li><li>â€œæˆå°±è‡ªå·±ã€å¸®åŠ©ä»–äººâ€ã€‚ åœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œä½ è‚¯å®šä¹Ÿæœ‰é€šè¿‡åˆ«äººçš„åšå®¢è§£å†³äº†ä½ çš„æŸä¸ªé—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™â€œåå“ºâ€ä¸€ä¸‹å¼€æ”¾çš„äº’è”ç½‘ä¹Ÿä½•å°ä¸æ˜¯ä¸€ä»¶å¿«äº‹ã€‚å½“æœ‰äººé€šè¿‡æœç´¢å¼•æ“æ£€ç´¢åˆ°ä½ çš„å†…å®¹å¹¶ç•™è¨€è¯´æ„Ÿè°¢å¸®åŠ©ä»–è§£å†³ä¸€ä¸ªç±»ä¼¼é—®é¢˜çš„æ—¶å€™ï¼Œè¿˜æ˜¯æœ‰ä¸€ä¸ä¸æˆå°±æ„Ÿçš„ã€‚</li><li>é”»ç‚¼å†™ä½œèƒ½åŠ›ã€‚ä¸€ä¸ªé—®é¢˜è‡ªå·±æ‡‚å’ŒæŠŠå®ƒè®²ç»™åˆ«äººæ‡‚ï¼Œæ˜¯ä¸¤ä¸ªå®Œå…¨ä¸ä¸€æ ·çš„æ¦‚å¿µã€‚</li><li>æ‰“é€ ä¸ªäºº IPã€‚ä¾‹å¦‚è‘—åçš„ coolshellï¼Œruanyifeng ç­‰ï¼Œå¤§éƒ¨åˆ†äººåº”è¯¥éƒ½çŸ¥é“å§ï¼Ÿ</li><li>èµšé’±ã€‚è¿™ä¸ªå°±ä¸ç”¨å¤šè¯´äº†ã€‚è¯´å‡ºæ¥ï¼Œä½ å¯èƒ½ä¸ä¿¡ï¼Œå°±è¿æˆ‘ 10 å¹´å‰æ²¡å•¥å†…å®¹çš„ blogï¼Œå½“åˆä¹Ÿæœ‰æ˜¯æœ‰â€œå¤–å¿«â€èµšçš„ï¼šè®°å¾—å½“åˆæ˜¯ç»™â€œå‹é“¾â€çš„æ–¹å¼å¯¼æµï¼Œ1 ä¸ªæœˆ 5~10 å—ï¼Œåˆšå¥½èƒ½è¦†ç›–åŸŸåã€è™šæ‹Ÿä¸»æœºçš„è´¹ç”¨ï¼Œä¸è¿‡åæ¥å„ç§åšå®¢æ¬å®¶ï¼Œä¹Ÿæ‡’å¾—æŠ˜è…¾äº†ã€‚</li><li>â€¦ </li></ul><p>é€šè¿‡è¿™ 10 å¹´çš„æ‘¸ç´¢ï¼ŒçŸ³å¤´ä¹Ÿå°è¯•è¿‡å¤šç§å†™ blog çš„æ–¹æ³•ã€‚ä¸è¿‡è¯´æ¥æƒ­æ„§ï¼Œè²Œä¼¼ä¹Ÿæ²¡ä»€ä¹ˆè¯´å¾—å‡ºçš„æˆç»©ã€‚</p><p>ç›®å‰ä¹Ÿç§¯ç´¯äº†æœ‰ 400+ç¯‡æ–‡ç« ï¼Œä¸è¿‡æ„Ÿè§‰çœŸæ­£æœ‰è´¨é‡çš„æ–‡ç« ä¹Ÿå°±å‡ åæ¥ç¯‡ã€‚æŠ˜è…¾è¿‡å¾ˆå¤š blog ç¨‹åºï¼Œé™†é™†ç»­ç»­è¿ç§»äº†å¥½å‡ ä¸ªç‰ˆæœ¬ï¼Œå†å²æ–‡ç« ä¹Ÿâ€èˆä¸å¾—â€ä¸¢å¼ƒï¼Œä¹Ÿä¸€ç›´ä¿ç•™ã€‚å…¶å®å¥½å¤šæ–‡ç« åœ¨æˆ‘ç°åœ¨çœ‹æ¥å¥½åƒä»·å€¼ä¸å¤§ï¼Œä½†æ‰”èˆä¸å¾—æŠ›å¼ƒï¼Œæ¯•ç«Ÿå½“åˆè¾›è¾›è‹¦è‹¦ po å‡ºæ¥çš„ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é€šè¿‡ â€œ<a href="http://www.tanglei.nameâ€" target="_blank" rel="noopener">www.tanglei.nameâ€</a> è¿™ä¸ªç½‘å€è¿›è¡Œè®¿é—®ã€‚</p><p><img src="http://www.tanglei.name/resources/how-to-blog-elegantly-as-a-software-engineer/image-20200823151456726.png" alt></p><p>ä¸‹é¢ä»¥æˆ‘çš„åšå®¢æ¼”è¿›ä¹‹è·¯ä¸ºä¾‹ï¼Œç»™å¤§å®¶ä»‹ç»ä¸‹å¸¸è§çš„åšå®¢ç©æ³•ï¼Œä¾›å¤§å®¶å‚è€ƒã€‚</p><h2 id="æˆ‘çš„åšå®¢ä¹‹è·¯"><a href="#æˆ‘çš„åšå®¢ä¹‹è·¯" class="headerlink" title="æˆ‘çš„åšå®¢ä¹‹è·¯"></a>æˆ‘çš„åšå®¢ä¹‹è·¯</h2><h3 id="çº¯-wordpress"><a href="#çº¯-wordpress" class="headerlink" title="çº¯ wordpress"></a>çº¯ wordpress</h3><p>wordpress ä¸åšå¤šä»‹ç»ï¼Œæ˜¯ä¸€å¥—ç”¨ php å¼€å‘çš„ CMSï¼Œå¾ˆå¤šäººçš„åšå®¢éƒ½ç”¨è¿™ä¸ªã€‚</p><p>ä¸‹å›¾æ˜¯æˆ‘åšå®¢æœ€åˆçº§çš„ç‰ˆæœ¬ï¼Œåœ¨ç›¸å½“é•¿ä¸€æ®µæ—¶é—´å†…ä¹Ÿä¸€ç›´ç”¨è¿™ä¸ªä¸»é¢˜ã€‚</p><p><img src="/resources/how-to-blog-elegantly-as-a-software-engineer/wordpress.tanglei.name.jpg" alt="Wordpress åšå®¢"></p><p>â€œæ—¶å…‰èè‹’ã€å²æœˆå¦‚æ¢­â€ï¼Œä¸Šé¢çš„æˆªå›¾ä¹Ÿå¾ˆæœ‰æ„æ€â€”â€”</p><ul><li><p>å³ä¸Šè§’çš„åŠ¨æ€â€œè…¾è®¯å¾®åšâ€ï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰ç”¨è¿‡ï¼Ÿ</p></li><li><p>å·¦ä¸Šè§’çš„ Rss è®¢é˜…ï¼Œç°åœ¨ä¸çŸ¥é“æ˜¯å¦è¿˜æœ‰äººç”¨ï¼Œç”¨çš„äººå¤šå—ï¼Ÿåæ­£æˆ‘å¥½ä¹…æ²¡æ‰“å¼€æˆ‘çš„è®¢é˜…æ–‡ç« äº†ã€‚</p></li></ul><p>ç”¨ Wordpress å†™åšå®¢ï¼Œæœ‰ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯ï¼Œæ¯æ¬¡å†™éœ€è¦ç™»å½•åå°ï¼Œæ’ç‰ˆã€é…å›¾ç­‰æ¯”è¾ƒéº»çƒ¦ã€‚å¹¶ä¸”è¿˜å¾—æé’±ä¹°è™šæ‹Ÿä¸»æœºã€è‡ªå·±è¿è¥ç»´æŠ¤ wordpress ç¨‹åºã€MySQL ç­‰ã€‚</p><p>å†åæ¥æ¥è§¦åˆ° <code>markdown</code> è¿™ä¸ªæ ‡è®°è¨€ï¼Œæ‰å‘ç°è¿™ç©æ„å¤ªå¥½ç”¨äº†ï¼Œå°±ä¸€å‘ä¸å¯æ”¶æ‹¾ã€‚ä¸€ç›´ç”¨ markdown å†™ä½œæ²¿ç”¨è‡³ä»Šã€‚</p><h3 id="wordpress-markdown-æ’ä»¶"><a href="#wordpress-markdown-æ’ä»¶" class="headerlink" title="wordpress + markdown æ’ä»¶"></a>wordpress + markdown æ’ä»¶</h3><p>åšå®¢ä¸»é¢˜æƒ³ä¿ç•™å°±ä¸€ç›´è¿˜æ˜¯ç”¨ wordpressï¼Œä½†æœ‰å¸Œæœ›å†™ä½œç”¨ markdownã€‚</p><p>ç”±äºæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ wordpress çš„ markdown æ’ä»¶ï¼Œäºæ˜¯å°±è‡ªå·±å†™äº†ä¸€ä¸ª <a href="https://github.com/tl3shi/markdown2wordpress" target="_blank" rel="noopener">markdown2wordpress</a>ã€‚åç«¯æ¡†æ¶ç­‰ä»ç„¶ç”¨ wordpressï¼Œç¹ççš„æ’ç‰ˆç­‰é—®é¢˜å°±ç›´æ¥äº¤ç»™ markdownï¼Œä¹Ÿä¸ç”¨ç™»é™† wordpress åå°è¿›è¡Œè°ƒæ•´ç­‰æ“ä½œã€‚</p><p>è¿™ä¸ªå·¥å…·ä¾èµ–äº python-wordpress-xmlrpcï¼Œä¸€ä¸ª python å®ç°çš„ wordpress çš„å®¢æˆ·ç«¯ï¼Œå¯ä»¥æ–¹ä¾¿è°ƒç”¨ wordpress æä¾›çš„æ¥å£ï¼Œmarkdown çš„æ¸²æŸ“ä¾èµ–äº pandocï¼Œä»£ç é«˜äº®ç”¨çš„æ˜¯ <code>highlight.js</code><br>å›¾ç‰‡ç”¨å›¾åºŠçš„å½¢å¼ï¼Œæˆ–è€…ç›´æ¥ä»¥ github å¤–é“¾çš„å½¢å¼ã€‚</p><p>ç”¨è¿™ä¸ªå·¥å…·åˆåšæŒäº†ä¸€æ®µæ—¶é—´ã€‚</p><p>ä½†çŸ³å¤´å½“åˆä¹°çš„è™šæ‹Ÿä¸»æœºï¼ˆå…±äº«å‹ï¼‰è¿˜æ˜¯å¤šä¸ªäººå…¬ç”¨çš„å½¢å¼ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œç½‘ç«™å°±ç»å¸¸æŒ‚ï¼Œä¸€ä¼šè™šæ‹ŸæœºæŒ‚äº†ï¼Œä¸€ä¼šMySQLåˆæŒ‚äº†ï¼Œç„¶åè¿˜ä¸­è¿‡æœ¨é©¬ã€‚å®åœ¨æ˜¯å¿å—ä¸äº†äº†ã€‚</p><h3 id="github-page-æœåŠ¡"><a href="#github-page-æœåŠ¡" class="headerlink" title="github page æœåŠ¡"></a>github page æœåŠ¡</h3><p>github page æœåŠ¡ <a href="https://pages.github.com/ï¼ŒæŒ‰ç…§å®˜ç½‘è¯´çš„é‚£æ ·ï¼Œç›´æ¥å°†æºæ–‡ä»¶æ‰˜ç®¡åœ¨" target="_blank" rel="noopener">https://pages.github.com/ï¼ŒæŒ‰ç…§å®˜ç½‘è¯´çš„é‚£æ ·ï¼Œç›´æ¥å°†æºæ–‡ä»¶æ‰˜ç®¡åœ¨</a> Github ä¸Šï¼Œä»…ä»…éœ€è¦ç¼–è¾‘ã€pushå³å¯ï¼Œç„¶åå˜åŒ–é©¬ä¸Šå°±èƒ½ä½“ç°äº†ã€‚ </p><p><img src="/resources/how-to-blog-elegantly-as-a-software-engineer/github-pages.png" alt="image-20200823183039944"></p><p>è¿™æ ·ä¸ä½†çœå»äº†è™šæ‹Ÿä¸»æœºã€MySQL ç­‰è´¹ç”¨ï¼ŒåŒæ—¶ github page è¿˜æ”¯æŒè‡ªå®šä¹‰åŸŸåã€git ç‰ˆæœ¬ç®¡ç†ï¼Œmarkdown è‡ªåŠ¨æ¸²æŸ“ç®€ç›´å°±æ˜¯ä¸“é—¨ç»™ç¨‹åºå‘˜é‡èº«å®šåšçš„ï¼ˆå¥½åƒç¡®å®ä¹Ÿæ˜¯çš„ï¼‰ã€‚</p><p>ç¨‹åºçŒ¿åªç”¨ä¸“æ³¨äºå†™ markdown æ–‡ä»¶å³å¯ï¼Œæ¸²æŸ“ html ç­‰éƒ½äº¤ç»™ gitubã€‚</p><p>ä¸‹å›¾æ˜¯æˆ‘æ­å»ºåçš„ä¸€ä¸ªæˆªå›¾ã€‚</p><p><img src="/resources/how-to-blog-elegantly-as-a-software-engineer/github-octopress.jpeg" alt="githubå’Œoctopressé…ç½®"></p><p>è¯¦ç»†è¿‡ç¨‹å¯ä»¥å‚è€ƒä¸‹æˆ‘çš„è¿™å‡ ç¯‡ Blogï¼š</p><ul><li><p><a href="https://www.tanglei.name/blog/use-github-to-make-hello-world.html">GitHubæ­å»ºåšå®¢æ•™ç¨‹</a></p></li><li><p><a href="https://www.tanglei.name/blog/github-with-octopress.html">ä¹Ÿè¯•è¯•github+octopress</a> </p></li></ul><p>å†æ­å»ºè¿‡ç¨‹ä¸­ï¼Œè¿˜ä¼šæ¶‰åŠåˆ°å†å²æ–‡ç« çš„è¿ç§»ç­‰ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒ<a href="https://www.tanglei.name/blog/give-up-wordpress-to-jekyll.html">æœ€ç»ˆè¿˜æ˜¯æ”¾å¼ƒäº†Wordpress</a>ã€‚</p><p>github pages æœåŠ¡çš„å¥½å¤„åœ¨äºï¼Œåšä¸»ä»¬çœŸæ­£å…³æ³¨çš„åªéœ€è¦å†™ markdown å°±å¯ä»¥äº†(ç±»ä¼¼å†™è®ºæ–‡ç”¨ latex ä¸€æ ·)ï¼Œæ ¹æœ¬ä¸ç”¨å»å…³æ³¨æ¯”å¦‚åœ¨ wordpress åå°æ’ç‰ˆï¼Œä¼ å›¾ç‰‡ç­‰ç­‰æ“ä½œã€‚ </p><h3 id="github-pages-travis-ci"><a href="#github-pages-travis-ci" class="headerlink" title="github pages + travis-ci"></a>github pages + travis-ci</h3><p>github pages æœåŠ¡æœ¬èº«æ”¯æŒçš„åšå®¢å¼•æ“æ¯”è¾ƒå°‘ï¼Œæ¯”å¦‚å¸Œæœ›ä¸€äº›å®šåˆ¶åŒ–çš„æ’ä»¶ç­‰ï¼Œgithub pages é»˜è®¤æœåŠ¡å°±ä¸å¤Ÿäº†ã€‚</p><p>ä½†æœ¬è´¨ä¸Šè®²ï¼Œgithub pages æœåŠ¡å°±æ˜¯æä¾›äº†ä¸€ä¸ªè‡ªå®šä¹‰åŸŸåè§£æåˆ°é™æ€ html çš„ repoã€‚markdown è½¬ html çš„è¿™ä¸ªè¿‡ç¨‹ï¼Œ github æ”¯æŒå¾—ä¸å¤Ÿï¼Œå¯ä»¥é€šè¿‡å…¶ä»–çš„æ–¹å¼ã€‚</p><p>æ¯”å¦‚æœ¬åœ°å†™ markdownï¼Œç„¶åæœ¬åœ°å®‰è£… hexo ç­‰åšå®¢å¼•æ“ï¼Œæ¸²æŸ“æˆ html åç›´æ¥ push åˆ° github page çš„è¿œç¨‹ä»“åº“å³å¯ã€‚</p><p>æˆ‘æ›¾ç»ä¹Ÿä½¿ç”¨è¿‡å¤šä¸ªåšå®¢å¼•æ“ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="/resources/how-to-blog-elegantly-as-a-software-engineer/jekyll.tanglei.name.jpg" alt="jekyllåšå®¢ä¸»é¢˜"></p><p><img src="/resources/how-to-blog-elegantly-as-a-software-engineer/hexo.tanglei.name.jpg" alt="hexoä¸»é¢˜"></p><p>è¿™é‡Œæ¨èä¸€ä¸ªå·¥å…· â€”â€” travisï¼Œå®ƒæ˜¯ä¸€æ¬¾å…è´¹çš„ CI å·¥å…·ï¼Œèƒ½å¸®ä½ åšçš„äº‹æƒ…æ˜¯å•¥ï¼Ÿ å°±æ˜¯ä¸Šé¢ä½ æœ¬åœ°çš„æµç¨‹å¯ä»¥äº¤ç»™å®ƒæ¥åšã€‚ç°åœ¨æˆ‘å†™ blog çš„æµç¨‹æ˜¯ï¼š</p><ol><li>æœ¬åœ°å†™ blogï¼Œmd æ ¼å¼çš„ã€‚å·¥å…·å¯ä»¥ç›´æ¥ç”¨ä¹‹å‰æ¨èçš„ <a href="https://mp.weixin.qq.com/s/PlDF6pn55vE1_7rusC3K2w" target="_blank" rel="noopener">ç¨‹åºå‘˜åˆ©å™¨</a> ä¸­çš„ markdown å†™ä½œå·¥å…· Macdown æˆ–è€… Typoraã€‚</li><li>git commit &amp;&amp; git push å³å¯ã€‚</li><li>travis å¼€å§‹å·¥ä½œï¼Œå®‰è£… blog ç¨‹åºï¼Œç„¶å build é™æ€ htmlï¼Œæœ€å push åˆ°æŒ‡å®šçš„ github pages ä»“åº“ã€‚</li></ol><p>è´´ä¸€ä¸‹æˆ‘çš„ travis é…ç½®ï¼Œå¤§å®¶å°±çŸ¥é“æ˜¯æ€ä¹ˆç©çš„äº†ã€‚</p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">branches:</span><br><span class="line">  only:</span><br><span class="line">  - master</span><br><span class="line">language: node_js</span><br><span class="line"></span><br><span class="line"># v14/stable(2020-05) produces empty html https://github.com/hexojs/hexo/issues/4257</span><br><span class="line">node_js:</span><br><span class="line">    - 'v13.8.0'</span><br><span class="line"></span><br><span class="line">cache: npm</span><br><span class="line"></span><br><span class="line">before_install:</span><br><span class="line">- git config --global user.name "tangleithu"</span><br><span class="line">- git config --global user.email travis@tanglei.name</span><br><span class="line"></span><br><span class="line">install:</span><br><span class="line">- npm install hexo-cli -g</span><br><span class="line">- npm install</span><br><span class="line"></span><br><span class="line">script:</span><br><span class="line">- hexo clean</span><br><span class="line">- hexo g</span><br><span class="line">- git log | head -n 6</span><br><span class="line">- export COMMIT=`git log | head -n 1`</span><br><span class="line">- mv public .deploy &amp;&amp; cd .deploy &amp;&amp; du -sh</span><br><span class="line">- git init &amp;&amp; git add -A . &amp;&amp; git commit -m "commit from travis, origin $COMMIT" </span><br><span class="line">- git push --force "https://tl3shi:$GITHUB_TOKEN@github.com/tl3shi/hexo.tanglei.name.git" master:gh-pages</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„é…ç½®å¯ä»¥çœ‹å‡ºï¼Œå…¶å®åšçš„äº‹æƒ…å°±æ˜¯å®‰è£…åšå®¢ç¨‹åº hexoï¼Œç„¶åç”Ÿæˆé™æ€ htmlï¼Œæœ€åå°†æœ¬åœ°ç”Ÿæˆçš„é™æ€ html æ•´ä½“æ‰“åŒ…ä½œä¸ºä¸€ä¸ªä»“åº“ push åˆ°github pages å¯¹åº”çš„ä»“åº“ã€‚</p><p>ä¸‹å›¾æ˜¯ travis-ci çš„é…ç½®é¡µé¢ï¼Œå¯ä»¥é…ç½®æ¯”å¦‚åªè¦æœ‰æ–°çš„ commit push å³å¯è§¦å‘ CI æµç¨‹ï¼Œè¿›è€Œæ›´æ–°åšå®¢å†…å®¹ã€‚</p><p><img src="/resources/how-to-blog-elegantly-as-a-software-engineer/travis-ci-config.png" alt="travis-ci é…ç½®"></p><p>åˆ«çœ‹æ•´ä¸ªè¿‡ç¨‹çœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œå…¶å®å®‰è£…ç­‰è¿‡ç¨‹æ˜¯å¯ä»¥ cache çš„ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œèµ°å®Œæ•´ä¸ªæµç¨‹æ‰€è€—è´¹çš„æ—¶é—´ä¹Ÿå°± 1-2 åˆ†é’Ÿï¼ˆåå›¾æ‰€ç¤ºï¼‰ï¼Œå› ä¸ºæˆ‘çš„åšå®¢å†…å®¹â€œå†å²åŒ…è¢±é‡â€ï¼Œå¯èƒ½è€—è´¹æ—¶é—´ä¼šæ›´ä¹…ï¼Œè¿™æ—¶é—´å¤§éƒ¨åˆ†å–å†³äºåšå®¢ç¨‹åºçš„å¤„ç†æµç¨‹ä»¥åŠæœ€å git ä¸Šä¼ è¿‡ç¨‹ã€‚</p><p>ä¸‹å›¾æ˜¯æ„å»ºå†å²ï¼Œæ„å»ºæˆåŠŸä¸å¦ä¼šé‚®ä»¶æ–¹å¼é€šçŸ¥åˆ°ä½ ï¼Œå¾ˆæ–¹ä¾¿ã€‚</p><p><img src="/resources/how-to-blog-elegantly-as-a-software-engineer/travis-history.png" alt="travis æ„å»ºå†å²"></p><p>å€ŸåŠ© travis å¯ç©çš„ä¸œè¥¿å°±å¤šäº†ï¼Œä¸Šé¢çš„ scripts æœ‰è¶³å¤Ÿçš„çµæ´»æ€§å¯ä»¥è‡ªå·±éšæ„å®šåˆ¶ã€‚</p><p>æ¯”å¦‚ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥åŒä¸€æ–‡ç« å¤šä¸ªå¹³å°å‘ã€‚ä¸¾ä¾‹ï¼Œç°åœ¨å¤§å®¶æ™®éç©æ³•æ˜¯å„å¤§åšå®¢å¹³å°åŒæ­¥å‘è¡¨ã€‚æ˜¯å¦å¯ä»¥ç›´æ¥åœ¨ CI æµç¨‹é‡Œé¢æ·»åŠ  juejinã€åšå®¢å›­ç­‰ post æµç¨‹å‘¢ï¼Ÿ</p><p>æ„Ÿå…´è¶£çš„æœ‹å‹è¯•è¯•ï¼Ÿï¼ˆçŸ³å¤´å¥½ä¹…éƒ½æœ‰è¿™ä¸ªæƒ³æ³•äº†ï¼Œä½†å´ä¸€ç›´æ²¡æœ‰ä»˜å‡ºè¡ŒåŠ¨ï¼‰</p><h3 id="è§£å†³-github-æ…¢çš„é—®é¢˜"><a href="#è§£å†³-github-æ…¢çš„é—®é¢˜" class="headerlink" title="è§£å†³ github æ…¢çš„é—®é¢˜"></a>è§£å†³ github æ…¢çš„é—®é¢˜</h3><p>ç”¨ github ç¡®å®å¾ˆæ–¹ä¾¿ï¼Œå„ç§å…è´¹çš„æœåŠ¡ç™½piaoï¼Œä½†ç¼ºç‚¹ä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼Œå°±æ˜¯å›½å†…è®¿é—®æ¯”å¥½æ…¢ã€‚gitee ä¹Ÿæä¾›ç±»ä¼¼çš„æœåŠ¡ï¼Œä½†å‰é¢çœ‹äº†ä¸€çœ¼ï¼Œè‡ªå®šä¹‰åŸŸåå¥½åƒè¦æ”¶è´¹ï¼Ÿ</p><p>ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„æ–¹æ³•æ˜¯ç”¨ CDN æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ blog æœ¬èº«å…¨æ˜¯é™æ€èµ„æºï¼Œhtmlã€å›¾ç‰‡ç­‰ï¼Œå¾ˆé€‚åˆç”¨ CDN æ¥åŠ é€Ÿã€‚ </p><p>åœ¨è¿™ç¯‡<a href="https://www.tanglei.name/blog/try-qcloud-vm-cdn.html">äº‘æœåŠ¡å™¨ï¼ŒåŸŸåå¤‡æ¡ˆåŠ CDN æœåŠ¡ä½“éªŒ</a> æ–‡ç« ä¸­ï¼Œæˆ‘è®°å½•äº†ä¹‹å‰å…·ä½“çš„æµç¨‹ã€‚</p><p>CDN çš„å·¥ä½œæµç¨‹å°±æ˜¯ä½ æ·»åŠ ä¸€ä¸ªåŸŸåçš„ CNAMEï¼ŒæŒ‡å‘ CDN å‚å•†çš„åŸŸåï¼Œæ‰€ä»¥ç”¨æˆ·å‘èµ·è¯·æ±‚çš„æ—¶å€™å®é™…æ˜¯è§£æåˆ°äº‘å‚å•†çš„ CDN æœåŠ¡å™¨çš„ï¼ŒCDN åå°é…ç½®ä¸€ä¸ªæºç«™ç‚¹ï¼Œä¾‹å¦‚ <code>www.tanglei.name</code>ï¼Œç”¨æˆ·è¯·æ±‚åˆ° CDN æœåŠ¡å™¨æ—¶ï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­ï¼Œåˆ™å°±å»æºç«™ç‚¹è¯·æ±‚å¹¶å°†å†…å®¹ç¼“å­˜è‡³ CDN æœåŠ¡å™¨ã€‚</p><p>ä»¥ä¸‹æ˜¯æˆ‘ä¹‹å‰æµ‹è¯• CDN çš„ä¸€ä¸ªæ•ˆæœæˆªå›¾ã€‚</p><p><img src="http://www.tanglei.name/resources/qcloud/www.tanglei.me-ping-cdn.png" alt="CDNé…ç½®æ•ˆæœå›¾"></p><p>ä¸‹å›¾æ˜¯è®¿é—®ä¸€ä¸ª <a href="http://www.tanglei.name/blog/app-in-mac-for-common.html">å«æœ‰ä¸€äº›å›¾ç‰‡çš„é¡µé¢</a>çš„æµ‹è¯•ç»“æœï¼Œå…¶ä¸­ï¼š </p><ul><li>è¯·æ±‚ <code>www.tanglei.name</code> ä¼šç›´æ¥è·¯ç”±åˆ° github pages çš„æ–‡ä»¶ï¼›</li><li>é€šè¿‡ <code>www.tanglei.me</code> ä¼šèµ°äº‘å‚å•†çš„ CDNï¼›</li></ul><p><img src="http://www.tanglei.name/resources/qcloud/tanglei.name-vs-tanglei.me-cdn.png" alt="CDNæµ‹è¯•ç»“æœtanglei.name"></p><p>è®¿é—®ä¸€ä¸ª 10K çš„é¡µé¢ï¼ŒåŸºæœ¬åœ¨åŠç§’å°±åŠ è½½å®Œæ¯•äº†ï¼Œå¯¹äºä¸ªäººåšå®¢æ¥è®²ï¼Œå·²ç»å¾ˆå¤Ÿç”¨äº†ã€‚ä¸Šå›¾çš„ç»“æœè¿˜æœ‰ä¸€äº›å¦‚ USA çš„èŠ‚ç‚¹æ‹‰ä½äº†å¹³å‡å€¼ï¼Œå›½å¤–çš„ä¸€äº›èŠ‚ç‚¹è¿˜æ˜¯èµ° github æ›´å¿«ã€‚å¦‚æœæœ‰éœ€æ±‚åšå…¨çƒåŠ é€Ÿçš„è¯ï¼Œè¿˜å¯ä»¥ç”¨æ¯”å¦‚æ•å¸çš„å…¨çƒåŠ é€ŸæœåŠ¡å“¦ï¼ˆCDNåŒ…æ‹¬æµ·å¤–ä¼—å¤šèŠ‚ç‚¹ï¼‰ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æœ¬æ–‡åªæ˜¯çŸ³å¤´åœ¨æ¢ç´¢è¿‡ç¨‹å‘ç°è§‰å¾—åˆé€‚è‡ªå·±çš„æ–¹æ³•ï¼Œæ¯ä¸ªäººå–œæ¬¢çš„å§¿åŠ¿å¯èƒ½ä¸ä¸€æ ·ï¼Œä»…ä¾›å‚è€ƒã€‚å¸Œæœ›ä½ èƒ½æ‰¾åˆ°é€‚åˆä½ çš„å§¿åŠ¿ã€‚</p><p>è§‰å¾—æœ¬å·åˆ†äº«çš„æ–‡ç« æœ‰ä»·å€¼ï¼Œè®°å¾—æ·»åŠ æ˜Ÿæ ‡å“¦ã€‚åˆ«ç™½ piaoï¼Œéœ€è¦æ¥ç‚¹æ­£åé¦ˆï¼Œå®‰æ’ä¸ª â€œä¸€é”®ä¸‰è¿â€ï¼ˆç‚¹èµã€åœ¨çœ‹ã€åˆ†äº«ï¼‰å¦‚ä½•ï¼ŸğŸ˜ è¿™å°†æ˜¯æˆ‘æŒç»­è¾“å‡ºä¼˜è´¨æ–‡ç« çš„æœ€å¼ºåŠ¨åŠ›ã€‚</p><p><img src="/resources/ä¸€é”®ä¸‰è¿.gif" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;å…³äºä½œè€…ï¼šç¨‹åºçŒ¿çŸ³å¤´(ID: tangleithu)ï¼Œç°ä»»é˜¿é‡Œå·´å·´æŠ€æœ¯ä¸“å®¶ï¼Œæ¸…åå­¦æ¸£ï¼Œå‰å¤§ç–†åç«¯ Leaderã€‚ç”¨ä¸åŒçš„è§†è§’åˆ†äº«é«˜è´¨é‡æŠ€æœ¯æ–‡ç« ï¼Œä»¥æ¯ç¯‡æ–‡ç« éƒ½è®©äººæœ‰æ”¶è·ä¸ºç›®çš„ï¼Œæ¬¢è¿å…³æ³¨ï¼Œäº¤æµå’ŒæŒ‡å¯¼ï¼å…¬ä¼—å·åå°å›å¤å…³é”®å­— â€œ1024â€ è·å–ç¨‹åºå‘˜å¤§å‚é¢
      
    
    </summary>
    
      <category term="MyLife" scheme="https://www.tanglei.name/categories/MyLife/"/>
    
    
      <category term="MyLife" scheme="https://www.tanglei.name/tags/MyLife/"/>
    
  </entry>
  
  <entry>
    <title>é¢è¯•å®˜ï¼šä¼šç©ç‰Œå§ï¼Ÿç»™æˆ‘è®²è®²æ´—ç‰Œç®—æ³•å’Œåº”ç”¨åœºæ™¯å§ï¼</title>
    <link href="https://www.tanglei.name/blog/shuffle-algorithm.html"/>
    <id>https://www.tanglei.name/blog/shuffle-algorithm.html</id>
    <published>2020-07-18T00:00:00.000Z</published>
    <updated>2020-10-11T15:25:42.107Z</updated>
    
    <content type="html"><![CDATA[<p>æœ‰ä¸€æ¬¡å‚åŠ é¢è¯•ï¼Œé¢è¯•å®˜é—®æˆ‘ï¼šâ€œä¼šç©ç‰Œå§ï¼Ÿâ€</p><p><img src="https://static01.imgkr.com/temp/3dd28e16a9ae45858913c98be35c4d76.png" alt></p><p>å†…å¿ƒï¼šâ€œå’‹æ»´ï¼Œè¿™æ˜¯è¦ç©å¾·å·æ‰‘å…‹ï¼ˆæˆ–è€…ç‚¸é‡‘èŠ±ï¼‰ï¼Œèµ¢äº†ä»–å°±èƒ½é€šè¿‡é¢è¯•ä¹ˆï¼Ÿâ€</p><p>ç»“æœâ€¦â€¦</p><p>æ²¡æƒ³åˆ°é¢è¯•å®˜çš„ä¸‹ä¸€å¥è¯ï¼šâ€œç»™æˆ‘è®²è®²æ´—ç‰Œç®—æ³•ä»¥åŠå®ƒçš„åº”ç”¨åœºæ™¯å§ï¼â€</p><p><img src="https://static01.imgkr.com/temp/225551c21c1f4437a9deb17aeda15177.png" alt="å“ˆå“ˆï¼Œä»¥ä¸Šå†…å®¹çº¯å±è™šæ„"></p><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>æœ¬æ–‡äº§ç”ŸèƒŒæ™¯æ˜¯çœ‹åˆ°äº† <code>ä¸€æèŠ±ç®—ä¸ç®—æµªæ¼«</code> åŒå­¦çš„è¿™ç¯‡ <a href="https://mp.weixin.qq.com/s/bSIKnw5446Ocb63Covk2Fw" target="_blank" rel="noopener">Eurekaæ³¨å†Œä¸­å¿ƒé›†ç¾¤å¦‚ä½•å®ç°å®¢æˆ·ç«¯è¯·æ±‚è´Ÿè½½åŠæ•…éšœè½¬ç§»ï¼Ÿ</a>æ–‡ç« æƒ³åˆ°çš„ã€‚å…¶å®æœ¬äººè§‰å¾—é‚£ç¯‡æ–‡ä¸­æåˆ°çš„è´Ÿè´£å‡è¡¡çš„é‡ç‚¹å°±æ˜¯æœ¬æ–‡è¦è¯´çš„æ´—ç‰Œç®—æ³•ã€‚</p><p>å¥½äº†ï¼Œå›åˆ°é¢˜ç›®ä¸Šæ¥ã€‚</p><p>è¿™ç¡®å®ä¹Ÿæ˜¯ä¸€é“é¢è¯•é¢˜ï¼Œæˆ‘æ›¾ç»å¤šæ¬¡é¢è¯•ä¸­éƒ½æœ‰é‡åˆ°è¿™ä¸ªé¢˜ç›®æˆ–è€…è¿™ä¸ªé¢˜ç›®çš„å˜ç§ã€‚</p><p>ä½ ä¸å¦¨èŠ± 1 ç§’ï¼Œæƒ³æƒ³ï¼Ÿ</p><p><img src="https://static01.imgkr.com/temp/dd508c001bef4c9e9cc6a88802983ec0.png" alt></p><h2 id="ä»€ä¹ˆæ˜¯æ´—ç‰Œç®—æ³•"><a href="#ä»€ä¹ˆæ˜¯æ´—ç‰Œç®—æ³•" class="headerlink" title="ä»€ä¹ˆæ˜¯æ´—ç‰Œç®—æ³•"></a>ä»€ä¹ˆæ˜¯æ´—ç‰Œç®—æ³•</h2><p>ä»åå­—ä¸Šæ¥çœ‹ï¼Œå°±æ˜¯ç»™ä½ ä¸€å‰¯ç‰Œè®©ä½ æ´—å‘—ï¼Œç”¨æ€æ ·çš„æ–¹æ³•æ‰èƒ½æ´—å¾—å‡åŒ€å‘¢ï¼Ÿ<br>è¯·å¤§ä½¬è¡¨æ¼”ä¸€ä¸‹ã€‚</p><p><img src="https://static01.imgkr.com/temp/609655ff110e4ca5a6164e777cfdbaa6.gif" alt="ä¸å¥½æ„æ€ï¼Œç¿»è½¦äº†"></p><p>å…¶å®æ´—ç‰Œç®—æ³•å°±æ˜¯ä¸€ç§éšæœºç®—æ³•ï¼Œä½ åœ¨æ–—åœ°ä¸»çš„æ—¶å€™ï¼ŒéšæœºæŠŠç‰Œçš„é¡ºåºæ‰“ä¹±å°±è¡Œã€‚ä¸€ä¸ªè¶³å¤Ÿå¥½çš„æ´—ç‰Œç®—æ³•æœ€ç»ˆç»“æœåº”è¯¥æ˜¯å¯ä»¥è®©ç‰Œçš„é¡ºåºè¶³å¤Ÿéšæœºã€‚å¥½åƒæœ‰ç‚¹ç»•~</p><p>è¿™ä¹ˆæ¥è¯´å§ï¼Œä¸€å‰¯ç‰Œå¤§å®¶æ–—åœ°ä¸»çš„è¯ç”¨ 54 å¼ ï¼ˆä¸è€ƒè™‘ä½ ä»¬æ‰“é…é…ç‰Œçš„æƒ…å½¢å“ˆï¼‰ï¼Œé‚£ä¹ˆè¿™ 54 å¼ ç‰Œçš„é¡ºåºçš„è¯ï¼ŒæŒ‰ç…§æ’åˆ—ç»„åˆç®—æ³•ï¼Œåº”è¯¥æ˜¯æœ‰ <code>54!</code> è¿™ä¹ˆå¤šç§ï¼Œç„¶åä½ çš„æ´—ç‰Œç®—æ³•å°±æ˜¯ä»è¿™ <code>54!</code> ç§æ’åˆ—ä¸­ï¼Œéšæœºé€‰ 1 ç§ã€‚</p><p><img src="https://static01.imgkr.com/temp/5dae931b74434a6282a7f98451dd6158.png" alt></p><p>æ— èŠçš„çŸ³å¤´ç®—äº†ä¸€ä¸‹ï¼Œ54 çš„é˜¶ä¹˜æœ‰å¤šå¤§å‘¢ï¼Ÿå¤§æ¦‚å°±æ˜¯è¿™ä¹ˆå¤§ä¸€é•¿ä¸²æ•°å­—ï¼Œ<code>2308436973392413804720927448683027581083278564571807941132288000000000000L</code>ï¼Œå‡†ç¡®ç­”æ¡ˆçœ‹ä¸‹å›¾ï¼š</p><p><img src="https://imgkr.cn-bj.ufileos.com/59a89bd0-0e53-4bba-b60f-7ab063685f1b.png" alt="54çš„é˜¶ä¹˜è®¡ç®—ç»“æœ"></p><p>æˆ‘ä»¬è¿˜æ˜¯ä»¥ 4 å¼ ç‰Œä½œä¸ºä¾‹å­å§ã€‚</p><p>4 å¼ ç‰Œï¼Œ<code>JQKA</code>ï¼Œæ‰€æœ‰çš„æ’åˆ—æœ‰ <code>4!=4*3*2*1=24</code> ç§ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(&apos;J&apos;, &apos;Q&apos;, &apos;K&apos;, &apos;A&apos;)</span><br><span class="line">(&apos;J&apos;, &apos;Q&apos;, &apos;A&apos;, &apos;K&apos;)</span><br><span class="line">(&apos;J&apos;, &apos;K&apos;, &apos;Q&apos;, &apos;A&apos;)</span><br><span class="line">(&apos;J&apos;, &apos;K&apos;, &apos;A&apos;, &apos;Q&apos;)</span><br><span class="line">(&apos;J&apos;, &apos;A&apos;, &apos;Q&apos;, &apos;K&apos;)</span><br><span class="line">(&apos;J&apos;, &apos;A&apos;, &apos;K&apos;, &apos;Q&apos;)</span><br><span class="line">(&apos;Q&apos;, &apos;J&apos;, &apos;K&apos;, &apos;A&apos;)</span><br><span class="line">(&apos;Q&apos;, &apos;J&apos;, &apos;A&apos;, &apos;K&apos;)</span><br><span class="line">(&apos;Q&apos;, &apos;K&apos;, &apos;J&apos;, &apos;A&apos;)</span><br><span class="line">(&apos;Q&apos;, &apos;K&apos;, &apos;A&apos;, &apos;J&apos;)</span><br><span class="line">(&apos;Q&apos;, &apos;A&apos;, &apos;J&apos;, &apos;K&apos;)</span><br><span class="line">(&apos;Q&apos;, &apos;A&apos;, &apos;K&apos;, &apos;J&apos;)</span><br><span class="line">(&apos;K&apos;, &apos;J&apos;, &apos;Q&apos;, &apos;A&apos;)</span><br><span class="line">(&apos;K&apos;, &apos;J&apos;, &apos;A&apos;, &apos;Q&apos;)</span><br><span class="line">(&apos;K&apos;, &apos;Q&apos;, &apos;J&apos;, &apos;A&apos;)</span><br><span class="line">(&apos;K&apos;, &apos;Q&apos;, &apos;A&apos;, &apos;J&apos;)</span><br><span class="line">(&apos;K&apos;, &apos;A&apos;, &apos;J&apos;, &apos;Q&apos;)</span><br><span class="line">(&apos;K&apos;, &apos;A&apos;, &apos;Q&apos;, &apos;J&apos;)</span><br><span class="line">(&apos;A&apos;, &apos;J&apos;, &apos;Q&apos;, &apos;K&apos;)</span><br><span class="line">(&apos;A&apos;, &apos;J&apos;, &apos;K&apos;, &apos;Q&apos;)</span><br><span class="line">(&apos;A&apos;, &apos;Q&apos;, &apos;J&apos;, &apos;K&apos;)</span><br><span class="line">(&apos;A&apos;, &apos;Q&apos;, &apos;K&apos;, &apos;J&apos;)</span><br><span class="line">(&apos;A&apos;, &apos;K&apos;, &apos;J&apos;, &apos;Q&apos;)</span><br><span class="line">(&apos;A&apos;, &apos;K&apos;, &apos;Q&apos;, &apos;J&apos;)</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œä¸€ä¸ªå‡åŒ€çš„æ´—ç‰Œç®—æ³•ï¼Œå°±æ˜¯æ¯æ¬¡æ´—ç‰Œå®Œåï¼Œè·å¾—ä¸Šé¢æ¯ç§é¡ºåºçš„æ¦‚ç‡æ˜¯ç›¸ç­‰çš„ï¼Œéƒ½ç­‰äº<code>1/24</code>ã€‚æ„Ÿè§‰å·²ç»å‡ºæ¥äº†ä¸€ç§ç®—æ³•äº†ï¼Œé‚£å°±æ˜¯å…ˆåƒå‰æ–‡æ‰€è¿°æŠŠæ‰€æœ‰çš„æ’åˆ—æƒ…å†µéƒ½æšä¸¾å‡ºæ¥ï¼Œåˆ†åˆ«æ ‡ä¸Šå· 1-24 å·ï¼Œç„¶åä» 24 ä¸­éšæœºå–ä¸€ä¸ªæ•°å­—ï¼ˆå…ˆä¸è€ƒè™‘å¦‚ä½•èƒ½åšåˆ°éšæœºå–äº†ï¼Œè¿™ä¸ªè¯é¢˜å¥½åƒä¹Ÿæ²¡é‚£ä¹ˆå®¹æ˜“ï¼‰ï¼Œè·å–å…¶ä¸­è¿™ä¸ªæ•°å­—å¯¹åº”çš„å·çš„æ’åˆ—ã€‚</p><p>è¿™ä¸ªç®—æ³•å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿå‡è®¾ä¸º <code>N</code> å¼ ç‰Œçš„è¯ï¼Œåº”è¯¥å°±æ˜¯ <code>1/N!</code>ï¼ˆæ³¨æ„æ˜¯é˜¶ä¹˜ï¼Œè¿™é‡Œå¯ä¸æ˜¯æ„Ÿå¹å·ï¼‰ï¼Œæ˜¾ç„¶å¤æ‚åº¦å¤ªé«˜äº†ã€‚</p><p>æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯è‚¯å®šçš„ã€‚</p><h2 id="ç»å…¸çš„æ´—ç‰Œç®—æ³•"><a href="#ç»å…¸çš„æ´—ç‰Œç®—æ³•" class="headerlink" title="ç»å…¸çš„æ´—ç‰Œç®—æ³•"></a>ç»å…¸çš„æ´—ç‰Œç®—æ³•</h2><p>æ´—ç‰Œç®—æ³•å®é™…ä¸Šæ˜¯ä¸€ä¸ªå¾ˆç»å…¸çš„ç®—æ³•ï¼Œåœ¨ç»å…¸ä¹¦ç±ã€Šç®—æ³•å¯¼è®ºã€‹é‡Œé¢å¾ˆé å‰çš„éƒ¨åˆ†å°±æœ‰è®²è§£å’Œåˆ†æã€‚</p><p>æˆ‘ä»¬æŠŠè¿™ä¸ªæ´—ç‰Œè¿‡ç¨‹ç”¨æ›´åŠ â€œç¨‹åºå‘˜â€çš„è¯­è¨€æè¿°ä¸€ä¸‹ï¼Œå°±æ˜¯å‡è®¾æœ‰ä¸€ä¸ª <code>n</code> ä¸ªå…ƒç´ çš„æ•°ç»„ <code>Array[n]</code>ï¼Œé€šè¿‡æŸç§æ–¹å¼ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå¦å¤–ä¸€ä¸ªåºåˆ—<code>Array&#39;[n]</code>è®©æ•°ç»„çš„æ¯ä¸ªå…ƒç´  <code>Array[i]</code> åœ¨æ•°ç»„ä¸­çš„æ¯ä¸ªä½ç½®å‡ºç°çš„æ¦‚ç‡éƒ½æ˜¯<code>1/n</code>ã€‚</p><p>å…¶å®æ–¹æ³•å¯ä»¥è¿™æ ·ï¼Œä¾æ­¤ä» <code>Array</code> ä¸­éšæœºé€‰æ‹© 1 ä¸ªï¼Œä¾æ­¤æ”¾åˆ° <code>Array&#39;</code> ä¸­å³å¯ã€‚<br>è¯æ˜ä¸€ä¸‹ï¼š</p><ul><li><code>Array[0]</code>ï¼Œåœ¨æ–°æ•°ç»„çš„ç¬¬ 0 ä¸ªä½ç½®å¤„çš„æ¦‚ç‡ä¸ºï¼š<code>1/n</code>ï¼Œå› ä¸ºéšæœºé€‰ï¼Œåªèƒ½æ˜¯<code>1/n</code>çš„æ¦‚ç‡èƒ½é€‰ä¸­ï¼›</li><li><code>Array[1]</code>ï¼Œåœ¨æ–°æ•°ç»„çš„ç¬¬ 1 ä¸ªä½ç½®å¤„çš„æ¦‚ç‡ä¸ºï¼š<code>1/n</code>ï¼Œå› ä¸º ç¬¬ä¸€æ¬¡æ²¡é€‰ä¸­ <code>Array[1]</code>çš„æ¦‚ç‡ä¸º <code>n-1/n</code>ï¼Œå†ç»“åˆç¬¬äºŒæ¬¡ï¼ˆåªå‰©ä¸‹n-1ä¸ªäº†ï¼Œæ‰€ä»¥åˆ†æ¯ä¸º<code>n-1</code>ï¼‰é€‰ä¸­çš„æ¦‚ç‡ä¸ºï¼š<code>1/n-1</code>ï¼Œå› æ­¤æ¦‚ç‡ä¸ºï¼š$\frac{n-1}{n} * \frac{1}{n-1} = \frac{1}{n}$ ã€‚</li><li>ä¾æ­¤ç±»æ¨ï¼Œå¯ä»¥è¯æ˜å‰è¿°é—®é¢˜ã€‚</li></ul><p>å…¶å®ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ç”¨å¦å¤–æ‰¾ä¸ªæ•°ç»„æ¥å­˜ç»“æœï¼Œ<code>Array&#39;</code>ä¹Ÿå¯ä»¥ç†è§£ä¸ºè¿˜æ˜¯å‰é¢çš„è¿™ä¸ª <code>Array</code>ï¼Œåªä¸è¿‡é‡Œé¢å…ƒç´ çš„é¡ºåºå˜åŒ–äº†ã€‚</p><p>è¿™å…¶å®å¯ä»¥ç†è§£ä¸ºä¸€ä¸ª â€œæ’åºâ€ï¼ˆå…¶å®æ˜¯ä¹±åºï¼‰ è¿‡ç¨‹ï¼Œç®—æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shuffle</span><span class="params">(List list)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> size = list.size();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> j = random(i, n); <span class="comment">// éšæœºäº§ç”Ÿ [i, n) ä¸­çš„ä¸€ä¸ªæ•°ï¼Œæ¯ä¸ªæ¦‚ç‡ä¸€è‡´</span></span><br><span class="line">    <span class="comment">// list ä¸­ç¬¬ i ä¸ªå…ƒç´ å’Œ ç¬¬ j ä¸ªå…ƒç´ äº’æ¢ä½ç½® </span></span><br><span class="line">    swap(list[i], list[j]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯å¦‚ä½•è¯æ˜å‘¢ï¼Ÿä¸èƒ½ä½ è¯´éšæœºå°±éšæœºå§ï¼Œä½ è¯´ç­‰æ¦‚ç‡å°±ç­‰æ¦‚ç‡å§ã€‚ä¸‹é¢è¿˜æ˜¯è·Ÿç€çŸ³å¤´å“¥ä¸€èµ·æ¥çœ‹çœ‹å¦‚ä½•è¯æ˜å§ï¼ˆè¿™ä¹Ÿæ˜¯é¢è¯•ä¸­çš„è€ƒå¯Ÿç‚¹ï¼‰ã€‚</p><p>æˆ‘ä»¬å‡è®¾ç»è¿‡æ’åºåï¼ŒæŸä¸ªå…ƒç´  <code>Array[x]</code> æ°å¥½æ’åœ¨ä½ç½® <code>x</code> å¤„çš„æ¦‚ç‡ä¸º $P_x$ï¼Œ<br>åˆ™è¯¥å…ƒç´ æ°å¥½æ’åœ¨ç¬¬ <code>x</code> å¤„çš„æ¦‚ç‡æ˜¯å‰ <code>x-1</code> æ¬¡æ—¶éƒ½æ²¡æœ‰è¢«éšæœºåˆ°ï¼Œå¹¶ä¸”ç¬¬ <code>x</code> æ¬¡æ—¶ï¼Œæ°å¥½ <code>random(x, n) = x</code>äº†ã€‚ </p><p>è¿˜æ˜¯åœ¨å¾ªç¯ä¸­åˆ—ä¸¾å‡ é¡¹ï¼Œæ›´å¥½ç†è§£ä¸€äº›ï¼ˆå†™å®Œï¼Œæ‰å‘ç°è·Ÿå‰é¢çš„è§£é‡Šå·®ä¸å¤šï¼‰ï¼š</p><ul><li><code>i = 0</code>, <code>random(0, n)</code> æ²¡æœ‰è¿”å› xï¼Œå…± <code>n</code> ä¸ªæ•°ï¼Œè‚¯å®šè¿”å›äº†å…¶ä»– <code>n-1</code> ä¸ªä¸­çš„ä¸€ä¸ªï¼Œå› æ­¤æ¦‚ç‡ä¸º $\frac{n-1}{n}$</li><li><code>i = 1</code>, <code>ramdom(1, n)</code> æ²¡æœ‰è¿”å› xï¼Œå…± <code>n - 1</code> ä¸ªæ•°ï¼Œè‚¯å®šè¿”å›äº†å…¶ä»– <code>n-2</code> ä¸ªä¸­çš„ä¸€ä¸ªï¼Œå³è¯¥ä¸º $\frac{n-2}{n-1}$</li><li>ä¾æ­¤ç±»æ¨â€¦â€¦</li><li><code>i = x-1</code>, <code>random(x-1, n)</code> æ²¡æœ‰è¿”å› xï¼Œå…± <code>n - (x-1)</code> ä¸ªæ•°ï¼Œè‚¯å®šè¿”å›äº†å…¶ä»–<code>n-(x-1)-1</code> ä¸ªä¸­çš„ä¸€ä¸ªï¼Œå³ä¸º $\frac{n-(x-1)-1}{n - (x-1)}=\frac{n-x}{n - x+1}$</li><li><code>i = x</code>ï¼Œ<code>random(x, n)</code> æ°å¥½è¿”å›äº† xï¼Œå…± <code>n-x</code> ä¸ªæ•°ï¼Œæ¦‚ç‡ä¸º $\frac{1}{n-x}$</li></ul><p>$p_x = \frac{n-1}{n} <em> \frac{n-2}{n-1} </em>â€¦<em> \frac{n-x}{n - x+1}</em> \frac{1}{n-x} = \frac{1}{n}$</p><p>å› æ­¤ï¼Œåˆ°è¿™ç®—æ˜¯ç®€å•è¯æ˜äº†ä»»ä½•å…ƒç´ å‡ºç°åœ¨ä»»ä½•ä½ç½®çš„æ¦‚ç‡æ˜¯ç›¸ç­‰çš„ã€‚</p><p>æ³¨æ„è¯´æ˜ä¸€ä¸‹ï¼Œè¿™æ˜¯ç†è®ºä¸Šçš„å€¼ï¼Œæ¦‚ç‡ç±»çš„é—®é¢˜åœ¨é‡ä¸å¤§çš„æƒ…å†µä¸‹â€‹å¾ˆæœ‰å¯èƒ½æœ‰éšæœºæ€§çš„ã€‚å°±åƒç¿»ç¡¬å¸â€‹ï¼Œæ­£åé¢ç†è®ºä¸Šçš„å€¼éƒ½æ˜¯ä¸€åŠä¸€åŠçš„ï¼Œä½†ä½ ä¸èƒ½è¯´ä¸€å®šæ˜¯æ­£åé¢æŒ‰ç…§æ¬¡åºè½®ç€æ¥ã€‚â€‹</p><h2 id="çœ‹çœ‹-JDK-ä¸­çš„å®ç°"><a href="#çœ‹çœ‹-JDK-ä¸­çš„å®ç°" class="headerlink" title="çœ‹çœ‹ JDK ä¸­çš„å®ç°"></a>çœ‹çœ‹ JDK ä¸­çš„å®ç°</h2><p>æˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹çœ‹ JDK ä¸­çš„å®ç°ã€‚JDK ä¸­ <code>Collections</code> ä¸­æœ‰å¦‚ä¸‹çš„å®ç°æ–¹æ³• <code>shuffle</code>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shuffle</span><span class="params">(List&lt;?&gt; list, Random rnd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> size = list.size();</span><br><span class="line">    <span class="comment">// çŸ³å¤´å¤‡æ³¨ï¼šæœ¬æœºç‰¹å®šç‰ˆæœ¬ä¸­çš„å¸¸é‡ SHUFFLE_THRESHOLD=5</span></span><br><span class="line">    <span class="keyword">if</span> (size &lt; SHUFFLE_THRESHOLD || list <span class="keyword">instanceof</span> RandomAccess) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=size; i&gt;<span class="number">1</span>; i--)</span><br><span class="line">            swap(list, i-<span class="number">1</span>, rnd.nextInt(i));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Object arr[] = list.toArray();</span><br><span class="line">        <span class="comment">// Shuffle array</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=size; i&gt;<span class="number">1</span>; i--)</span><br><span class="line">            swap(arr, i-<span class="number">1</span>, rnd.nextInt(i));</span><br><span class="line">        ListIterator it = list.listIterator();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;arr.length; i++) &#123;</span><br><span class="line">            it.next();</span><br><span class="line">            it.set(arr[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºæœ¬ä¸Šèƒ½çœ‹æ‡‚å¤§æ¦‚ï¼Œä¸è¿‡æ˜¯ä¸æ˜¯çœ‹çœ‹æºç è¿˜æ˜¯èƒ½è·å¾—æ–°æŠ€èƒ½çš„ã€‚</p><p>ä¸Šé¢æ¡ä»¶åˆ†æ”¯å¤§æ¦‚åˆ†ä¸¤ç±»ï¼š</p><ul><li>å¦‚æœæ˜¯æ•°ç»„ç±»å‹ï¼Œå°±æ˜¯å¯ä»¥ <code>O(1)</code>éšæœºè®¿é—®çš„Listï¼›æˆ–è€…ä¼ å…¥çš„ list å°äº <code>SHUFFLE_THRESHOLD</code>ã€‚</li><li>å¦åˆ™çš„è¯ä¸èƒ½éšæœºè®¿é—®çš„é“¾è¡¨ç±»å‹ï¼Œåˆ™èŠ± <code>O(n)</code> è½¬æˆæ•°ç»„ï¼Œå† shuffleï¼Œæœ€ååˆå›æ»šå›é“¾è¡¨ã€‚è½¬æˆæ•°ç»„çš„ç›®çš„å¾ˆç®€å•ï¼Œå¯ä»¥å¿«é€Ÿå®šä½æŸä¸ªä¸‹æ ‡çš„å…ƒç´ ã€‚</li></ul><p>ç¬¬ä¸€æ­¥çš„è¿™ä¸ª <code>SHUFFLE_THRESHOLD</code> å…¶å®å°±æ˜¯ä¸€ä¸ªç»éªŒè°ƒä¼˜å€¼ï¼Œå³ä¾¿å‡è®¾ä¸èƒ½é€šè¿‡å¿«é€Ÿä¸‹æ ‡å®šä½æŸä¸ªå…ƒç´ ï¼ˆå³éœ€è¦éå†çš„æ–¹å¼å®šä½ï¼‰ï¼Œå½“è¾“å…¥çš„ size æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œå’Œå…ˆèŠ± <code>O(n)</code>è½¬æˆæ•°ç»„æœ€ååˆè½¬å›æˆé“¾è¡¨ ç›¸æ¯”ï¼Œä¹Ÿèƒ½æœ‰æ›´å¿«çš„é€Ÿåº¦ã€‚</p><p>å¦å¤–å¤šè¯´ä¸€å¥ï¼Œå…¶å®è¿™ç§å‚æ•°åŒ–è°ƒä¼˜æ–¹å¼åœ¨å„ç§è¯­è¨€å®ç°çš„æ—¶å€™å¾ˆå¸¸è§çš„ï¼Œæ¯”å¦‚ä½ å»çœ‹æ’åºç®—æ³•çš„å®ç°ä¸­ï¼Œæ¯”å¦‚ Java ä¸­ <code>Arrays.sort</code> å°±æ˜¯ç”¨çš„ <code>DualPivotQuicksort</code>ï¼ˆæºç åœ¨<code>java.util.DualPivotQuicksort</code>ä¸­ï¼‰ï¼Œé‡Œé¢å®ç°é€»è¾‘ä¸­ï¼Œå½“æ•°ç»„å¤§å°è¾ƒå°æ—¶ä¹Ÿæ˜¯ç”¨çš„å…¶ä»–å¦‚ $O(n^2)$ çš„æ’å…¥æ’åºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://imgkr.cn-bj.ufileos.com/40f415b6-7074-4f11-a1cb-bc0407397a97.png" alt></p><h2 id="æ´—ç‰Œç®—æ³•çš„åº”ç”¨"><a href="#æ´—ç‰Œç®—æ³•çš„åº”ç”¨" class="headerlink" title="æ´—ç‰Œç®—æ³•çš„åº”ç”¨"></a>æ´—ç‰Œç®—æ³•çš„åº”ç”¨</h2><p><del>è‚åˆ° å‡Œæ™¨ 2 ç‚¹äº†ï¼Œæ˜å¤©ç»§ç»­å†™å§â€¦.</del></p><p><img src="https://static01.imgkr.com/temp/af18db05cc254e0bb50d0917eae1ba78.png" alt="ç¬¬äºŒå¤©ç»§ç»­è‚"></p><p>å›åˆ°æœ¬ç¯‡æ ‡é¢˜è¯´çš„åº”ç”¨åœºæ™¯ä¸Šæ¥ï¼Œæ¯”å¦‚å¼€ç¯‡æåˆ°çš„ Eureka æ³¨å†Œä¸­å¿ƒçš„ Client å°±æ˜¯é€šè¿‡æŠŠserver çš„ IPList æ‰“ä¹±é¡ºåºï¼Œç„¶åæŒ¨ä¸ªå–æ¥å®ç°ç†è®ºä¸Šçš„å‡åŒ€çš„è´Ÿè½½å‡è¡¡ã€‚</p><p>ä»£ç ï¼ˆåœ¨ github: Netflix/eureka ä¸­ï¼Œå…¬ä¼—å·å°±ä¸å•ç‹¬è´´å‡ºæ¥äº†ï¼‰åœ¨è¿™é‡Œ<a href="https://github.com/Netflix/eureka/blob/dad077108c54041a41add075c0e373783a173e2a/eureka-client/src/main/java/com/netflix/discovery/shared/resolver/ResolverUtils.java" target="_blank" rel="noopener"><code>com.netflix.discovery.shared.resolver.ResolverUtils</code></a>ã€‚çœ‹ä»£ç å¦‚ä¸‹ï¼Œæ˜¯ä¸æ˜¯è·Ÿå‰æ–‡çš„ç®—æ³•å·®ä¸å¤šï¼Ÿï¼ˆå…·ä½“å†™æ³•ä¸ä¸€æ ·è€Œå·²ï¼‰</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends EurekaEndpoint&gt; <span class="function">List&lt;T&gt; <span class="title">randomize</span><span class="params">(List&lt;T&gt; list)</span> </span>&#123;</span><br><span class="line">    List&lt;T&gt; randomList = <span class="keyword">new</span> ArrayList&lt;&gt;(list);</span><br><span class="line">    <span class="keyword">if</span> (randomList.size() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> randomList;</span><br><span class="line">    &#125;</span><br><span class="line">    Random random = <span class="keyword">new</span> Random(LOCAL_IPV4_ADDRESS.hashCode());</span><br><span class="line">    <span class="keyword">int</span> last = randomList.size() - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; last; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> pos = random.nextInt(randomList.size() - i);</span><br><span class="line">        <span class="keyword">if</span> (pos != i) &#123;</span><br><span class="line">            Collections.swap(randomList, i, pos);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> randomList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ï¼Œåœ¨ä»»ä½•éœ€è¦æ‰“ä¹±é¡ºåºçš„åœºæ™¯é‡Œé¢éƒ½å¯ä»¥ç”¨è¿™ä¸ªç®—æ³•ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œæ’­æ”¾å™¨ä¸€èˆ¬éƒ½æœ‰éšæœºæ’­æ”¾çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ä½ è‡ªå·±æœ‰ä¸ªæ­Œå• listï¼Œä½†æƒ³éšæœºæ’­æ”¾é‡Œé¢çš„æ­Œæ›²ï¼Œå°±ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•æ¥å®ç°ã€‚</p><p>è¿˜æœ‰ï¼Œå°±æ¯”å¦‚åå­—ä¸­çš„â€œæ´—ç‰Œâ€ï¼Œé‚£äº›æ£‹ç‰Œç±»çš„æ¸¸æˆï¼Œå½“ç„¶ä¼šç”¨åˆ°åå‰¯å…¶å®çš„â€œæ´—ç‰Œâ€ç®—æ³•äº†ã€‚å…¶å®åœ¨å„ç§æ¸¸æˆçš„éšæœºåœºæ™¯ä¸­åº”è¯¥éƒ½å¯ä»¥ç”¨è¿™ä¸ªç®—æ³•çš„ã€‚â€‹</p><h2 id="æ‰©å±•ä¸€ä¸‹ï¼Œç•™é“ä½œä¸šé¢˜"><a href="#æ‰©å±•ä¸€ä¸‹ï¼Œç•™é“ä½œä¸šé¢˜" class="headerlink" title="æ‰©å±•ä¸€ä¸‹ï¼Œç•™é“ä½œä¸šé¢˜"></a>æ‰©å±•ä¸€ä¸‹ï¼Œç•™é“ä½œä¸šé¢˜</h2><p>è·Ÿè¿™ä¸ªé—®é¢˜ç±»ä¼¼çš„ï¼Œè¿˜æœ‰ä¸€äº›å¸¸è§çš„é¢è¯•é¢˜ï¼Œæœ¬äººä¹‹å‰å°è±¡ä¸­ä¹Ÿè¢«é—®åˆ°è¿‡ï¼ˆçŸ³å¤´ç‰¹åœ°å»ç¿»äº†ç¿»å½“å¹´æ ¡æ‹›ç­‰æ‰¾å·¥ä½œçš„æ—¶å€™æ”¶é›†å’Œç§¯ç´¯çš„é¢è¯•é¢˜é›†ï¼‰ã€‚</p><p>ä»¥ä¸‹é¢˜ç›®æ¥æºäºç½‘ç»œï¼Œå› ä¸ºæ˜¯å½“åˆå‡†å¤‡é¢è¯•æ—¶å€™æ”¶é›†çš„ï¼Œå…·ä½“æ¥æºä¸è¯¦äº†ã€‚â€‹</p><p><img src="https://static01.imgkr.com/temp/1b20066375134f39a913fcfba34690bd.png" alt="åŠ¨åŠ¨è„‘ç­‹ï¼Œæ€è€ƒä¸€ä¸‹"></p><h3 id="é¢˜ç›®-1"><a href="#é¢˜ç›®-1" class="headerlink" title="é¢˜ç›® 1"></a>é¢˜ç›® 1</h3><p>ç»™ä½ ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œè®¾è®¡ä¸€ä¸ªç®—æ³•éšæœºä»æ–‡æœ¬æ–‡ä»¶ä¸­æŠ½å–ä¸€è¡Œï¼Œè¦ä¿è¯æ¯è¡Œè¢«æŠ½å–åˆ°çš„æ¦‚ç‡ä¸€æ ·ã€‚ </p><p>æœ€ç®€å•çš„æ€è·¯å…¶å®å°±æ˜¯ï¼šå…ˆæŠŠæ–‡ä»¶æ¯ä¸€è¡Œè¯»å–å‡ºæ¥ï¼Œå‡è®¾æœ‰ <code>n</code> è¡Œï¼Œè¿™ä¸ªæ—¶å€™éšæœºä» <code>1-n</code>ç”Ÿæˆä¸€ä¸ªæ•°ï¼Œè¯»å–å¯¹åº”çš„è¡Œå³å¯ã€‚ </p><p>è¿™ç§æ–¹æ³•å½“ç„¶å¯ä»¥è§£å†³ï¼Œå’±ä»¬åŠ æ·±ä¸€ä¸‹éš¾åº¦ï¼Œå‡è®¾æ–‡ä»¶å¾ˆå¤§å¾ˆå¤§å¾ˆå¤§å‘¢ï¼Œæˆ–è€…ç›´æ¥è¦æ±‚åªèƒ½éå†è¯¥æ–‡ä»¶å†…å®¹ä¸€éï¼Œæ€ä¹ˆåšåˆ°å‘¢ï¼Ÿ</p><h3 id="é¢˜ç›®-2"><a href="#é¢˜ç›®-2" class="headerlink" title="é¢˜ç›® 2"></a>é¢˜ç›® 2</h3><p>å…¶å®é¢˜ç›® 1 è¿˜å¯ä»¥æ‰©å±•ä¸€ä¸‹ï¼Œä¸æ˜¯é€‰æ‹© 1 è¡Œäº†ï¼Œæ˜¯é€‰æ‹© <code>k</code> è¡Œï¼Œåˆåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p><p><img src="https://static01.imgkr.com/temp/243222ae15844d16bdc6ac3d7bd6d037.png" alt></p><p>æœ¬äººæ‰ç–å­¦æµ…ï¼Œå¦‚æœæœ‰ä¸å¯¹çš„åœ°æ–¹ï¼Œè¿˜æœ›å¤§å®¶æŒ‡å‡ºã€‚</p><p>æ¬¢è¿å¤§å®¶ç•™è¨€è®¨è®ºæ–‡æœ«çš„ä¸¤ä¸ªå°é—®é¢˜çš„è§£å†³æ€è·¯å’Œæ–¹æ³•ã€‚</p><p>åŸåˆ›çœŸå¿ƒä¸æ˜“ï¼Œå¸Œæœ›ä½ èƒ½å¸®æˆ‘ä¸ªå°å¿™å‘—ï¼Œå¦‚æœæœ¬æ–‡å†…å®¹ä½ è§‰å¾—æœ‰æ‰€å¯å‘ï¼Œæœ‰æ‰€æ”¶è·ï¼Œè¯·å¸®å¿™ç‚¹ä¸ªâ€œåœ¨çœ‹â€å‘—ï¼Œæˆ–è€…è½¬å‘åˆ†äº«è®©æ›´å¤šçš„å°ä¼™ä¼´çœ‹åˆ°ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ‰ä¸€æ¬¡å‚åŠ é¢è¯•ï¼Œé¢è¯•å®˜é—®æˆ‘ï¼šâ€œä¼šç©ç‰Œå§ï¼Ÿâ€&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://static01.imgkr.com/temp/3dd28e16a9ae45858913c98be35c4d76.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;å†…å¿ƒï¼šâ€œå’‹æ»´ï¼Œè¿™æ˜¯è¦ç©å¾·å·æ‰‘å…‹ï¼ˆ
      
    
    </summary>
    
      <category term="MyLife" scheme="https://www.tanglei.name/categories/MyLife/"/>
    
    
      <category term="MyLife" scheme="https://www.tanglei.name/tags/MyLife/"/>
    
  </entry>
  
  <entry>
    <title>è¿™ 10 è¡Œæ¯”è¾ƒå­—ç¬¦ä¸²ç›¸ç­‰çš„ä»£ç ç»™æˆ‘æ•´æ‡µé€¼äº†ï¼Œä¸ä¿¡ä½ ä¹Ÿæ¥çœ‹çœ‹</title>
    <link href="https://www.tanglei.name/blog/timing-attack-of-safe-equals.html"/>
    <id>https://www.tanglei.name/blog/timing-attack-of-safe-equals.html</id>
    <published>2020-06-25T00:00:00.000Z</published>
    <updated>2020-10-11T15:25:42.107Z</updated>
    
    <content type="html"><![CDATA[<p>æŠ±æ­‰ç”¨è¿™ç§æ ‡é¢˜å¸å¼•ä½ ç‚¹è¿›æ¥äº†ï¼Œä¸è¿‡ä½ ä¸å¦¨çœ‹å®Œï¼Œçœ‹çœ‹èƒ½å¦è®©ä½ æœ‰æ‰€æ”¶è·ã€‚â€‹ï¼ˆæœ‰æ”¶è·ï¼Œè¯·è¯„è®ºåŒºç•™ä¸ªè¨€ï¼Œæ²¡æ”¶è·ï¼Œä¸‹å‘¨æœ«æˆ‘ç›´æ’­åƒ**ï¼Œå“ˆå“ˆï¼Œè¿™ä½ ä¹Ÿä¿¡ï¼‰</p><blockquote><p>è¡¥å……è¯´æ˜ï¼šå¾®ä¿¡å…¬ä¼—å·æ”¹ç‰ˆï¼Œå¯¹å„ä¸ªå·ä¸»å½±å“è¿˜æŒºå¤§çš„ã€‚ç›®å‰ä»åå°æ•°æ®æ¥çœ‹ï¼Œå¯¹æˆ‘å½±å“ä¸å¤§ï¼Œå› ä¸ºæˆ‘è¿™åæ­£éƒ½æ˜¯å°å·ï¼ŒğŸ˜‚é˜…è¯»é‡æœ¬èº«å°±å°‘çš„å¯æ€œï¼ŒçœŸç›¸äº†ï¼ŒğŸ¶ç‹—å¤´ï¼ˆåˆšä»äº¤æµç¾¤å­¦ä¼šçš„è¡¨æƒ…ï¼‰ã€‚</p></blockquote><p>å…ˆç›´æ¥ä¸Šä»£ç ï¼š </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">safeEqual</span><span class="params">(String a, String b)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (a.length() != b.length()) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">int</span> equal = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; a.length(); i++) &#123;</span><br><span class="line">       equal |= a.charAt(i) ^ b.charAt(i);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> equal == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æ˜¯æˆ‘æ ¹æ®åŸç‰ˆï¼ˆ<code>Scala</code>ï¼‰ç¿»è¯‘æˆ <code>Java</code>çš„ï¼Œ<code>Scala</code> ç‰ˆæœ¬ï¼ˆæœ€å¼€å§‹å¸å¼•ç¨‹åºçŒ¿çŸ³å¤´æ³¨æ„åŠ›çš„ä»£ç ï¼‰å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">safeEqual</span></span>(a: <span class="type">String</span>, b: <span class="type">String</span>) = &#123;</span><br><span class="line">  <span class="keyword">if</span> (a.length != b.length) &#123;</span><br><span class="line">    <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> equal = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> (i &lt;- <span class="type">Array</span>.range(<span class="number">0</span>, a.length)) &#123;</span><br><span class="line">      equal |= a(i) ^ b(i)</span><br><span class="line">    &#125;</span><br><span class="line">    equal == <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆšå¼€å§‹çœ‹åˆ°è¿™æ®µæºç æ„Ÿè§‰æŒºå¥‡æ€ªçš„ï¼Œè¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æ˜¯æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ï¼Œé¦–å…ˆâ€œé•¿åº¦ä¸ç­‰ç»“æœè‚¯å®šä¸ç­‰ï¼Œç«‹å³è¿”å›â€è¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚</p><p>å†çœ‹çœ‹åé¢çš„ï¼Œç¨å¾®åŠ¨ä¸‹è„‘ç­‹ï¼Œè½¬å¼¯ä¸‹ä¹Ÿèƒ½æ˜ç™½è¿™å…¶ä¸­çš„é—¨é“ï¼šé€šè¿‡å¼‚æˆ–æ“ä½œ<code>1^1=0, 1^0=1, 0^0=0</code>ï¼Œæ¥æ¯”è¾ƒæ¯ä¸€ä½ï¼Œå¦‚æœæ¯ä¸€ä½éƒ½ç›¸ç­‰çš„è¯ï¼Œä¸¤ä¸ªå­—ç¬¦ä¸²è‚¯å®šç›¸ç­‰ï¼Œæœ€åå­˜å‚¨ç´¯è®¡å¼‚æˆ–å€¼çš„å˜é‡<code>equal</code>å¿…å®šä¸º 0ï¼Œå¦åˆ™ä¸º 1ã€‚</p><h2 id="å†ç»†æƒ³ä¸€ä¸‹å‘¢ï¼Ÿ"><a href="#å†ç»†æƒ³ä¸€ä¸‹å‘¢ï¼Ÿ" class="headerlink" title="å†ç»†æƒ³ä¸€ä¸‹å‘¢ï¼Ÿ"></a>å†ç»†æƒ³ä¸€ä¸‹å‘¢ï¼Ÿ</h2><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (i &lt;- <span class="type">Array</span>.range(<span class="number">0</span>, a.length)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (a(i) ^ b(i) != <span class="number">0</span>) <span class="comment">// or a(i) != b[i]</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¸¸å¸¸è®²æ€§èƒ½ä¼˜åŒ–ï¼Œä»æ•ˆç‡è§’åº¦ä¸Šè®²ï¼Œéš¾é“ä¸æ˜¯åº”è¯¥åªè¦ä¸­é€”å‘ç°æŸä¸€ä½çš„ç»“æœä¸åŒäº†ï¼ˆå³ä¸º1ï¼‰å°±å¯ä»¥ç«‹å³è¿”å›ä¸¤ä¸ªå­—ç¬¦ä¸²ä¸ç›¸ç­‰äº†å—ï¼Ÿ(å¦‚ä¸Šæ‰€ç¤º) </p><p>è¿™å…¶ä¸­è‚¯å®šæœ‰â€¦â€¦</p><p><img src="https://imgkr.cn-bj.ufileos.com/0d90724a-9e67-42ff-9db5-53453fba1abf.png" alt></p><h2 id="å†å†ç»†æƒ³ä¸€ä¸‹å‘¢ï¼Ÿ"><a href="#å†å†ç»†æƒ³ä¸€ä¸‹å‘¢ï¼Ÿ" class="headerlink" title="å†å†ç»†æƒ³ä¸€ä¸‹å‘¢ï¼Ÿ"></a>å†å†ç»†æƒ³ä¸€ä¸‹å‘¢ï¼Ÿ</h2><p>ç»“åˆæ–¹æ³•åç§° <code>safeEquals</code> å¯èƒ½çŸ¥é“äº›çœ‰ç›®ï¼Œä¸å®‰å…¨æœ‰å…³ã€‚</p><blockquote><p>æœ¬æ–‡å¼€ç¯‡çš„ä»£ç æ¥è‡ªplayframewok é‡Œç”¨æ¥éªŒè¯cookie(session)ä¸­çš„æ•°æ®æ˜¯å¦åˆæ³•(åŒ…å«ç­¾åçš„éªŒè¯)ï¼Œä¹Ÿæ˜¯çŸ³å¤´å†™è¿™ç¯‡æ–‡ç« çš„ç”±æ¥ã€‚</p></blockquote><p>ä»¥å‰çŸ¥é“é€šè¿‡å»¶è¿Ÿè®¡ç®—ç­‰æ‰‹æ®µæ¥æé«˜æ•ˆç‡çš„æ‰‹æ®µï¼Œä½†è¿™ç§å·²ç»ç®—å‡ºç»“æœå´å»¶è¿Ÿè¿”å›çš„ï¼Œè¿˜æ˜¯å¤´ä¸€å›ï¼</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹ï¼ŒJDK ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ä»£ç æ‘˜è‡ª <code>java.security.MessageDigest</code>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isEqual</span><span class="params">(<span class="keyword">byte</span>[] digesta, <span class="keyword">byte</span>[] digestb)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (digesta == digestb) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   <span class="keyword">if</span> (digesta == <span class="keyword">null</span> || digestb == <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (digesta.length != digestb.length) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">   <span class="comment">// time-constant comparison</span></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; digesta.length; i++) &#123;</span><br><span class="line">       result |= digesta[i] ^ digestb[i];</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> result == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹æ³¨é‡ŠçŸ¥é“äº†ï¼Œç›®çš„æ˜¯ä¸ºäº†ç”¨å¸¸é‡æ—¶é—´å¤æ‚åº¦è¿›è¡Œæ¯”è¾ƒã€‚</p><p>ä½†è¿™ä¸ªè®¡ç®—è¿‡ç¨‹è€—è´¹çš„æ—¶é—´ä¸æ˜¯å¸¸é‡æœ‰å•¥é£é™©ï¼Ÿ ï¼ˆè„‘æµ·é‡Œå“èµ·äº†èƒŒæ™¯éŸ³ä¹ï¼šâ€œå°æœ‹å‹ï¼Œä½ æ˜¯å¦æœ‰å¾ˆå¤šé—®å·ï¼Ÿâ€ï¼‰</p><p><img src="https://imgkr.cn-bj.ufileos.com/327a7a80-6fd7-4b4f-b836-78fc9399ce34.png" alt></p><h2 id="çœŸç›¸å¤§ç™½"><a href="#çœŸç›¸å¤§ç™½" class="headerlink" title="çœŸç›¸å¤§ç™½"></a>çœŸç›¸å¤§ç™½</h2><p>å†æ·±å…¥æ¢ç´¢å’Œäº†è§£äº†ä¸€ä¸‹ï¼ŒåŸæ¥è¿™ä¹ˆåšæ˜¯ä¸ºäº†é˜²æ­¢<strong>è®¡æ—¶æ”»å‡»</strong>ï¼ˆTiming Attackï¼‰ã€‚ï¼ˆä¹Ÿæœ‰äººç¿»è¯‘æˆæ—¶åºæ”»å‡»â€‹ï¼‰â€‹</p><p><img src="https://imgkr.cn-bj.ufileos.com/43ae6be8-c869-4bfa-bab9-77435893afb4.png" alt></p><h2 id="è®¡æ—¶æ”»å‡»-Timing-Attack"><a href="#è®¡æ—¶æ”»å‡»-Timing-Attack" class="headerlink" title="è®¡æ—¶æ”»å‡»(Timing Attack)"></a>è®¡æ—¶æ”»å‡»(Timing Attack)</h2><p>è®¡æ—¶æ”»å‡»æ˜¯è¾¹ä¿¡é“æ”»å‡»(æˆ–ç§°â€ä¾§ä¿¡é“æ”»å‡»â€ï¼Œ Side Channel Attackï¼Œ ç®€ç§°SCA) çš„ä¸€ç§ï¼Œè¾¹ä¿¡é“æ”»å‡»æ˜¯ä¸€ç§é’ˆå¯¹è½¯ä»¶æˆ–ç¡¬ä»¶è®¾è®¡ç¼ºé™·ï¼Œèµ°â€œæ­ªé—¨é‚ªé“â€çš„ä¸€ç§æ”»å‡»æ–¹å¼ã€‚</p><p>è¿™ç§æ”»å‡»æ–¹å¼æ˜¯é€šè¿‡åŠŸè€—ã€æ—¶åºã€ç”µç£æ³„æ¼ç­‰æ–¹å¼è¾¾åˆ°ç ´è§£ç›®çš„ã€‚åœ¨å¾ˆå¤šç‰©ç†éš”ç»çš„ç¯å¢ƒä¸­ï¼Œå¾€å¾€ä¹Ÿèƒ½å‡ºå¥‡åˆ¶èƒœï¼Œè¿™ç±»æ–°å‹æ”»å‡»çš„æœ‰æ•ˆæ€§<strong>è¿œé«˜äº</strong>ä¼ ç»Ÿçš„å¯†ç åˆ†æçš„æ•°å­¦æ–¹æ³•ï¼ˆæŸç™¾ç§‘ä¸Šè¯´çš„ï¼‰ã€‚</p><p>è¿™ç§æ‰‹æ®µå¯ä»¥è®©è°ƒç”¨ <code>safeEquals(&quot;abcdefghijklmn&quot;, &quot;xbcdefghijklmn&quot;)</code> ï¼ˆåªæœ‰é¦–ä½ä¸ç›¸åŒï¼‰å’Œè°ƒç”¨ <code>safeEquals(&quot;abcdefghijklmn&quot;, &quot;abcdefghijklmn&quot;)</code> ï¼ˆä¸¤ä¸ªå®Œå…¨ç›¸åŒçš„å­—ç¬¦ä¸²ï¼‰çš„æ‰€è€—è´¹çš„æ—¶é—´ä¸€æ ·ã€‚é˜²æ­¢é€šè¿‡å¤§é‡çš„æ”¹å˜è¾“å…¥å¹¶é€šè¿‡ç»Ÿè®¡è¿è¡Œæ—¶é—´æ¥æš´åŠ›ç ´è§£å‡ºè¦æ¯”è¾ƒçš„å­—ç¬¦ä¸²ã€‚ </p><p>ä¸¾ä¸ªğŸŒ°ï¼Œå¦‚æœç”¨ä¹‹å‰è¯´çš„â€œé«˜æ•ˆâ€çš„æ–¹å¼æ¥å®ç°çš„è¯ã€‚å‡è®¾æŸä¸ªç”¨æˆ·è®¾ç½®äº†å¯†ç ä¸º <code>password</code>ï¼Œé€šè¿‡ä»aåˆ°zï¼ˆå®é™…èŒƒå›´å¯èƒ½æ›´å¹¿ï¼‰ä¸æ–­æšä¸¾ç¬¬ä¸€ä½ï¼Œæœ€ç»ˆç»Ÿè®¡å‘ç° <code>p0000000</code> çš„è¿è¡Œæ—¶é—´æ¯”å…¶ä»–ä»ä»»æ„<code>a~z</code>çš„éƒ½é•¿ï¼ˆå› ä¸ºè¦åˆ°ç¬¬äºŒä½æ‰èƒ½å‘ç°ä¸åŒï¼Œå…¶ä»–é <code>p</code> å¼€å¤´çš„å­—ç¬¦ä¸²ç¬¬ä¸€ä½ä¸åŒå°±ç›´æ¥è¿”å›äº†ï¼‰ï¼Œè¿™æ ·å°±èƒ½çŒœæµ‹å‡ºç”¨æˆ·å¯†ç çš„ç¬¬ä¸€ä½å¾ˆå¯èƒ½æ˜¯<code>p</code>äº†ï¼Œç„¶åå†ä¸æ–­ä¸€ä½ä¸€ä½è¿­ä»£ä¸‹å»æœ€ç»ˆç ´è§£å‡ºç”¨æˆ·çš„å¯†ç ã€‚</p><p>å½“ç„¶ï¼Œä»¥ä¸Šæ˜¯ä»ç†è®ºè§’åº¦åˆ†æï¼Œç¡®å®å®¹æ˜“ç†è§£ã€‚ä½†å®é™…ä¸Šå¥½åƒé€šè¿‡ç»Ÿè®¡è¿è¡Œæ—¶é—´æ€»æ„Ÿè§‰ä¸å¤ªé è°±ï¼Œè¿™ä¸ªè¿è¡Œæ—¶é—´å¯¹ç¯å¢ƒå¤ªæ•æ„Ÿäº†ï¼Œæ¯”å¦‚ç½‘ç»œï¼Œå†…å­˜ï¼ŒCPUè´Ÿè½½ç­‰ç­‰éƒ½ä¼šå½±å“ã€‚</p><p>ä½†å®‰å…¨é—®é¢˜æ„Ÿè§‰æ›´åƒæ˜¯ â€œå®å¯ä¿¡å…¶æœ‰ï¼Œä¸å¯ä¿¡å…¶æ— â€ã€‚ä¸ºäº†é˜²æ­¢(ç‰¹åˆ«æ˜¯ä¸ç­¾å/å¯†ç éªŒè¯ç­‰ç›¸å…³çš„æ“ä½œ)è¢« <strong>timing attack</strong>ï¼Œç›®å‰å„å¤§è¯­è¨€éƒ½æä¾›äº†ç›¸åº”çš„å®‰å…¨æ¯”è¾ƒå‡½æ•°ã€‚å„ç§è½¯ä»¶ç³»ç»Ÿï¼ˆä¾‹å¦‚ OpenSSLï¼‰ã€æ¡†æ¶ï¼ˆä¾‹å¦‚ Playï¼‰çš„å®ç°ä¹Ÿéƒ½é‡‡ç”¨äº†è¿™ç§æ–¹å¼ã€‚ </p><p>ä¾‹å¦‚ â€œä¸–ç•Œä¸Šæœ€å¥½çš„ç¼–ç¨‹è¯­è¨€â€ï¼ˆç²‰ä¸è¾ƒå°‘ï¼Œè¯„è®ºåŒºåº”è¯¥æ‰“ä¸èµ·æ¶æ¥ï¼‰â€”â€” phpä¸­çš„: </p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Compares two strings using the same time whether they're equal or not.</span></span><br><span class="line"><span class="comment">// This function should be used to mitigate timing attacks; </span></span><br><span class="line"><span class="comment">// for instance, when testing crypt() password hashes.</span></span><br><span class="line">bool hash_equals ( string $known_string , string $user_string )</span><br><span class="line"></span><br><span class="line"><span class="comment">//This function is safe against timing attacks.</span></span><br><span class="line">boolean password_verify ( string $password , string $hash )</span><br></pre></td></tr></table></figure><p>å…¶å®å„ç§è¯­è¨€ç‰ˆæœ¬çš„å®ç°æ–¹å¼éƒ½ä¸ä¸Šé¢çš„ç‰ˆæœ¬å·®ä¸å¤šï¼Œå°†ä¸¤ä¸ªå­—ç¬¦ä¸²æ¯ä¸€ä½å–å‡ºæ¥å¼‚æˆ–(<code>^</code>)å¹¶ç”¨æˆ–(<code>|</code>)ä¿å­˜ï¼Œæœ€åé€šè¿‡åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º 0 æ¥ç¡®å®šä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ã€‚ </p><p>å¦‚æœåˆšå¼€å§‹æ²¡æœ‰ç”¨ <code>safeEquals</code> å»å®ç°ï¼Œåç»­çš„ç‰ˆæœ¬è¿˜ä¼šé€šè¿‡æ‰“è¡¥ä¸çš„æ–¹å¼å»ä¿®å¤è¿™æ ·çš„å®‰å…¨éšæ‚£ã€‚  </p><p>ä¾‹å¦‚ <a href="http://www.oracle.com/technetwork/java/javase/6u17-141447.html" title="Release Notes" target="_blank" rel="noopener">JDK 1.6.0_17 ä¸­çš„Release Notes</a>ä¸­å°±æåˆ°äº†<code>MessageDigest.isEqual</code> ä¸­çš„bugçš„ä¿®å¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static01.imgkr.com/temp/7e264b6f9f6141e9a779f07bd29ebd64.png" alt="MessageDigest timing attack vulnerabilities"></p><p>å¤§å®¶å¯ä»¥çœ‹çœ‹è¿™æ¬¡å˜æ›´çš„çš„è¯¦ç»†ä¿¡æ¯<a href="http://hg.openjdk.java.net/jdk6/jdk6/jdk/rev/562da0baf70b" title="openjdkä¸­çš„ bug fix diff" target="_blank" rel="noopener">openjdkä¸­çš„ bug fix diff</a>ä¸ºï¼š</p><p><img src="https://static01.imgkr.com/temp/87adf41576964e8bafb2abf48c6a95ab.png" alt="MessageDigest.isEqualè®¡æ—¶æ”»å‡»"></p><h2 id="Timing-Attack-çœŸçš„å¯è¡Œå—ï¼Ÿ"><a href="#Timing-Attack-çœŸçš„å¯è¡Œå—ï¼Ÿ" class="headerlink" title="Timing Attack çœŸçš„å¯è¡Œå—ï¼Ÿ"></a>Timing Attack çœŸçš„å¯è¡Œå—ï¼Ÿ</h2><p>æˆ‘è§‰å¾—å„å¤§è¯­è¨€çš„ API éƒ½ç”¨è¿™ç§å®ç°ï¼Œè‚¯å®šè¿˜æ˜¯æœ‰é“ç†çš„ï¼Œç†è®ºä¸Šåº”è¯¥å¯ä»¥è¢«åˆ©ç”¨çš„ã€‚<br>è¿™ä¸ï¼Œå­¦æœ¯ç•Œçš„è¿™ç¯‡è®ºæ–‡å°±å®£ç§°ç”¨è¿™ç§è®¡æ—¶æ”»å‡»çš„æ–¹æ³•ç ´è§£äº† <code>OpenSSL 0.9.7</code> çš„RSAåŠ å¯†ç®—æ³•äº†ã€‚å…³äº <a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=100000109&amp;idx=1&amp;sn=e65143adf4f81cc5c559b03c58d029e9&amp;chksm=6b4700895c30899f6148025c6120844bd0aeb2d09413ad4ece33f2ea49296fa6f54d17447f63#rd" target="_blank" rel="noopener">RSA ç®—æ³•çš„ä»‹ç»</a>å¯ä»¥çœ‹çœ‹ä¹‹å‰æœ¬äººå†™çš„è¿™ç¯‡æ–‡ç« ã€‚ </p><p>è¿™ç¯‡<a href="http://crypto.stanford.edu/~dabo/papers/ssl-timing.pdf" title="Remote Timing Attacks are Practical" target="_blank" rel="noopener">Remote Timing Attacks are Practical</a> è®ºæ–‡ä¸­æŒ‡å‡ºï¼ˆæˆ‘å¤§è‡´ç¿»è¯‘ä¸‹æ‘˜è¦ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é€šè¿‡æ–‡æœ«é“¾æ¥å»çœ‹åŸæ–‡ï¼‰ï¼š</p><p>è®¡æ—¶æ”»å‡»å¾€å¾€ç”¨äºæ”»å‡»ä¸€äº›æ€§èƒ½è¾ƒå¼±çš„è®¡ç®—è®¾å¤‡ï¼Œä¾‹å¦‚ä¸€äº›æ™ºèƒ½å¡ã€‚æˆ‘ä»¬é€šè¿‡å®éªŒå‘ç°ï¼Œä¹Ÿèƒ½ç”¨äºæ”»å‡»æ™®é€šçš„è½¯ä»¶ç³»ç»Ÿã€‚æœ¬æ–‡é€šè¿‡å®éªŒè¯æ˜ï¼Œé€šè¿‡è¿™ç§è®¡æ—¶æ”»å‡»æ–¹å¼èƒ½å¤Ÿæ”»ç ´ä¸€ä¸ªåŸºäº OpenSSL çš„ web æœåŠ¡å™¨çš„ç§é’¥ã€‚ç»“æœè¯æ˜è®¡æ—¶æ”»å‡»ç”¨äºè¿›è¡Œç½‘ç»œæ”»å‡»åœ¨å®è·µä¸­å¯è¡Œçš„ï¼Œå› æ­¤å„å¤§å®‰å…¨ç³»ç»Ÿéœ€è¦æŠµå¾¡è¿™ç§é£é™©ã€‚</p><p>æœ€åï¼Œæœ¬äººæ¯•ç«Ÿä¸æ˜¯ä¸“ç ”å®Œå…¨æ–¹å‘ï¼Œä»¥ä¸Šæè¿°æ˜¯åŸºäºæœ¬äººçš„ç†è§£ï¼Œå¦‚æœæœ‰ä¸å¯¹çš„åœ°æ–¹ï¼Œè¿˜è¯·å¤§å®¶ç•™è¨€æŒ‡å‡ºæ¥ã€‚æ„Ÿè°¢ã€‚</p><blockquote><p>è¡¥å……è¯´æ˜2ï¼šæ„Ÿè°¢æ­£åœ¨é˜…è¯»æ–‡ç« çš„ä½ ï¼Œè®©æˆ‘è¿˜æœ‰åŠ¨åŠ›ç»§ç»­åšæŒæ›´æ–°åŸåˆ›ã€‚</p><p>æœ¬äººå‘æ–‡ä¸å¤šï¼Œä½†å¸Œæœ›å†™çš„æ–‡ç« èƒ½è¾¾åˆ°çš„ç›®çš„æ˜¯ï¼šå ç”¨ä½ çš„é˜…è¯»æ—¶é—´ï¼Œå°±å°½é‡èƒ½å¤Ÿè®©ä½ æœ‰æ‰€æ”¶è·ã€‚</p><p>å¦‚æœä½ è§‰å¾—æˆ‘çš„æ–‡ç« æœ‰æ‰€å¸®åŠ©ï¼Œè¿˜è¯·ä½ å¸®å¿™è½¬å‘åˆ†äº«ï¼Œå¦å¤–è¯·åˆ«å¿˜äº†ç‚¹å‡»å…¬ä¼—å·å³ä¸Šè§’åŠ ä¸ªæ˜Ÿæ ‡ï¼Œå¥½è®©ä½ åˆ«é”™è¿‡åç»­çš„ç²¾å½©æ–‡ç« ï¼ˆå¾®ä¿¡æ”¹ç‰ˆäº†ï¼Œæˆ–è®¸æˆ‘å‘çš„æ–‡ç« éƒ½ä¸èƒ½æ¨é€åˆ°ä½ é‚£äº†ï¼‰ã€‚</p></blockquote><p>â€‹åŸåˆ›çœŸå¿ƒä¸æ˜“ï¼Œå¸Œæœ›ä½ èƒ½å¸®æˆ‘ä¸ªå°å¿™å‘—ï¼Œå¦‚æœæœ¬æ–‡å†…å®¹ä½ è§‰å¾—æœ‰æ‰€å¯å‘ï¼Œæœ‰æ‰€æ”¶è·ï¼Œè¯·å¸®å¿™ç‚¹ä¸ªâ€œåœ¨çœ‹â€å‘—ï¼Œæˆ–è€…è½¬å‘åˆ†äº«è®©æ›´å¤šçš„å°ä¼™ä¼´çœ‹åˆ°ã€‚<br>â€‹<br>å‚è€ƒèµ„æ–™ï¼š</p><ul><li><a href="http://www.cs.sjsu.edu/faculty/stamp/students/article.html" target="_blank" rel="noopener">Timing Attacks on RSA: Revealing Your Secrets through the Fourth Dimension</a></li><li><a href="http://crypto.stanford.edu/~dabo/papers/ssl-timing.pdf" target="_blank" rel="noopener">Remote Timing Attacks are Practical</a> </li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æŠ±æ­‰ç”¨è¿™ç§æ ‡é¢˜å¸å¼•ä½ ç‚¹è¿›æ¥äº†ï¼Œä¸è¿‡ä½ ä¸å¦¨çœ‹å®Œï¼Œçœ‹çœ‹èƒ½å¦è®©ä½ æœ‰æ‰€æ”¶è·ã€‚â€‹ï¼ˆæœ‰æ”¶è·ï¼Œè¯·è¯„è®ºåŒºç•™ä¸ªè¨€ï¼Œæ²¡æ”¶è·ï¼Œä¸‹å‘¨æœ«æˆ‘ç›´æ’­åƒ**ï¼Œå“ˆå“ˆï¼Œè¿™ä½ ä¹Ÿä¿¡ï¼‰&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;è¡¥å……è¯´æ˜ï¼šå¾®ä¿¡å…¬ä¼—å·æ”¹ç‰ˆï¼Œå¯¹å„ä¸ªå·ä¸»å½±å“è¿˜æŒºå¤§çš„ã€‚ç›®å‰ä»åå°æ•°æ®æ¥çœ‹ï¼Œå¯¹æˆ‘å½±å“ä¸å¤§ï¼Œå› ä¸ºæˆ‘è¿™
      
    
    </summary>
    
      <category term="MyLife" scheme="https://www.tanglei.name/categories/MyLife/"/>
    
    
      <category term="ç½‘ç»œå®‰å…¨" scheme="https://www.tanglei.name/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/"/>
    
      <category term="ç»éªŒæŠ€å·§" scheme="https://www.tanglei.name/tags/%E7%BB%8F%E9%AA%8C%E6%8A%80%E5%B7%A7/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€è¡Œä»£ç å¼•æ¥çš„å®‰å…¨æ¼æ´å°±è®©æˆ‘ä»¬ä¸¢å¤±äº†æ•´ä¸ªæœåŠ¡å™¨çš„æ§åˆ¶æƒ</title>
    <link href="https://www.tanglei.name/blog/a-security-vulnerability-of-spring-validator.html"/>
    <id>https://www.tanglei.name/blog/a-security-vulnerability-of-spring-validator.html</id>
    <published>2020-05-24T00:00:00.000Z</published>
    <updated>2020-10-11T15:25:42.107Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰åœ¨æŸå‚çš„æŸæ¬¡é¡¹ç›®å¼€å‘ä¸­ï¼Œé¡¹ç›®ç»„åŒå­¦è®¾è®¡å’Œå®ç°äº†ä¸€ä¸ªâ€œå¼•ä»¥ä¸ºå‚²â€ï¼Œé¢ï¼Œæœ‰ç‚¹æ‰©å¼ ï¼Œä¸è¿‡è‡ªè®¤ä¸ºè¿˜è¯´å¾—è¿‡å»çš„ featureï¼Œç»“æœä¸´ä¸Šçº¿å‰è¢«å•ªå•ªæ‰“è„¸ï¼Œå› ä¸ºå®ç°è¿‡ç¨‹ä¸­å› ä¸º<strong>ä¸€è¡Œä»£ç </strong>ï¼ˆæ²¡æœ‰æ ‡é¢˜å…šï¼ŒçœŸçš„æ˜¯ä¸€è¡Œä»£ç ï¼‰å¸¦æ¥çš„å®‰å…¨æ¼æ´è®©æˆ‘ä»¬ä¸¢å¤±äº†æ•´ä¸ªæœåŠ¡å™¨æ§åˆ¶æƒï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰ã€‚å¤šäºäº†ä¸Šçº¿ä¹‹å‰æœ‰å…¬å¸å®‰å…¨å›¢é˜Ÿçš„äººä¼šå¯¹ä»£ç è¿›è¡Œæ‰«æï¼Œæ‰è®©è¿™ä¸ªæ¼æ´è¢«æ‰¼æ€åœ¨æ‘‡ç¯®é‡Œã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±ä¸€èµ·æ¥çœ‹çœ‹è¿™ä¸ªäº‹æ•…ï¼Œå•Šï¼Œä¸å¯¹ï¼Œæ˜¯æ•…äº‹ã€‚</p><p><img src="/resources/a-security-vulnerability-of-spring-validator/gif-0.png" alt></p><h2 id="èƒŒæ™¯è¯´æ˜"><a href="#èƒŒæ™¯è¯´æ˜" class="headerlink" title="èƒŒæ™¯è¯´æ˜"></a>èƒŒæ™¯è¯´æ˜</h2><p>æˆ‘ä»¬çš„é¡¹ç›®æ˜¯ä¸€ä¸ªé¢å‘å…¨çƒç”¨æˆ·çš„ Web é¡¹ç›®ï¼Œç”¨ SpringBoot å¼€å‘ã€‚åœ¨é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç¦»ä¸å¼€å„ç§å¼‚å¸¸ä¿¡æ¯çš„å¤„ç†ï¼Œæ¯”å¦‚è¡¨å•æäº¤å‚æ•°ä¸ç¬¦åˆé¢„æœŸï¼Œä¸šåŠ¡é€»è¾‘çš„å¤„ç†æ—¶ç¦»ä¸å¼€å„ç§å¼‚å¸¸ä¿¡æ¯ï¼ˆä¾‹å¦‚ç½‘ç»œæŠ–åŠ¨ç­‰ï¼‰çš„å¤„ç†ã€‚äºæ˜¯åˆ©ç”¨ SpringBoot å„ç§ç°æˆçš„ç»„ä»¶æ”¯æŒï¼Œè®¾è®¡äº†ä¸€ä¸ªç»Ÿä¸€çš„å¼‚å¸¸ä¿¡æ¯å¤„ç†ç»„ä»¶ï¼Œç»Ÿä¸€ç®¡ç†å„ç§ä¸šåŠ¡æµç¨‹ä¸­å¯èƒ½å‡ºç°çš„é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯ï¼Œé€šè¿‡å›½é™…åŒ–çš„èµ„æºé…ç½®æ–‡ä»¶è¿›è¡Œç»Ÿä¸€è¾“å‡ºç»™ç”¨æˆ·ã€‚</p><h3 id="ç»Ÿä¸€é”™è¯¯ä¿¡æ¯é…ç½®ç®¡ç†"><a href="#ç»Ÿä¸€é”™è¯¯ä¿¡æ¯é…ç½®ç®¡ç†" class="headerlink" title="ç»Ÿä¸€é”™è¯¯ä¿¡æ¯é…ç½®ç®¡ç†"></a>ç»Ÿä¸€é”™è¯¯ä¿¡æ¯é…ç½®ç®¡ç†</h3><p>æˆ‘ä»¬çš„ç”¨æˆ·éå¸ƒå…¨çƒï¼Œä¸ºäº†ç»™å„ä¸ªå›½å®¶ç”¨æˆ·æ¯”è¾ƒå¥½çš„ä½“éªŒä¼šè¿›è¡Œä¸åŒçš„ç¿»è¯‘ã€‚å…·ä½“è€Œè¨€ï¼Œå®ç°çš„æ•ˆæœå¦‚ä¸‹ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œä»¥â€œæ‰¾å›ç™»å½•å¯†ç â€è¿™æ ·ä¸€ä¸ªä¸šåŠ¡åœºæ™¯æ¥è¿›è¡Œé˜è¿°è¯´æ˜ã€‚</p><p>å‡è®¾æ‰¾å›å¯†ç æ—¶ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥æ‰‹æœºæˆ–è€…é‚®ç®±éªŒè¯ç ï¼Œå‡è®¾è¿™ä¸ªæ—¶å€™ç”¨æˆ·è¾“å…¥çš„éªŒè¯ç é€šè¿‡åå°æ•°æ®åº“ï¼ˆå¯èƒ½æ˜¯Redisï¼‰å¯¹æ¯”å‘ç°å·²ç»è¿‡æœŸã€‚åœ¨ä¸šåŠ¡ä»£ç ä¸­ï¼Œåªéœ€è¦ç®€å•çš„ <code>throw new ErrorCodeException(ErrorCodes.AUTHCODE_EXPIRED)</code> å³å¯ã€‚å…·ä½“è€Œè¨€ï¼Œé’ˆå¯¹ä¸åŒå›½å®¶åœ°åŒºä¸åŒçš„è¯­è¨€çœ‹åˆ°çš„æ•ˆæœä¸ä¸€æ ·ï¼š</p><ul><li>ä¸­æ–‡ç”¨æˆ·çœ‹åˆ°çš„æç¤ºå°±æ˜¯â€œæ‚¨è¾“å…¥çš„éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–â€ï¼›</li><li>æ¬§ç¾ç”¨æˆ·çœ‹åˆ°çš„æ•ˆæœæ˜¯â€œThe verification code you input is expired, â€¦â€ï¼›</li><li>å¾·å›½ç”¨æˆ·çœ‹åˆ°çš„æ˜¯ï¼šâ€œDer von Ihnen eingegebene Verifizierungscode ist abgelaufen, bitte wiederholenâ€ ã€‚ï¼ˆæˆ‘çæ‰¾çš„ç¿»è¯‘ï¼Œä¸ä¸€å®šå‡†ï¼‰</li><li>â€¦â€¦</li></ul><h3 id="ç»Ÿä¸€é”™è¯¯ä¿¡æ¯é…ç½®ç®¡ç†ä»£ç å®ç°"><a href="#ç»Ÿä¸€é”™è¯¯ä¿¡æ¯é…ç½®ç®¡ç†ä»£ç å®ç°" class="headerlink" title="ç»Ÿä¸€é”™è¯¯ä¿¡æ¯é…ç½®ç®¡ç†ä»£ç å®ç°"></a>ç»Ÿä¸€é”™è¯¯ä¿¡æ¯é…ç½®ç®¡ç†ä»£ç å®ç°</h3><p>å…³é”®ä¿¡æ¯å…¶å®å°±åœ¨äºä¸€ä¸ª GlobalExceptionHandlerï¼Œå¯¹æ‰€æœ‰Controller å…¥å£è¿›è¡Œ AOP æ‹¦æˆªï¼Œæ ¹æ®ä¸åŒçš„é”™è¯¯ä¿¡æ¯ï¼Œè·å–ç›¸åº”èµ„æºæ–‡ä»¶é…ç½®çš„ keyï¼Œå¹¶ä»è¯­è¨€èµ„æºæ–‡ä»¶ä¸­è¯»å–ä¸åŒå›½å®¶çš„é”™è¯¯ç¿»è¯‘ä¿¡æ¯ã€‚ </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(BadRequestException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">handle</span>(<span class="title">HttpServletRequest</span> <span class="title">request</span>, <span class="title">BadRequestException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        String i18message = getI18nMessage(e.getKey(), request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Response.error(e.getCode(), i18message));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(ErrorCodeException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">handle</span>(<span class="title">HttpServletRequest</span> <span class="title">request</span>, <span class="title">ErrorCodeException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        String i18message = getI18nMessage(e.getKey(), request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.OK).body(Response.error(e.getCode(), i18message));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.tanglei.name/resources/custom-validator-and-i18n-error-message-in-springboot/i18n-tree.png" alt="ä¸åŒè¯­è¨€çš„èµ„æºæ–‡ä»¶ç¤ºä¾‹"></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getI18nMessage</span><span class="params">(String key, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> messageSource.getMessage(key, <span class="keyword">null</span>, LanguaggeUtils.currentLocale(request));</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       <span class="comment">// log</span></span><br><span class="line">       <span class="keyword">return</span> key;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¦ç»†ä»£ç å®ç°å¯ä»¥å‚è€ƒæœ¬äººä¹‹å‰å†™çš„è¿™ç¯‡æ–‡ç« <a href="/blog/custom-validator-and-i18n-error-message-in-springboot.html">ä¸€æ–‡æ•™ä½ å®ç° SpringBoot ä¸­çš„è‡ªå®šä¹‰ Validator å’Œé”™è¯¯ä¿¡æ¯å›½é™…åŒ–é…ç½®</a>ï¼Œä¸Šé¢æœ‰é™„å®Œæ•´çš„ä»£ç å®ç°ã€‚</p><h3 id="åŸºäºæ³¨è§£çš„è¡¨å•æ ¡éªŒï¼ˆå«è‡ªå®šä¹‰æ³¨è§£ï¼‰"><a href="#åŸºäºæ³¨è§£çš„è¡¨å•æ ¡éªŒï¼ˆå«è‡ªå®šä¹‰æ³¨è§£ï¼‰" class="headerlink" title="åŸºäºæ³¨è§£çš„è¡¨å•æ ¡éªŒï¼ˆå«è‡ªå®šä¹‰æ³¨è§£ï¼‰"></a>åŸºäºæ³¨è§£çš„è¡¨å•æ ¡éªŒï¼ˆå«è‡ªå®šä¹‰æ³¨è§£ï¼‰</h3><p>è¿˜æœ‰ä¸€ç§å¸¸è§çš„ä¸šåŠ¡åœºæ™¯å°±æ˜¯åç«¯æ¥å£éœ€è¦å¯¹ç”¨æˆ·æäº¤çš„è¡¨å•è¿›è¡Œæ ¡éªŒã€‚ä»¥â€œæ³¨å†Œç”¨æˆ·â€è¿™æ ·çš„åœºæ™¯ä¸¾ä¾‹è¯´æ˜ï¼Œ æ³¨å†Œç”¨æˆ·æ—¶ï¼Œå¾€å¾€ä¼šæäº¤æ˜µç§°ï¼Œæ€§åˆ«ï¼Œé‚®ç®±ç­‰ä¿¡æ¯è¿›è¡Œæ³¨å†Œï¼Œç®€å•èµ·è§ï¼Œå°±ä»¥è¿™ 3 ä¸ªå±æ€§ä¸ºä¾‹ã€‚</p><p>å®šä¹‰çš„è¡¨å•å¦‚ä¸‹ï¼š  </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRegForm</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> String nickname;</span><br><span class="line"><span class="keyword">private</span> String gender;</span><br><span class="line"><span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºè¡¨å•çš„çº¦æŸï¼Œæˆ‘ä»¬æœ‰ï¼š</p><ul><li>æ˜µç§°å­—æ®µï¼šâ€œnicknameâ€ å¿…å¡«ï¼Œé•¿åº¦å¿…é¡»æ˜¯ 6 åˆ° 20 ä½ï¼›</li><li>æ€§åˆ«å­—æ®µï¼šâ€œgenderâ€ å¯é€‰ï¼Œå¦‚æœå¡«äº†ï¼Œå°±å¿…é¡»æ˜¯â€œMale/Female/Other/â€ä¸­çš„ä¸€ç§ã€‚è¯´å•¥ï¼Œé™¤äº†ç”·å¥³è¿˜æœ‰å…¶ä»–ï¼Ÿå¯¹ï¼Œæ˜¯çš„ã€‚æ¯•ç«Ÿå…¨çƒç”¨æˆ·å˜›ï¼Œä½ å»çœ‹çœ‹éæ­»ä¸å¯ï¼Œè¿˜æœ‰æ›´å¤šã€‚</li><li>é‚®ç®±ï¼š â€œemailâ€ï¼Œå¿…å¡«ï¼Œå¿…é¡»æ»¡è¶³é‚®ç®±æ ¼å¼ã€‚</li></ul><p>å¯¹äºä»¥ä¸Šçº¦æŸï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å¯¹åº”çš„å­—æ®µä¸Šæ·»åŠ å¦‚ä¸‹æ³¨è§£å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRegForm</span> </span>&#123;</span><br><span class="line"><span class="meta">@Length</span>(min = <span class="number">6</span>, max = <span class="number">20</span>, message = <span class="string">"validate.userRegForm.nickname"</span>)</span><br><span class="line"><span class="keyword">private</span> String nickname;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Gender</span>(message=<span class="string">"validate.userRegForm.gender"</span>)</span><br><span class="line"><span class="keyword">private</span> String gender;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NotNull</span></span><br><span class="line"><span class="meta">@Email</span>(message=<span class="string">"validate.userRegForm.email"</span>)</span><br><span class="line"><span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨å„ä¸ªè¯­è¨€èµ„æºæ–‡ä»¶ä¸­é…ç½®å¥½ç›¸åº”çš„é”™è¯¯ä¿¡æ¯æç¤ºå³å¯ã€‚å…¶ä¸­ï¼Œ <code>@Gender</code> å°±æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„æ³¨è§£ã€‚</p><h3 id="åŸºäºå«è‡ªå®šä¹‰æ³¨è§£çš„è¡¨å•æ ¡éªŒå…³é”®ä»£ç "><a href="#åŸºäºå«è‡ªå®šä¹‰æ³¨è§£çš„è¡¨å•æ ¡éªŒå…³é”®ä»£ç " class="headerlink" title="åŸºäºå«è‡ªå®šä¹‰æ³¨è§£çš„è¡¨å•æ ¡éªŒå…³é”®ä»£ç "></a>åŸºäºå«è‡ªå®šä¹‰æ³¨è§£çš„è¡¨å•æ ¡éªŒå…³é”®ä»£ç </h3><p>è‡ªå®šä¹‰æ³¨è§£çš„å®ç°ä¸»è¦çš„å…¶å®å°±æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£çš„å®šä¹‰ä»¥åŠä¸€ä¸ªæ ¡éªŒé€»è¾‘ã€‚<br>ä¾‹å¦‚å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£ <code>CustomParam</code>ï¼š </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = CustomValidator<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Target</span>(</span>&#123;FIELD, METHOD, PARAMETER, ANNOTATION_TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> CustomParam &#123;</span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "name.tanglei.www.validator.CustomArray.defaultMessage"</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Documented</span></span><br><span class="line">    <span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line">    <span class="meta">@Target</span>(&#123;FIELD, METHOD, PARAMETER, ANNOTATION_TYPE&#125;)</span><br><span class="line">    <span class="meta">@interface</span> List &#123;</span><br><span class="line">        CustomParam[] value();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¡éªŒé€»è¾‘çš„å®ç° <code>CustomValidator</code>ï¼š </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">CustomParam</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String s, ConstraintValidatorContext constraintValidatorContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == s || s.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s.equals(<span class="string">"tanglei"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            error(constraintValidatorContext, <span class="string">"Invalid params: "</span> + s);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(CustomParam constraintAnnotation)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(ConstraintValidatorContext context, String message)</span> </span>&#123;</span><br><span class="line">        context.disableDefaultConstraintViolation();</span><br><span class="line">        context.buildConstraintViolationWithTemplate(message).addConstraintViolation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¾‹å­åªä¸ºäº†é˜è¿°è¯´æ˜é—®é¢˜ï¼Œå…¶ä¸­æ ¡éªŒé€»è¾‘æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œè¿™æ ·ï¼Œå¦‚æœè¾“å…¥å‚æ•°ä¸æ»¡è¶³æ¡ä»¶ï¼Œå°±ä¼šæ˜ç¡®æç¤ºç”¨æˆ·è¾“å…¥çš„å“ªä¸ªå‚æ•°ä¸æ»¡è¶³æ¡ä»¶ã€‚ä¾‹å¦‚è¾“å…¥å‚æ•° <code>xx</code>ï¼Œåˆ™ä¼šç›´æ¥æç¤ºï¼š<code>Invalid params: xx</code>ã€‚</p><p><img src="https://www.tanglei.name/resources/custom-validator-and-i18n-error-message-in-springboot/validator-bug.png" alt></p><p>è¿™ä¸ªè·Ÿç¬¬ä¸€éƒ¨åˆ†çš„å¤„ç†æ–¹å¼ç±»ä¼¼ï¼Œå› ä¸ºç°æœ‰çš„ validator ç»„ä»¶å®ç°ä¸­ï¼Œå¦‚æœè¿åç›¸åº”çš„çº¦æŸä¹Ÿæ˜¯ä¸€ç§æŠ›å¼‚å¸¸çš„æ–¹å¼å®ç°çš„ï¼Œå› æ­¤åªéœ€è¦åœ¨ä¸Šè¿°çš„ <code>GlobalExceptionHandler</code>ä¸­æ·»åŠ ç›¸åº”çš„å¼‚å¸¸ä¿¡æ¯å³å¯ï¼Œè¿™é‡Œå°±ä¸è¯¦è¿°äº†ã€‚  è¿™ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†é˜è¿°äº†ã€‚ è¯¦ç»†ä»£ç å®ç°å¯ä»¥å‚è€ƒæœ¬äººä¹‹å‰å†™çš„è¿™ç¯‡æ–‡ç« <a href="/blog/custom-validator-and-i18n-error-message-in-springboot.html">ä¸€æ–‡æ•™ä½ å®ç° SpringBoot ä¸­çš„è‡ªå®šä¹‰ Validator å’Œé”™è¯¯ä¿¡æ¯å›½é™…åŒ–é…ç½®</a>ï¼Œä¸Šé¢æœ‰é™„å®Œæ•´çš„ä»£ç å®ç°ã€‚</p><h2 id="åœºæ™¯é‡ç°"><a href="#åœºæ™¯é‡ç°" class="headerlink" title="åœºæ™¯é‡ç°"></a>åœºæ™¯é‡ç°</h2><p>ä¸€åˆ‡éƒ½æ˜¾å¾—å¾ˆå®Œç¾ï¼Œç›´åˆ°ä¸Šçº¿å‰ä»£ç æäº¤è‡³å®‰å…¨å›¢é˜Ÿæ‰«æï¼Œå°±è¢«â€œå•ªå•ªæ‰“è„¸â€ï¼Œæ‰«ææŠ¥å‘Šåé¦ˆäº†ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ã€‚è€Œè¿™ä¸ªå®‰å…¨æ¼æ´ï¼Œå±äºå¾ˆé«˜å±çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚</p><p><img src="/resources/a-security-vulnerability-of-spring-validator/gif-1.gif" alt></p><p>ç”¨å‰æ–‡æåˆ°çš„è‡ªå®šä¹‰ Validatorï¼Œè¾“å…¥çš„å‚æ•°ç”¨ï¼š â€œ1+1=${1+1}â€ï¼Œçœ‹çœ‹æ•ˆæœï¼š </p><p><img src="/resources/a-security-vulnerability-of-spring-validator/security-bug-calc-4wx.png" alt></p><p>å¤ª TM ç¥å¥‡äº†ï¼Œå±…ç„¶å¸®æˆ‘è¿ç®—å‡ºæ¥äº†ï¼Œè¿”å› <code>&quot;message&quot;: &quot;Invalid params: 1+1=2&quot;</code>ã€‚ </p><p>é—®é¢˜å°±å‡ºç°åœ¨å®ç°è‡ªå®šä¹‰æ³¨è§£è¿›è¡Œæ ¡éªŒçš„è¿™è¡Œä»£ç ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼š</p><p><img src="/resources/a-security-vulnerability-of-spring-validator/security-bug-line-4wx.png" alt></p><p>å…¶å®ï¼Œæœ€å¼€å§‹çš„æ—¶å€™ï¼Œè¿™é‡Œç›´æ¥è¿”å›äº†â€œInvalid paramsâ€ï¼Œå½“åˆä¸ºäº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œè¦æ˜ç¡®å‘Šè¯‰ç”¨æˆ·å“ªä¸ªå‚æ•°æ²¡æœ‰é€šè¿‡æ ¡éªŒï¼Œå› æ­¤åœ¨è¾“å‡ºçš„æç¤ºä¸ŠåŠ ä¸Šäº†ç”¨æˆ·è¾“å…¥çš„å­—æ®µï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„<code>&quot;Invalid params: &quot; + s</code>ï¼Œæ²¡æƒ³åˆ°ï¼Œè¿™é—¯äº†å¤§ç¥¸äº†ï¼ˆå›è¿‡å¤´æ¥æƒ³ï¼Œæ„Ÿè§‰è¿™é‡Œæ²¡å¿…è¦è¿™ä¹ˆè¯¦ç»†å•Šï¼Œå› ä¸ºå‰ç«¯å·²ç»æœ‰ç›¸åº”çš„æ ¡éªŒäº†ï¼Œæ­£å¸¸æƒ…å†µä¸‹å›æ‹¦ä½ï¼Œé’ˆå¯¹ä¸å®ˆè§„çŸ©çš„ç”¨éå¸¸è§„æ‰‹æ®µæ¥çš„æ¥å£è¯·æ±‚ï¼Œç›´æ¥è¿”å›æ ¡éªŒä¸é€šè¿‡å°±è¡Œäº†ï¼Œæ¯•ç«Ÿä¸æ˜¯å¯¹å¤–æä¾›çš„ OpenAPI æœåŠ¡ï¼‰ã€‚</p><p>ä»”ç»†çœ‹ï¼Œè¿™ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯ <code>ConstraintValidatorContext</code>è¿™ä¸ªæ¥å£ä¸­å£°æ˜çš„ï¼Œçœ‹æ–¹æ³•åå­—å…¶å®èƒ½çŸ¥é“è¾“å…¥å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ¨¡æ¿ï¼Œå†…éƒ¨ä¼šè¿›è¡Œè§£ææ›¿æ¢çš„ï¼ˆè¿™å…¶å®ä¹Ÿç¬¦åˆâ€œè§åçŸ¥æ„â€çš„è‰¯å¥½ç¼–ç¨‹ä¹ æƒ¯ï¼‰ã€‚ï¼ˆæ•™è®­ï¼š<strong>å¤§å®¶åº”è¯¥æŠŠæ¡å¥½è‡ªå·±å†™çš„æ¯ä¸€è¡Œä»£ç èƒŒåå®é™…åœ¨åšä»€ä¹ˆ</strong>ã€‚ï¼‰</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* ......</span></span><br><span class="line"><span class="comment"> * @param messageTemplate new un-interpolated constraint message</span></span><br><span class="line"><span class="comment"> * @return returns a constraint violation builder</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">ConstraintViolationBuilder <span class="title">buildConstraintViolationWithTemplate</span><span class="params">(String messageTemplate)</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª caseï¼Œæºç è°ƒè¯•è¿›å»ä¹‹åï¼Œå°±èƒ½è·Ÿè¸ªåˆ°æ‰§è¡Œç¿»è¯‘é˜¶æ®µï¼Œåœ¨å¦‚ä¸‹æ–¹æ³•ä¸­ï¼š <code>org.hibernate.validator.messageinterpolation.AbstractMessageInterpolator.interpolateMessage</code>ã€‚  </p><p><img src="/resources/a-security-vulnerability-of-spring-validator/security-bug-interpolate-4wx.png" alt></p><p>å†å¾€åï¼Œå°±æ˜¯è¡¨è¾¾å¼æ±‚å€¼äº†ã€‚<br><img src="/resources/a-security-vulnerability-of-spring-validator/security-bug-plus11-4wx.png" alt></p><h3 id="ä»¥ä¸ºå°±è¿™æ ·å°±å®Œäº†å—ï¼Ÿ"><a href="#ä»¥ä¸ºå°±è¿™æ ·å°±å®Œäº†å—ï¼Ÿ" class="headerlink" title="ä»¥ä¸ºå°±è¿™æ ·å°±å®Œäº†å—ï¼Ÿ"></a>ä»¥ä¸ºå°±è¿™æ ·å°±å®Œäº†å—ï¼Ÿ</h3><p><img src="/resources/a-security-vulnerability-of-spring-validator/gif-2.jpeg" alt></p><p>åˆšå¼€å§‹æ„Ÿè§‰ï¼Œèƒ½å¸®å¿™ç®—ç®€å•çš„è¿ç®—è§„åˆ™ä¹Ÿå°±å®Œäº†å§ï¼Œä½ è¿˜èƒ½æŠŠæˆ‘æ€ä¹ˆæ ·ï¼Ÿå…¶å®è¿™ä¸ªç›¸å½“äºæš´éœ²äº†ä¸€ä¸ªå…¥å£ï¼Œæ”¯æŒç”¨æˆ·è¾“å…¥ä»»æ„ EL è¡¨è¾¾å¼è¿›è¡Œæ‰§è¡Œã€‚ç½‘ä¸Šé€šè¿‡å…³é”®å­— â€œSpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´â€ æ‰¾æ‰¾ï¼Œå°±èƒ½å‘ç°äº‹æƒ…å¹¶æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•ã€‚</p><p>æˆ‘ä»¬æ„é€ æ°å½“çš„ EL è¡¨è¾¾å¼ï¼ˆæ³¨æ„å„ç§è½¬ä¹‰ï¼Œä¸‹æ–‡çš„è¾“å…¥å‚æ•°ç›¸å¯¹æ¯”è¾ƒæ˜æ˜¾åœ¨åšä»€ä¹ˆäº†ï¼Œå®é™…ä¸Šè¿˜æœ‰æ›´å¤šé»‘ç§‘æŠ€ï¼Œæ¯”å¦‚å„ç§äºŒè¿›åˆ¶è½¬ä¹‰ç¼–ç å•Šç­‰ç­‰ï¼‰ï¼Œå°±èƒ½ç›´æ¥æ‰§è¡Œè¾“å…¥ä»£ç ï¼Œä¾‹å¦‚ï¼šå¯ä»¥ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œâ€œls -alâ€ï¼Œ è¿”å›äº†ä¸€ä¸ª UNIXProcess å®ä¾‹ï¼Œå‘½ä»¤å·²ç»è¢«æ‰§è¡Œè¿‡äº†ã€‚</p><p><img src="/resources/a-security-vulnerability-of-spring-validator/security-bug-run-process-4wx.png" alt></p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸ªæ‰“å¼€è®¡ç®—å™¨çš„å‘½ä»¤ï¼Œæä¸ªè®¡ç®—å™¨ç©ç©~ </p><p><img src="/resources/a-security-vulnerability-of-spring-validator/security-bug-run-open-calc-4wx.png" alt></p><p>æˆ‘å½•åˆ¶äº†ä¸€ä¸ªåŠ¨å›¾ï¼Œæ¥ä¸ªæ¼”ç¤ºå¯èƒ½æ›´ç”ŸåŠ¨ä¸€äº›ã€‚ </p><p><img src="/resources/a-security-vulnerability-of-spring-validator/spel-bug-demo-0.gif" alt></p><p>è¿™è¿˜å¾—äº†å—ï¼Ÿè¿™ç›¸å½“äºæä¾›äº†ä¸€ä¸ª webshell çš„åŠŸèƒ½å‘€ï¼Œä½ çœ‹æƒ³è¿è¡Œå•¥å‘½ä»¤å°±èƒ½è¿è¡Œå•¥å‘½ä»¤ï¼Œä¾‹å¦‚ ping æœ¬äººåšå®¢åœ°å€ï¼ˆ<code>ping www.tanglei.name</code>ï¼‰ï¼Œä¸‹é¢åŠ¨å›¾æ¼”ç¤ºä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼ˆä»è¿è¡Œ ping åˆ° kill pingï¼‰ã€‚</p><p><img src="/resources/a-security-vulnerability-of-spring-validator/spel-demo-ping.gif" alt></p><p>æˆ‘å½•åˆ¶äº†ä¸€ä¸ªè§†é¢‘ï¼Œç‚¹å‡»<a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=100001493&amp;idx=1&amp;sn=d8d2374d8afa76e55bd37650c7ccde45&amp;chksm=6b4707315c308e273f4eb62799c65677d849104125bb6e7a56fbded981554fb92e97c289804e#rd" target="_blank" rel="noopener">è¿™é‡Œ</a>å¯ä»¥è®¿é—®ã€‚</p><p>å²‚ä¸æ˜¯ç›´æ¥åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Œç„¶åè¿œç¨‹ç™»å½•å°±å¯ä»¥äº†ã€‚åæœå¾ˆä¸¥é‡å•Šï¼Œåˆ«äººæƒ³å¹²å˜›å°±å¹²å˜›äº†ã€‚ </p><p><img src="/resources/a-security-vulnerability-of-spring-validator/gif-3.gif" alt></p><p>æˆ‘ä»¬è·Ÿè¸ªä¸‹å¯¹åº”çš„ä»£ç ï¼Œçœ‹çœ‹å†…éƒ¨å®ç°ï¼Œå°±ä¼šâ€œæç„¶å¤§æ‚Ÿâ€äº†ã€‚ </p><p><img src="/resources/a-security-vulnerability-of-spring-validator/security-bug-el-express-4wx.png" alt></p><p><img src="/resources/a-security-vulnerability-of-spring-validator/security-bug-el-express-run-4wx.png" alt></p><h2 id="ç»éªŒæ•™è®­"><a href="#ç»éªŒæ•™è®­" class="headerlink" title="ç»éªŒæ•™è®­"></a>ç»éªŒæ•™è®­</h2><p>å¹¸äºè¿™ä¸ªæ¼æ´è¢«æ‰¼æ€åœ¨æ‘‡ç¯®é‡Œï¼Œå¦åˆ™åæœè¿˜çœŸçš„æŒºä¸¥é‡çš„ã€‚é€šè¿‡è¿™ä¸ªæ¡ˆä¾‹ï¼Œæˆ‘ä»¬æœ‰å•¥ç»éªŒå’Œæ•™è®­å‘¢ï¼Ÿé‚£å°±æ˜¯ä½œä¸ºç¨‹åºå‘˜ï¼Œ<strong>æˆ‘ä»¬è¦å¯¹æ¯ä¸€è¡Œä»£ç éƒ½ä¿æŒâ€œæ•¬ç•â€ä¹‹å¿ƒ</strong>ã€‚ä¹Ÿè®¸å°±æ˜¯å› ä¸ºä½ çš„ä¸ç»æ„çš„ä¸€è¡Œä»£ç å°±å¸¦æ¥äº†ä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œè¦æ˜¯ä¸å°å¿ƒè¢«åäººåˆ©ç”¨ï¼Œè½»åˆ™â€¦â€¦é‡åˆ™â€¦â€¦ï¼ˆè‡ªå·±æƒ³è±¡å§ï¼‰ </p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬ä¹Ÿåº”è¯¥çœ‹åˆ°ï¼Œç¨‹åºå‘˜éœ€è¦å¯¹å¸¸è§çš„å®‰å…¨æ¼æ´ï¼ˆä¾‹å¦‚XSS/CSRF/SQLæ³¨å…¥ç­‰ç­‰ï¼‰æœ‰æ‰€äº†è§£ï¼Œå¹¶ä¸”è¦æœ‰è¶³å¤Ÿçš„å®‰å…¨æ„è¯†ï¼ˆå…¶å®æœ‰æ—¶å€™ç ”ç©¶ä¸€äº›å®‰å…¨é—®é¢˜è¿˜æŒºå¥½ç©çš„ï¼Œæ¯”å¦‚è¿™ç¯‡<a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247483759&amp;idx=1&amp;sn=9b37547a51ac99a8d3d50cb9cf54a99a&amp;chksm=eb47008bdc30899dace5743edfc071d97d37764ed69bd9cebbfe32c14727a7407a6b8b76a433&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">ã€ŠRSAç®—æ³•åŠä¸€ç§â€æ—é—¨å·¦é“â€çš„æ”»å‡»æ–¹å¼ã€‹</a>å°±æ¯”è¾ƒæœ‰è¶£ï¼‰ã€‚ä¾‹å¦‚ï¼š</p><ul><li>ç”¨æˆ·æƒé™åˆ†ç¦»ï¼šè¿è¡Œç¨‹åºçš„ç”¨æˆ·ä¸åº”è¯¥ç”¨ rootï¼Œä¾‹å¦‚æ–°å»ºä¸€ä¸ªâ€œwebâ€æˆ–è€…â€œwwwâ€ä¹‹ç±»çš„ç”¨æˆ·ï¼Œå¹¶è®¾ç½®è¯¥ç”¨æˆ·çš„æƒé™ï¼Œæ¯”å¦‚ä¸èƒ½æœ‰å¯æ‰§è¡Œ xx çš„æƒé™ä¹‹ç±»çš„ã€‚æœ¬æ–‡ caseï¼Œå¦‚æœæƒé™è¿›è¡Œäº†åˆ†ç¦»ï¼ˆéµå¾ªæœ€å°æƒé™åŸåˆ™ï¼‰ï¼Œåº”è¯¥ä¹Ÿä¸ä¼šè¿™ä¹ˆä¸¥é‡ã€‚ï¼ˆæœ¬æ–‡å°±åˆšå¥½æ˜¯å› ä¸ºæ˜¯æµ‹è¯•ç¯å¢ƒï¼Œæ‰€ä»¥æ²¡æœ‰å¼ºåˆ¶å®æ–½ï¼‰</li><li>ä»»ä½•æ—¶å€™éƒ½ä¸è¦ç›¸ä¿¡ç”¨æˆ·çš„è¾“å…¥ï¼Œå¿…é¡»å¯¹ç”¨æˆ·è¾“å…¥çš„è¿›è¡Œæ ¡éªŒå’Œè¿‡æ»¤ï¼Œåˆç‰¹åˆ«æ˜¯é’ˆå¯¹å…¬ç½‘ä¸Šçš„åº”ç”¨ã€‚</li><li>æ•æ„Ÿä¿¡æ¯åŠ å¯†ä¿å­˜ã€‚é€€ä¸€ä¸‡æ­¥è®²ï¼Œå‡è®¾æ”»å‡»è€…æ”»å…¥äº†ä½ çš„æœåŠ¡å™¨ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ï¼Œä½ çš„æ•°æ®åº“è´¦æˆ·ä¿¡æ¯ç­‰é…ç½®éƒ½ç›´æ¥æ˜æ–‡ä¿å­˜åœ¨æœåŠ¡å™¨ä¸­ã€‚é‚£æ•°æ®åº“ä¹Ÿè¢«è„±èµ°äº†ã€‚</li></ul><p>å¦‚æœå¯èƒ½çš„è¯ï¼Œéœ€è¦å¯¹å¼€å‘è€…çš„ä»£ç è¿›è¡Œæ¼æ´æ‰«æã€‚ä¸€äº›å¸¸è§çš„å®‰å…¨æ¼æ´ç°åœ¨åº”è¯¥æ˜¯æœ‰ç°æˆçš„å·¥å…·æ”¯æŒçš„ã€‚å¦å¤–ï¼Œè®©ä¸“ä¸šçš„äººåšä¸“ä¸šçš„äº‹æƒ…ï¼Œä¾‹å¦‚è¦æœ‰å®‰å…¨å›¢é˜Ÿï¼Œå¯èƒ½ä½ ä¼šè¯´ä½ ä»¬å…¬å¸æ²¡æœ‰ä¸ä¹Ÿæ´»çš„å¥½å¥½çš„ï¼Œå“ˆå“ˆï¼Œåªä¸è¿‡å¯èƒ½è¿˜æ²¡æœ‰è¢«åäººç›¯ä¸Šè€Œå·²ï¼Œåäººä¹Ÿä¼šè€ƒè™‘åˆ°ä»–ä»¬çš„æˆæœ¬å’Œé¢„æœŸæ”¶ç›Šçš„ï¼Œå½“ç„¶è¿™å°±æ›´åŠ å¯¹æˆ‘ä»¬å¼€å‘è€…æé«˜äº†è¦æ±‚ã€‚ä¸€äº›æ•æ„Ÿæƒé™å°½é‡æ§åˆ¶åœ¨å°‘éƒ¨åˆ†äººæ‰‹ä¸­ï¼Œé…åˆç›¸åº”çš„æµç¨‹æ¥æ”¯æ’‘ï¼ˆä¸å¾—ä¸è¯´ï¼Œå¤§å…¬å¸ç¹ççš„æµç¨‹è¿˜æ˜¯æœ‰ä¸€å®šé“ç†çš„ï¼‰ã€‚</p><p>æ¯•ç«Ÿæˆ‘ä¸æ˜¯ä¸“ä¸šç ”ç©¶Webå®‰å…¨çš„ï¼Œä»¥ä¸Šè¯´å¾—å¯èƒ½ä¹Ÿä¸ä¸€å®šå¯¹ï¼Œå¦‚æœä½ æœ‰ä¸åŒæ„è§æˆ–è€…æ›´å¥½çš„å»ºè®®æ¬¢è¿ç•™è¨€å‚ä¸è®¨è®ºã€‚</p><p>è¿™ç¯‡æ–‡ç« ä»å†™ä»£ç åšå®éªŒï¼Œåˆ°å½•å±åšè§†é¢‘åŠ¨å›¾ç­‰ç­‰è€—æ—¶è¿˜è›®ä¹…çš„ï¼ˆå¥½å‡ ä¸ªå‘¨æœ«çš„æ—¶é—´å‘¢ï¼‰ï¼ŒåŸåˆ›çœŸå¿ƒä¸æ˜“ï¼Œå¸Œæœ›ä½ èƒ½å¸®æˆ‘ä¸ªå°å¿™å‘—ï¼Œå¦‚æœæœ¬æ–‡å†…å®¹ä½ è§‰å¾—æœ‰æ‰€å¯å‘ï¼Œæœ‰æ‰€æ”¶è·ï¼Œè¯·å¸®å¿™ç‚¹ä¸ªâ€œåœ¨çœ‹â€å‘—ï¼Œæˆ–è€…è½¬å‘åˆ†äº«è®©æ›´å¤šçš„å°ä¼™ä¼´çœ‹åˆ°ã€‚</p><h5 id="ç²¾å½©æ¨è"><a href="#ç²¾å½©æ¨è" class="headerlink" title="ç²¾å½©æ¨è"></a>ç²¾å½©æ¨è</h5><ul><li><a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247483933&amp;idx=1&amp;sn=69b1be012cf37ccb5ce6f3a091f57f5b&amp;chksm=eb4703f9dc308aef5834a6abf72255edd1767e633330531f817d7b4774c65c33f5910cd9ea75&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">ä¸€ä¸ªç”±è·¨å¹³å°äº§ç”Ÿçš„æµ®ç‚¹æ•°bug | æœ‰ä½ æ„æƒ³ä¸åˆ°çš„ç»“æœã€‚</a></li><li><a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247483759&amp;idx=1&amp;sn=9b37547a51ac99a8d3d50cb9cf54a99a&amp;chksm=eb47008bdc30899dace5743edfc071d97d37764ed69bd9cebbfe32c14727a7407a6b8b76a433&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">RSAç®—æ³•åŠä¸€ç§â€æ—é—¨å·¦é“â€çš„æ”»å‡»æ–¹å¼ã€‚</a></li><li><a href="http://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247483891&amp;idx=1&amp;sn=264171adf872514d1fd54faf54970dd7&amp;chksm=eb470017dc3089019ffc13facfdfb38e9d5f2adaf7fcbf9c117723ce015fb660f0802d406c7b&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">éœ‡æƒŠ! é˜¿é‡Œçš„ç¨‹åºå‘˜ä¹Ÿä¸è¿‡å¦‚æ­¤,ç«Ÿè¢«ä¸€ä¸ªç®€å•çš„ SQL æŸ¥è¯¢éš¾ä½ã€‚</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzI3OTUzMzcwNw==&amp;mid=2247483912&amp;idx=1&amp;sn=520bbca6a2056ab4df6b0e1d0ebaf6e0&amp;chksm=eb4703ecdc308afa83b288b1469f0927c1916189f219ee5e8c3c5194defc0b8f313ff7607730&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">é¢äº†7è½® Googleï¼Œæœ€ç»ˆè¿˜æ˜¯é€ƒä¸è„±è¢«æŒ‚çš„å‘½è¿ã€‚</a></li></ul><blockquote><p>æ–‡ç« é¦–å‘äºæœ¬äººå¾®ä¿¡å…¬ä¼—å·ï¼ˆIDï¼š<code>tangleithu</code>ï¼‰ï¼Œè¯·æ„Ÿå…´è¶£çš„åŒå­¦å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ï¼ŒåŠæ—¶è·å–æŠ€æœ¯å¹²è´§ã€‚</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¹‹å‰åœ¨æŸå‚çš„æŸæ¬¡é¡¹ç›®å¼€å‘ä¸­ï¼Œé¡¹ç›®ç»„åŒå­¦è®¾è®¡å’Œå®ç°äº†ä¸€ä¸ªâ€œå¼•ä»¥ä¸ºå‚²â€ï¼Œé¢ï¼Œæœ‰ç‚¹æ‰©å¼ ï¼Œä¸è¿‡è‡ªè®¤ä¸ºè¿˜è¯´å¾—è¿‡å»çš„ featureï¼Œç»“æœä¸´ä¸Šçº¿å‰è¢«å•ªå•ªæ‰“è„¸ï¼Œå› ä¸ºå®ç°è¿‡ç¨‹ä¸­å› ä¸º&lt;strong&gt;ä¸€è¡Œä»£ç &lt;/strong&gt;ï¼ˆæ²¡æœ‰æ ‡é¢˜å…šï¼ŒçœŸçš„æ˜¯ä¸€è¡Œä»£ç ï¼‰å¸¦æ¥çš„å®‰å…¨æ¼æ´è®©æˆ‘ä»¬ä¸¢å¤±äº†æ•´ä¸ªæœåŠ¡å™¨æ§
      
    
    </summary>
    
      <category term="ç»éªŒæŠ€å·§" scheme="https://www.tanglei.name/categories/%E7%BB%8F%E9%AA%8C%E6%8A%80%E5%B7%A7/"/>
    
    
      <category term="Java" scheme="https://www.tanglei.name/tags/Java/"/>
    
      <category term="ç½‘ç»œå®‰å…¨" scheme="https://www.tanglei.name/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/"/>
    
      <category term="ç»éªŒæŠ€å·§" scheme="https://www.tanglei.name/tags/%E7%BB%8F%E9%AA%8C%E6%8A%80%E5%B7%A7/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ–‡æ•™ä½ å®ç° SpringBoot ä¸­çš„è‡ªå®šä¹‰ Validator å’Œé”™è¯¯ä¿¡æ¯å›½é™…åŒ–é…ç½®</title>
    <link href="https://www.tanglei.name/blog/custom-validator-and-i18n-error-message-in-springboot.html"/>
    <id>https://www.tanglei.name/blog/custom-validator-and-i18n-error-message-in-springboot.html</id>
    <published>2020-05-16T00:00:00.000Z</published>
    <updated>2020-10-11T15:25:42.107Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/resources/custom-validator-and-i18n-error-message-in-springboot/i18n-title.png" alt></p><p>æœ¬æ–‡é€šè¿‡ç¤ºä¾‹è¯´æ˜ï¼Œåœ¨ Springboot ä¸­å¦‚ä½•è‡ªå®šä¹‰ Validatorï¼Œä»¥åŠå¦‚ä½•å®ç°å›½é™…åŒ–çš„é”™è¯¯ä¿¡æ¯è¿”å›ã€‚æ³¨æ„ï¼Œæœ¬æ–‡ä»£ç åƒä¸‡åˆ«ç›´æ¥ç…§æŠ„ï¼Œæœ‰å¯èƒ½ä¼šå‡ºå¤§äº‹æƒ…çš„ã€‚å…ˆç•™ä¸ªæ‚¬å¿µï¼Œè¯»è€…æœ‹å‹ä»¬èƒ½ä»ä¸­çœ‹å‡ºæœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ</p><h2 id="é¡¹ç›®åˆå§‹åŒ–"><a href="#é¡¹ç›®åˆå§‹åŒ–" class="headerlink" title="é¡¹ç›®åˆå§‹åŒ–"></a>é¡¹ç›®åˆå§‹åŒ–</h2><p>ç›´æ¥ä» <a href="https://spring.io/guides/gs/rest-service/#initial" target="_blank" rel="noopener">springboot</a> å®˜ç½‘ä¸­ä¸‹è½½æ¨¡æ¿ï¼Œç›´æ¥é€šè¿‡ç¤ºä¾‹ä¸­çš„ <code>GreetingController</code> æ·»åŠ å®ç°é€»è¾‘ã€‚ </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreetingController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String template = <span class="string">"Hello, %s!"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong counter = <span class="keyword">new</span> AtomicLong();</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/greeting"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Response&lt;Greeting&gt; <span class="title">greeting</span><span class="params">(@RequestParam(value = <span class="string">"name"</span>, defaultValue = <span class="string">"World"</span>)</span> String name) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="string">"tangleithu"</span>.equals(name)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> BadRequestException(<span class="string">"user.notFound"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> Response.ok(<span class="keyword">new</span> Greeting(counter.incrementAndGet(), String.format(template, name)));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç ç›´æ¥æºè‡ª<a href="https://github.com/spring-guides/gs-rest-service.git" target="_blank" rel="noopener">å®˜æ–¹ spring-guides çš„ demo</a>ï¼Œæˆ‘ç¨å¾®æ”¹å§æ”¹å§ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œèƒ½è¿”å›æ­£ç¡®çš„ç»“æœï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"># curl "localhost:8080/greeting?name=tangleithu&amp;lang=en" </span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"Hello, tangleithu!"</span>,</span><br><span class="line">        <span class="attr">"id"</span>: <span class="number">9</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"success"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å›½é™…åŒ–éœ€æ±‚"><a href="#å›½é™…åŒ–éœ€æ±‚" class="headerlink" title="å›½é™…åŒ–éœ€æ±‚"></a>å›½é™…åŒ–éœ€æ±‚</h2><p>ä½œä¸ºé«˜å¤§ä¸Šçš„é¡¹ç›®ï¼Œæˆ‘ä»¬è‚¯å®šæœ‰æµ·å¤–ç”¨æˆ·ï¼Œæ‰€ä»¥å°±éœ€è¦å›½é™…åŒ–çš„é…ç½®ã€‚ç°åœ¨æ¥æ¨¡æ‹Ÿäº†ä¸‹ä¸šåŠ¡é€»è¾‘ï¼Œå‡è®¾è¾“å…¥çš„å‚æ•°æœ‰ä¸€äº›æ ¡éªŒåŠŸèƒ½ï¼Œæ¯”å¦‚ä»¥ä¸Šnameå‚æ•°ï¼Œå‡è®¾å’Œâ€œtangleithuâ€ä¸ç›¸ç­‰ï¼Œå°±ç›´æ¥è¿”å›é”™è¯¯ã€‚åŒæ—¶å¸Œæœ›è¿”å›çš„é”™è¯¯ä¿¡æ¯éœ€è¦å®ç°å›½é™…åŒ–ï¼Œå³åœ¨ä¸åŒçš„è¯­è¨€ç¯å¢ƒä¸‹è¿”å›çš„ç»“æœä¸ä¸€æ ·ã€‚ä¾‹å¦‚ä¸­æ–‡ï¼šâ€œæ²¡æ‰¾åˆ°ç”¨æˆ·å‘¢ã€‚â€ å¯¹åº”çš„è‹±æ–‡ï¼šâ€œUser does not exist.â€ï¼Œè€Œå¯¹åº”çš„å¾·æ–‡æ˜¯â€¦â€¦ï¼Œç®—äº†å¿½ç•¥ï¼Œæˆ‘ä¹Ÿä¸ä¼šã€‚</p><p><img src="/resources/custom-validator-and-i18n-error-message-in-springboot/i18n-demo.png" alt></p><p>ç”¨ä¸€ä¸ªå›¾æ¥è¡¨è¾¾ï¼Œå³å¸Œæœ›å®ç°çš„æ•ˆæœæ˜¯ï¼Œä¸åŒå›½å®¶å’Œåœ°åŒºçš„ç”¨æˆ·ï¼ˆä¸åŒè¯­è¨€ï¼‰åœ¨é‡åˆ°åŒä¸€ä¸ªä¸šåŠ¡åœºæ™¯ä¸‹åŒä¸€ä¸ªé”™è¯¯åŸå› ï¼Œæœ‰ä¸åŒçš„ç¿»è¯‘ã€‚ä¾‹å¦‚åœ¨å‚æ•°æ ¡éªŒæ²¡é€šè¿‡ï¼ŒHttp Status Codeåº”è¯¥è¿”å› 400ï¼Œå¹¶å‘ŠçŸ¥é”™è¯¯åŸå› ï¼›åœ¨å…·ä½“çš„ Service å®ç°æ—¶å¯èƒ½ä¹Ÿä¼šé‡åˆ°å…¶ä»–çš„ case éœ€è¦è¿”å›æŸç§å…·ä½“é”™è¯¯ä¿¡æ¯ã€‚</p><p>æ³¨æ„ï¼šå®é™…ä¸šåŠ¡åœºæ™¯ä¸­åç«¯å¯èƒ½ä»…ä»…åªè¿”å›é”™è¯¯ç ï¼Œå…·ä½“çš„å±•ç¤ºç”±å‰ç«¯æ ¹æ® key è¿›è¡Œç¿»è¯‘ã€‚ä¸è¿‡åœ¨ä¸€äº›æ›´åŠ çµæ´»çš„åœºæ™¯ä¸­ï¼ˆä¾‹å¦‚æœ‰çš„ app å®ç°æ–¹æ¡ˆï¼‰ï¼Œé”™è¯¯ä¿¡æ¯å¾ˆæœ‰å¯èƒ½ä¼šç”±åç«¯æ¥å£ç›´æ¥è¿”å›ã€‚æœ¬æ–‡åªæ˜¯ç”¨äº†ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹é˜è¿°æ•´ä¸ªæµç¨‹ã€‚</p><h2 id="ç»Ÿä¸€é”™è¯¯å¤„ç†"><a href="#ç»Ÿä¸€é”™è¯¯å¤„ç†" class="headerlink" title="ç»Ÿä¸€é”™è¯¯å¤„ç†"></a>ç»Ÿä¸€é”™è¯¯å¤„ç†</h2><p>â€‹æˆ‘ä»¬å€ŸåŠ© Spring ä¸­çš„ AOPï¼Œç”¨ä¸€ä¸ª <code>ControllerAdvice</code> ç»Ÿä¸€æ‹¦æˆªè¿™ç§ <code>BadRequestException</code>å¼‚å¸¸ã€‚å…¶ä»– Exception ä¹Ÿä¸€æ ·ï¼Œåšåˆ°å¼‚å¸¸ä¿¡æ¯ç»Ÿä¸€å¤„ç†ï¼Œä¹Ÿä¸å®¹æ˜“å‡ºç°å®‰å…¨é£é™©ï¼ˆä¹‹å‰æœ‰é‡åˆ°è¿‡æŸå¤§å‹ç½‘ç«™å› ä¸ºåå°å‘ç”Ÿå¼‚å¸¸ï¼Œç›´æ¥å°†å…·ä½“çš„ SQL é”™è¯¯æš´éœ²å‡ºæ¥äº†ï¼Œå…¶ä¸­è¿˜ä¸ä¹æœ‰è¡¨ç»“æ„ç­‰æ•æ„Ÿä¿¡æ¯ï¼‰ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(BadRequestException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">handle</span>(<span class="title">HttpServletRequest</span> <span class="title">request</span>, <span class="title">BadRequestException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        String i18message = getI18nMessage(e.getKey(), request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Response.error(e.getCode(), i18message));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å›½é™…åŒ–é…ç½®"><a href="#å›½é™…åŒ–é…ç½®" class="headerlink" title="å›½é™…åŒ–é…ç½®"></a>å›½é™…åŒ–é…ç½®</h2><p>ç„¶åï¼Œæˆ‘ä»¬åœ¨è¿™ç§å…·ä½“çš„å¼‚å¸¸ä¿¡æ¯æ—¶ï¼Œç”¨ä¸€ä¸ª key æ¥æ ‡è®°é”™è¯¯ç ï¼Œåœ¨èµ„æºæ–‡ä»¶ä¸­ç”¨ä¸åŒçš„è¯­è¨€æ¥å®šä¹‰åº”è¯¥è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯ã€‚ä¾‹å¦‚æœ¬æ–‡ç¤ºä¾‹ä¸­ï¼Œæ·»åŠ äº†ä¸­è‹±æ–‡ä¸¤ç§ã€‚ ç›¸åº”çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š </p><p><img src="/resources/custom-validator-and-i18n-error-message-in-springboot/i18n-tree.png" alt></p><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ <code>GlobalExceptionHandler</code> ä¸­æ ¹æ®è¯·æ±‚æ¥æºæ˜¯ä¸­æ–‡è¿˜æ˜¯è‹±æ–‡è¿”å›å¯¹åº”çš„é”™è¯¯ä¿¡æ¯å³å¯ã€‚ </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getI18nMessage</span><span class="params">(String key, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> messageSource.getMessage(key, <span class="keyword">null</span>, LanguaggeUtils.currentLocale(request));</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       <span class="comment">// log</span></span><br><span class="line">       <span class="keyword">return</span> key;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¯·æ±‚æ¥æºè·å–è¯­è¨€ä¿¡æ¯å°±æœ‰å¤šç§æ–¹å¼å•¦ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ä»è¯·æ±‚å¤´ä¸­è·å– <code>Accept-Lanuage</code>ï¼Œä¸€èˆ¬æµè§ˆå™¨ä¼šæ ¹æ®ç”¨æˆ·çš„è®¾ç½®æƒ…å†µå¸¦ä¸Šè¿™ä¸ªè¯·æ±‚å¤´çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/resources/custom-validator-and-i18n-error-message-in-springboot/i18n-header.png" alt></p><p>æˆ–è€…æˆ‘ä»¬è‡ªå·±æ˜¾ç¤ºå®šä¹‰ä¸€äº›ä¾‹å¦‚ lang ä¹‹ç±»çš„å‚æ•°ã€‚æœ¬æ–‡ä¸åšè¯¦ç»†é˜è¿°ï¼Œå’±ä»¬å°±ç®€å•ç”¨ <code>lang</code> è¿™ä¸ªå‚æ•°æ¥å®šä¹‰ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LanguaggeUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Locale <span class="title">currentLocale</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä» RequestHeader ç­‰ç­‰è·å–ç›¸åº”çš„è¯­è¨€ä¿¡æ¯</span></span><br><span class="line">        <span class="comment">// ç®€å•èµ·è§ï¼Œç›´æ¥ä» queryParams ä¸­å–, åªæ¨¡æ‹Ÿä¸­è‹±æ–‡</span></span><br><span class="line">        String locale = request.getParameter(<span class="string">"lang"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"zh"</span>.equalsIgnoreCase(locale)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Locale.CHINA;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Locale.ENGLISH;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œé€šè¿‡ç®€å•å‡ è¡Œä»£ç å°±èƒ½å®ç°é«˜å¤§ä¸Šçš„â€œå›½é™…åŒ–â€å‚æ•°è¿”å›äº†ã€‚ è¯•è¯•æ•ˆæœå¦‚ä¸‹ï¼š </p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">#curl "localhost:8080/greeting?name=tanglei&amp;lang=en" </span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">400</span>,</span><br><span class="line">    <span class="attr">"data"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"User does not exist."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#curl "localhost:8080/greeting?name=tanglei&amp;lang=zh" </span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">400</span>,</span><br><span class="line">    <span class="attr">"data"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"æ²¡æ‰¾åˆ°ç”¨æˆ·å‘¢ã€‚"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Bean-Validator"><a href="#Bean-Validator" class="headerlink" title="Bean Validator"></a>Bean Validator</h2><p>å…¶å®é’ˆå¯¹ç±»ä¼¼ Form ç­‰å‚æ•°æ ¡éªŒï¼Œæˆ‘ä»¬æœ‰æ›´ç®€å•çš„æ–¹æ³•ã€‚é‚£å°±æ˜¯å€ŸåŠ© SpringBoot ä¸­è‡ªå¸¦çš„ Validation æ¡†æ¶ï¼Œæœ¬æ–‡ç”¨åˆ°çš„è¿™ä¸ªç‰ˆæœ¬å¯¹åº”çš„å®ç°æ˜¯<code>jakarta.validation-api</code>ã€‚å…¶å® Bean Validation éƒ½æœ‰ç›¸åº”çš„æ ‡å‡†ï¼Œå¯èƒ½æœ‰ä¸åŒçš„å…·ä½“å®ç°è€Œå·²ã€‚å¯¹æ ‡å‡†æ„Ÿå…´è¶£çš„å¯ä»¥æˆ³è¿™é‡Œ<a href="https://www.jcp.org/en/egc/view?id=380" target="_blank" rel="noopener">JSR #380 Bean Validation 2.0</a>ã€‚</p><p>å›åˆ°æœ¬æ–‡çš„ demo ä¸­ï¼Œå‡è®¾åœ¨æˆ‘ä»¬ä¸šåŠ¡é€»è¾‘ä¸­éœ€è¦ä¼ é€’ä¸€ä¸ª <code>UserForm</code>ï¼Œæ¥æ”¶ <code>age,name,param</code> ä¸‰ä¸ªå‚æ•°ã€‚å¹¶å¯¹å…¶ä¸­è¾“å…¥è¿›è¡Œè¿›è¡Œæ ¡éªŒï¼Œå…¶ä¸­ï¼Œ<code>param</code> æ²¡æœ‰å…·ä½“çš„å«ä¹‰ï¼Œåªæ˜¯ä¸ºäº†è¯´æ˜é—®é¢˜ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserForm</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Min</span>(value = <span class="number">0</span>, message = <span class="string">"validate.userform.age"</span>)</span><br><span class="line">    <span class="meta">@Max</span>(value = <span class="number">120</span>, message = <span class="string">"validate.userform.age"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span>(message = <span class="string">"validate.userform.name.notEmpty"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CustomParam</span>(message = <span class="string">"validate.userform.param.custom"</span>)</span><br><span class="line">    <span class="keyword">private</span> String param;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Response&lt;Greeting&gt; <span class="title">createUser</span><span class="params">(@Valid @RequestBody UserForm userForm)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Response.ok(<span class="keyword">new</span> Greeting(counter.incrementAndGet(), String.format(template, userForm.getName())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç å¦‚ä¸Šï¼Œä¸Šé¢ç¤ºä¾‹åªç”¨äº†å¾ˆç®€å•çš„ <code>@Min, @Max, @NotNull</code>ç­‰çº¦æŸæ¡ä»¶ï¼Œé€šè¿‡åå­—å°±èƒ½çœ‹å‡ºæ¥å«ä¹‰ã€‚æ›´å¤šçº¦æŸè§„åˆ™å¯ä»¥ç›´æ¥çœ‹å¯¹åº”æºç  <code>javax.validation.constraints.xxx</code>ï¼Œæ¯”å¦‚æœ‰å¸¸è§çš„ <code>Email</code> ç­‰æ ¼å¼æ ¡éªŒã€‚ </p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿åç›¸åº”çš„çº¦æŸæ¡ä»¶åï¼Œé»˜è®¤çš„è¾“å‡ºæ¯”è¾ƒå•°å—¦ï¼Œä¾‹å¦‚ç”¨è¿™ä¸ªè¯·æ±‚ <code>curl -H &quot;Content-Type: application/json&quot; -d &quot;{}&quot; &quot;localhost:8080/user&quot;</code>ï¼Œå¯¹åº”çš„è¾“å‡ºå¦‚ä¸‹ï¼š </p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"error"</span>: <span class="string">"Bad Request"</span>,</span><br><span class="line">    <span class="attr">"errors"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"arguments"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"arguments"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"code"</span>: <span class="string">"name"</span>,</span><br><span class="line">                    <span class="attr">"codes"</span>: [</span><br><span class="line">                        <span class="string">"userForm.name"</span>,</span><br><span class="line">                        <span class="string">"name"</span></span><br><span class="line">                    ],</span><br><span class="line">                    <span class="attr">"defaultMessage"</span>: <span class="string">"name"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"bindingFailure"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"code"</span>: <span class="string">"NotBlank"</span>,</span><br><span class="line">            <span class="attr">"codes"</span>: [</span><br><span class="line">                <span class="string">"NotBlank.userForm.name"</span>,</span><br><span class="line">                <span class="string">"NotBlank.name"</span>,</span><br><span class="line">                <span class="string">"NotBlank.java.lang.String"</span>,</span><br><span class="line">                <span class="string">"NotBlank"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"defaultMessage"</span>: <span class="string">"must not be blank"</span>,</span><br><span class="line">            <span class="attr">"field"</span>: <span class="string">"name"</span>,</span><br><span class="line">            <span class="attr">"objectName"</span>: <span class="string">"userForm"</span>,</span><br><span class="line">            <span class="attr">"rejectedValue"</span>: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"Validation failed for object='userForm'. Error count: 1"</span>,</span><br><span class="line">    <span class="attr">"path"</span>: <span class="string">"/user"</span>,</span><br><span class="line">    <span class="attr">"status"</span>: <span class="number">400</span>,</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2020-05-10T08:44:12.952+0000"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ä¾è‘«èŠ¦ç”»ç“¢ï¼Œdebug çš„æ—¶å€™ï¼ŒæŠŠæŠ›å‡ºçš„å…·ä½“å¼‚å¸¸æ·»åŠ åˆ°å‰é¢çš„ <code>GlobalExceptionHandler</code>ï¼Œå†ä¿®æ”¹ä¸‹é»˜è®¤çš„è¡Œä¸ºå³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler</span>(BindException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">handle</span>(<span class="title">HttpServletRequest</span> <span class="title">request</span>, <span class="title">BindException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">   String key = e.getBindingResult().getAllErrors().get(<span class="number">0</span>).getDefaultMessage();</span><br><span class="line">   String i18message = getI18nMessage(key, request);</span><br><span class="line">   <span class="keyword">return</span> ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Response.error(<span class="number">400</span>, i18message));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ExceptionHandler</span>(MethodArgumentNotValidException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">handle</span>(<span class="title">HttpServletRequest</span> <span class="title">request</span>, <span class="title">MethodArgumentNotValidException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">   String key = e.getBindingResult().getAllErrors().get(<span class="number">0</span>).getDefaultMessage();</span><br><span class="line">   String i18message = getI18nMessage(key, request);</span><br><span class="line">   <span class="keyword">return</span> ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Response.error(<span class="number">400</span>, i18message));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ExceptionHandler</span>(ConstraintViolationException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">handle</span>(<span class="title">HttpServletRequest</span> <span class="title">request</span>, <span class="title">ConstraintViolationException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">   String key = e.getConstraintViolations().iterator().next().getMessage();</span><br><span class="line">   String i18message = getI18nMessage(key, request);</span><br><span class="line">   <span class="keyword">return</span> ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Response.error(<span class="number">400</span>, i18message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ”¹è¿›åï¼Œå¢åŠ è‡ªå®šä¹‰çš„ handler åï¼Œè¿”å›ä¿¡æ¯ç»“æ„ä¸€è‡´æ–¹ä¾¿å‰ç«¯ç»Ÿä¸€å¤„ç†ï¼ŒåŒæ—¶ä¹Ÿç®€æ´ä¸å°‘ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">400</span>,</span><br><span class="line">    <span class="attr">"data"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"validate.userform.name.notEmpty"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†ç»“åˆå‰é¢è®²è§£çš„é€šè¿‡i18nçš„å‚æ•°é…ç½®ï¼Œåˆå¯ä»¥å®ç°å½“æ²¡é€šè¿‡æ ¡éªŒçš„æ—¶å€™ï¼Œé”™è¯¯ä¿¡æ¯ç»Ÿä¸€ç”±å¯¹åº”çš„å›½é™…åŒ–èµ„æºæ–‡ä»¶è¿›è¡Œé…ç½®äº†ã€‚ </p><h2 id="è‡ªå®šä¹‰-Validator"><a href="#è‡ªå®šä¹‰-Validator" class="headerlink" title="è‡ªå®šä¹‰ Validator"></a>è‡ªå®šä¹‰ Validator</h2><p>å½“å†…ç½®çš„æ»¡è¶³ä¸äº†æ¡ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›å®ç°è‡ªå®šä¹‰çš„ Validatorï¼Œä¾‹å¦‚å‰æ–‡ä¸­çš„ <code>CustomParam</code>ã€‚</p><p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ª Annotationï¼Œæ–¹ä¾¿åœ¨å¯¹åº” Form çš„æ—¶å€™å¼•ç”¨æ ¡éªŒï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> tanglei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/5/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = CustomValidator<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Target</span>(</span>&#123;FIELD, METHOD, PARAMETER, ANNOTATION_TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> CustomParam &#123;</span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "name.tanglei.www.validator.CustomArray.defaultMessage"</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Documented</span></span><br><span class="line">    <span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line">    <span class="meta">@Target</span>(&#123;FIELD, METHOD, PARAMETER, ANNOTATION_TYPE&#125;)</span><br><span class="line">    <span class="meta">@interface</span> List &#123;</span><br><span class="line">        CustomParam[] value();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜éœ€è¦ä¸€ä¸ªå…·ä½“çš„ validator å®ç°ç±»ï¼Œé€šè¿‡ä¸Šé¢çš„ <code>@Constraint(validatedBy = CustomValidator.class)</code> å…³è”èµ·æ¥ã€‚æœ¬æ–‡åªæ˜¯ demoï¼Œæ‰€ä»¥å…·ä½“å‚æ•°æ ¡éªŒæ²¡æœ‰å®é™…é€»è¾‘æ„ä¹‰çš„ï¼Œä¸‹é¢å‡è®¾è¾“å…¥çš„å‚æ•°å’Œâ€œtangleiâ€ç›¸åŒåˆ™æ ¡éªŒé€šè¿‡ï¼Œå¦åˆ™æç¤ºç”¨æˆ·è¾“å…¥é”™è¯¯ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">CustomParam</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String s, ConstraintValidatorContext constraintValidatorContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == s || s.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s.equals(<span class="string">"tanglei"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            error(constraintValidatorContext, <span class="string">"Invalid params: "</span> + s);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(CustomParam constraintAnnotation)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(ConstraintValidatorContext context, String message)</span> </span>&#123;</span><br><span class="line">        context.disableDefaultConstraintViolation();</span><br><span class="line">        context.buildConstraintViolationWithTemplate(message).addConstraintViolation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹çœ‹æ•ˆæœï¼Œè¾“å…¥æ²¡æ ¡éªŒé€šè¿‡ï¼Œè¿˜æç¤ºä½ è¾“å…¥çš„å‚æ•° â€œxxâ€ ä¸ç¬¦åˆæ¡ä»¶ã€‚</p><p><img src="/resources/custom-validator-and-i18n-error-message-in-springboot/validator-bug.png" alt></p><p>æ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆå®Œç¾ï¼Ÿ</p><blockquote><p>æ³¨æ„ï¼šä¸Šæ–‡ä¸­æœ‰ä¸€ä¸ªæ¯”è¾ƒéšè”½çš„å®‰å…¨æ¼æ´ï¼Œè¯·å¤§å®¶æ³¨æ„ã€‚</p><blockquote><p>æ³¨æ„ï¼šä¸Šæ–‡ä¸­æœ‰ä¸€ä¸ªæ¯”è¾ƒéšè”½çš„å®‰å…¨æ¼æ´ï¼Œè¯·å¤§å®¶æ³¨æ„ã€‚</p><blockquote><p>æ³¨æ„ï¼šä¸Šæ–‡ä¸­æœ‰ä¸€ä¸ªæ¯”è¾ƒéšè”½çš„å®‰å…¨æ¼æ´ï¼Œè¯·å¤§å®¶æ³¨æ„ã€‚</p></blockquote></blockquote></blockquote><p>é‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼Œæ€»ä½“æ¥è¯´æœ¬æ–‡æ€è·¯è¿˜æ˜¯å€¼å¾—å€Ÿé‰´çš„ï¼ˆå¯¹åº”ä»£ç è§ <a href="https://github.com/tl3shi/demo.git" target="_blank" rel="noopener">github</a>ï¼‰ï¼Œä½†ä¸€å®šè¦æ³¨æ„ä¸è¦å®Œå…¨ç…§æŠ„ï¼Œä¸Šé¢è¯´çš„è¿™ä¸ªå®‰å…¨æ¼æ´è¿˜æŒºä¸¥é‡çš„ã€‚ç»™äºˆç‚¹æç¤ºï¼Œå°±æ˜¯åœ¨<code>CustomValidator</code> çš„å…·ä½“å®ç°ä¸­ï¼Œæœ‰æœ‹å‹äº†è§£å—ï¼Ÿæ¬¢è¿ç•™è¨€è®¨è®ºã€‚æˆ‘å°†åœ¨åé¢çš„æ–‡ç« ä¸­æ¥è®²è¿°è¿™ä¸ªå®‰å…¨æ¼æ´ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/resources/custom-validator-and-i18n-error-message-in-springboot/i18n-title.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡é€šè¿‡ç¤ºä¾‹è¯´æ˜ï¼Œåœ¨ Springboot ä¸­å¦‚ä½•è‡ªå®šä¹‰ Valid
      
    
    </summary>
    
      <category term="ç»éªŒæŠ€å·§" scheme="https://www.tanglei.name/categories/%E7%BB%8F%E9%AA%8C%E6%8A%80%E5%B7%A7/"/>
    
    
      <category term="Java" scheme="https://www.tanglei.name/tags/Java/"/>
    
      <category term="ç»éªŒæŠ€å·§" scheme="https://www.tanglei.name/tags/%E7%BB%8F%E9%AA%8C%E6%8A%80%E5%B7%A7/"/>
    
  </entry>
  
  <entry>
    <title>å¤§å®¶éƒ½çŸ¥é“é€’å½’ï¼Œå°¾é€’å½’å‘¢ï¼Ÿä»€ä¹ˆåˆæ˜¯å°¾é€’å½’ä¼˜åŒ–ï¼Ÿ</title>
    <link href="https://www.tanglei.name/blog/tail-recursive-optimization.html"/>
    <id>https://www.tanglei.name/blog/tail-recursive-optimization.html</id>
    <published>2020-05-03T00:00:00.000Z</published>
    <updated>2020-10-11T15:25:42.107Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥èŠèŠé€’å½’å‡½æ•°ã€‚ä¸ºå•¥çªç„¶æƒ³åˆ°é€’å½’ï¼Ÿå…¶å®å°±ä»ç”µå½±åå­—ã€Šææ€–æ¸¸è½®ã€‹ã€Šç›—æ¢¦ç©ºé—´ã€‹æƒ³åˆ°äº†ã€‚</p><h2 id="é€’å½’æ˜¯å•¥"><a href="#é€’å½’æ˜¯å•¥" class="headerlink" title="é€’å½’æ˜¯å•¥"></a>é€’å½’æ˜¯å•¥</h2><p>é€’å½’å‡½æ•°å¤§å®¶è‚¯å®šå†™è¿‡ï¼Œå­¦æ ¡ä¸Šè¯¾çš„æ—¶å€™ï¼Œä¼°è®¡æœ€å¼€å§‹çš„ä¾‹å­å°±æ˜¯æ–æ³¢æ‹‰å¥‘æ•°åˆ—äº†å§ã€‚ä¾‹å¦‚ï¼š </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Fibonacci</span><span class="params">(n)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (n &lt; <span class="number">2</span>) <span class="keyword">return</span> n;</span><br><span class="line"><span class="keyword">return</span> Fibonacci(n - <span class="number">1</span>) + Fibonacci(n - <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€’å½’å‡½æ•°ç®€è€Œè¨€ä¹‹å°±æ˜¯åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œåˆâ€œé€’å½’â€è°ƒç”¨è‡ªå·±ã€‚åœ¨å†™é€’å½’å‡½æ•°çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„çš„åœ°æ–¹å°±æ˜¯é€’å½’å‡½æ•°çš„ç»“æŸæ¡ä»¶ã€‚ç”¨é€’å½’å‡½æ•°ç¡®å®èƒ½ç®€åŒ–å¾ˆå¤šç®—æ³•çš„å®ç°ï¼Œæ¯”å¦‚å¸¸è§çš„äºŒå‰æ ‘éå†ç­‰ã€‚ä½†å¾€å¾€åœ¨å†™é€’å½’å‡½æ•°çš„æ—¶å€™ï¼Œæœ€å®¹æ˜“å‡ºç°çš„é—®é¢˜å°±æ˜¯æ‰€è°“çš„â€œæ ˆæº¢å‡ºâ€ã€‚</p><p>ä¸ºä»€ä¹ˆä¼šæœ‰â€œæ ˆæº¢å‡ºâ€å‘¢ï¼Ÿå› ä¸ºå‡½æ•°è°ƒç”¨çš„è¿‡ç¨‹ï¼Œéƒ½è¦å€ŸåŠ©â€œæ ˆâ€è¿™ç§å­˜å‚¨ç»“æ„æ¥ä¿å­˜è¿è¡Œæ—¶çš„ä¸€äº›çŠ¶æ€ï¼Œæ¯”å¦‚å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­çš„å˜é‡æ‹·è´ï¼Œå‡½æ•°è°ƒç”¨çš„åœ°å€ç­‰ç­‰ã€‚è€Œâ€œæ ˆâ€å¾€å¾€å­˜å‚¨ç©ºé—´æ˜¯æœ‰é™çš„ï¼Œå½“è¶…è¿‡å…¶å­˜å‚¨ç©ºé—´åï¼Œå°±ä¼šæŠ›å‡ºè‘—åçš„å¼‚å¸¸/é”™è¯¯â€œStackOverflowErrorâ€ã€‚</p><p>æˆ‘ä»¬ä»¥ä¸€ä¸ªç®€å•çš„åŠ æ³•ä¸ºä¾‹ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">1</span>) <span class="keyword">return</span> n;</span><br><span class="line">    <span class="keyword">return</span> n + sum(n<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; sum(<span class="number">100</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; sum(<span class="number">1000000</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure><p>å¾ˆç®€ç­”ï¼Œç¼–è¯‘è¿è¡Œåï¼Œæ¯”è¾ƒå°çš„æ•°å­—ï¼Œèƒ½å¾—åˆ°æ­£ç¡®çš„ç­”æ¡ˆï¼Œå½“æ•°å­—æ‰©å¤§åï¼Œå°±ä¼šç›´æ¥å‘ç”Ÿâ€œsegmentation faultâ€ã€‚ </p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">(python2<span class="number">.7</span>) âœ  hexo.tanglei.name git:(master) âœ— ./a.out</span><br><span class="line"><span class="number">5050</span></span><br><span class="line">[<span class="number">1</span>]    <span class="number">78159</span> segmentation fault  ./a.out</span><br></pre></td></tr></table></figure><h2 id="å°¾é€’å½’åˆæ˜¯å•¥ï¼Ÿ"><a href="#å°¾é€’å½’åˆæ˜¯å•¥ï¼Ÿ" class="headerlink" title="å°¾é€’å½’åˆæ˜¯å•¥ï¼Ÿ"></a>å°¾é€’å½’åˆæ˜¯å•¥ï¼Ÿ</h2><p>æˆ‘å¾—çŸ¥è¿™ä¸ªæ¦‚å¿µï¼Œæœ€å¼€å§‹è¿˜æ˜¯å› ä¸ºå¾ˆå¤šå¹´å‰ä¸€æ¬¡é¢è¯•ï¼Œé¢è¯•å®˜é—®æˆ‘â€œä½ çŸ¥é“ä»€ä¹ˆæ˜¯å°¾é€’å½’å—ï¼Ÿâ€ï¼Œæˆ‘ä»¥ä¸ºæ˜¯â€œä¼ªâ€é€’å½’ï¼Œéš¾é“æ˜¯å‡çš„é€’å½’ï¼Ÿï¼Ÿï¼Ÿå½“åˆæˆ‘ä¹Ÿæ˜¯æ‡µé€¼çŠ¶æ€ï¼ˆå½“åˆé¢è¯•å®˜å¿ä½æ²¡ç¬‘ä¹Ÿæ˜¯å‰å®³äº†ï¼‰ã€‚ä»â€œå°¾â€å­—å¯çœ‹å‡ºæ¥å³è‹¥å‡½æ•°åœ¨å°¾å·´çš„åœ°æ–¹é€’å½’è°ƒç”¨è‡ªå·±ã€‚ä¸Šé¢çš„ä¾‹å­å†™æˆå°¾é€’å½’ï¼Œå°±å˜æˆäº†å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tailsum</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> sum)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span> sum;</span><br><span class="line">    <span class="keyword">return</span> tailsum(n<span class="number">-1</span>, sum+n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥è¯•è¯•ç»“æœï¼Œè®¡ç®—ä» 1 åŠ åˆ° 1000000ï¼Œä»ç„¶æ˜¯ <code>segmentation fault</code>ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ å› ä¸ºè¿™ç§å†™æ³•ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯æœ‰å¤šå±‚çš„å‡½æ•°åµŒå¥—è°ƒç”¨ï¼Œä¸­é—´ä»ç„¶æœ‰å‹æ ˆã€å‡ºæ ˆç­‰å ç”¨äº†å­˜å‚¨ç©ºé—´ï¼ˆåªä¸è¿‡èƒ½æ¯”å‰é¢çš„æ–¹æ³•ä¼šçœéƒ¨åˆ†ç©ºé—´ï¼‰ã€‚ </p><h2 id="å°¾é€’å½’ä¼˜åŒ–"><a href="#å°¾é€’å½’ä¼˜åŒ–" class="headerlink" title="å°¾é€’å½’ä¼˜åŒ–"></a>å°¾é€’å½’ä¼˜åŒ–</h2><p>å½“ä½ ç»™ç¼–è¯‘é€‰é¡¹å¼€äº†ä¼˜åŒ–ä¹‹åï¼Œè§è¯å¥‡è¿¹çš„æ—¶åˆ»åˆ°äº†ï¼Œå±…ç„¶èƒ½ç®—å‡ºæ­£ç¡®ç»“æœã€‚å¦‚å›¾æ‰€ç¤ºï¼š </p><p><img src="/resources/tail-recursive-optimization/tailrec-cpp.jpg" alt></p><p>åŸå› å°±æ˜¯å› ä¸ºç¼–è¯‘å™¨å¸®åŠ©åšäº†å°¾é€’å½’ä¼˜åŒ–ï¼Œå¯ä»¥æ‰“å¼€æ±‡ç¼–ä»£ç çœ‹çœ‹ï¼ˆè¿™é‡Œå°±ä¸å±•ç¤º C++çš„äº†ï¼‰ã€‚åé¢æˆ‘ç”¨å¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰çš„ JVM based è¯­è¨€ Scala æ¥é˜è¿°è¿™ä¸ªä¼˜åŒ–è¿‡ç¨‹ã€‚(å¥½åƒ Java çš„ç¼–è¯‘å™¨æ²¡åšè¿™æ–¹é¢çš„ä¼˜åŒ–ï¼Œè‡³å°‘æˆ‘å®éªŒæˆ‘æœ¬åœ° JDK8 æ˜¯æ²¡æœ‰çš„ï¼Œä¸æ¸…æ¥šæœ€æ–°ç‰ˆæœ¬çš„æœ‰æœ¨æœ‰)ï¼ˆscala æœ¬èº«æä¾›äº†ä¸€ä¸ªæ³¨è§£å¸®åŠ©ç¼–è¯‘å™¨å¼ºåˆ¶æ ¡éªŒæ˜¯å¦èƒ½å¤Ÿè¿›è¡Œå°¾é€’å½’ä¼˜åŒ–<code>@tailrec</code>ï¼‰</p><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TailRecObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">tailSum</span></span>(n: <span class="type">Int</span>, sum: <span class="type">Int</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span> sum;</span><br><span class="line">        <span class="keyword">return</span> tailSum(n<span class="number">-1</span>, n+sum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">      println(tailSum(<span class="number">100</span>, <span class="number">0</span>))</span><br><span class="line">      println(tailSum(<span class="number">1000000</span>, <span class="number">0</span>))</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼Œé»˜è®¤æƒ…å†µä¸‹ <code>scalac</code> åšäº†å°¾é€’å½’ä¼˜åŒ–ï¼Œèƒ½å¤Ÿæ­£ç¡®è®¡ç®—å‡ºç»“æœï¼Œå½“é€šè¿‡ <code>-g:notailcalls</code> ç¼–è¯‘å‚æ•°å»æ‰å°¾é€’å½’ä¼˜åŒ–åï¼Œå°±å‘ç”Ÿäº† <code>Exception in thread &quot;main&quot; java.lang.StackOverflowError</code>äº†ã€‚</p><p><img src="/resources/tail-recursive-optimization/tailrec-scala.jpg" alt></p><p>æˆ‘ä»¬æ¥çœ‹çœ‹ç”Ÿæˆçš„å­—èŠ‚ç æœ‰ä»€ä¹ˆä¸åŒã€‚ </p><p><img src="/resources/tail-recursive-optimization/tailrec-scala-opti.jpg" alt="åŒ…å«å°¾é€’å½’ä¼˜åŒ–çš„å­—èŠ‚ç "></p><p><img src="/resources/tail-recursive-optimization/tailrec-scala-no-opti.jpg" alt="ä¸åŒ…å«å°¾é€’å½’ä¼˜åŒ–çš„å­—èŠ‚ç "></p><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œå°¾é€’å½’ä¼˜åŒ–åï¼Œå˜æˆå¾ªç¯äº†ï¼ˆå‰é¢çš„ C++ ç±»ä¼¼ï¼‰ã€‚</p><p>å¥½äº†ï¼Œå°¾é€’å½’å’±ä»¬å°±äº†è§£åˆ°è¿™é‡Œã€‚ä¸ªäººçœ‹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“æœ‰â€œå°¾é€’å½’â€è¿™ä¸ªç‚¹å°±å¥½äº†ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å†™é€’å½’å°±æ˜¯ä¸ºäº†æ–¹ä¾¿ï¼Œä»£ç å¯è¯»æ€§å¥½ï¼Œå¦‚æœç¡®å®æ˜¯å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±ç”¨è¿­ä»£çš„æ–¹å¼å»å®ç°ï¼Œä¸ä¾èµ–äºå…·ä½“çš„ç¼–è¯‘å™¨å®ç°ã€‚å½“ç„¶å¯¹äºåƒ scala è¿™æ ·ï¼Œæœ‰ä¸€äº›è¯­æ³•ç³–èƒ½å¤Ÿå¸®åŠ©æ ¡éªŒå’ŒéªŒè¯ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ä½†é€’å½’è½¬è¿­ä»£çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬èƒ½å…·å¤‡å²‚ä¸æ›´å¥½ã€‚<br>ä¸‹æ¬¡æƒ³èŠä»€ä¹ˆè¯é¢˜å—ï¼Ÿæ¬¢è¿ç•™è¨€ã€‚è€è§„çŸ©ï¼Œå¦‚æœæœ‰å¸®åŠ©ï¼ˆå¯¹ä½ èº«è¾¹çš„å…¶ä»–äººæœ‰å¸®åŠ©ä¹Ÿè¡Œå‘€ï¼Œä¸€ç‚¹å¸®åŠ©ä¹Ÿæ²¡æœ‰ä¹Ÿä¸ä¼šçœ‹åˆ°è¿™é‡Œäº†ï¼Œå“ˆå“ˆï¼Œè«è¦ç™½å«–ï¼‰ï¼Œå†™ç¯‡æ–‡ç« çœŸå¿ƒä¸å®¹æ˜“ï¼Œå¸Œæœ›äº²å¤šå¤šå¸®å¿™â€œåœ¨çœ‹â€ï¼Œè½¬å‘åˆ†äº«æ”¯æŒã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥èŠèŠé€’å½’å‡½æ•°ã€‚ä¸ºå•¥çªç„¶æƒ³åˆ°é€’å½’ï¼Ÿå…¶å®å°±ä»ç”µå½±åå­—ã€Šææ€–æ¸¸è½®ã€‹ã€Šç›—æ¢¦ç©ºé—´ã€‹æƒ³åˆ°äº†ã€‚&lt;/p&gt;
&lt;h2 id=&quot;é€’å½’æ˜¯å•¥&quot;&gt;&lt;a href=&quot;#é€’å½’æ˜¯å•¥&quot; class=&quot;headerlink&quot; title=&quot;é€’å½’æ˜¯å•¥&quot;&gt;&lt;/a&gt;é€’å½’æ˜¯å•¥&lt;/h2&gt;&lt;p&gt;é€’å½’å‡½æ•°å¤§å®¶è‚¯å®š
      
    
    </summary>
    
      <category term="ç»éªŒæŠ€å·§" scheme="https://www.tanglei.name/categories/%E7%BB%8F%E9%AA%8C%E6%8A%80%E5%B7%A7/"/>
    
    
      <category term="ç»éªŒæŠ€å·§" scheme="https://www.tanglei.name/tags/%E7%BB%8F%E9%AA%8C%E6%8A%80%E5%B7%A7/"/>
    
      <category term="é€’å½’" scheme="https://www.tanglei.name/tags/%E9%80%92%E5%BD%92/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€ä¸ªè·¨å¹³å°çš„æµ®ç‚¹æ•° bug</title>
    <link href="https://www.tanglei.name/blog/a-bug-relate-with-float-point-cross-platform.html"/>
    <id>https://www.tanglei.name/blog/a-bug-relate-with-float-point-cross-platform.html</id>
    <published>2020-05-01T00:00:00.000Z</published>
    <updated>2020-10-11T15:25:42.107Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä¸º 6 å¹´å‰çš„æ—§æ–‡æ•´ç†é‡å‘ï¼Œå› ä¸ºæœ€å¼€å§‹æ˜¯ workdpress çš„ç¨‹åºï¼Œåæ”¹ä¸ºé™æ€ blog è¿‡ç¨‹ä¸­ï¼Œå¯¼è‡´æ ¼å¼ç­‰æ··ä¹±ï¼Œè¿™ç¯‡<a href="https://www.tanglei.name/blog/a-bug-relate-with-float-point-between-x86-and-x64-in-csharp.html">å¹´ä¹…å¤±ä¿®æ—§æ–‡å¯ç‚¹å‡»è®¿é—®</a>ã€‚</p></blockquote><h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p>èƒŒæ™¯å°±ç®€å•ç‚¹å„¿è¯´ï¼Œå½“åˆä¸€ä¸ªé¡¹ç›® C# ç¼–å†™ï¼Œæ¶‰åŠæµ®ç‚¹è¿ç®—ï¼Œæ¥é¾™å»è„‰çœå»ï¼Œç›´æ¥çœ‹å¦‚ä¸‹ä»£ç ã€‚ï¼ˆä¸ºä»€ä¹ˆæœ‰è¿™ä¸ªé—®é¢˜äº§ç”Ÿï¼Œæ˜¯å› ä¸ºå½“åˆçº¿ä¸Šäº§ç”Ÿäº†å¾ˆè¯¡å¼‚çš„é—®é¢˜ï¼Œå’Œæœ¬åœ°è°ƒè¯•æ•ˆæœä¸ä¸€è‡´ã€‚ï¼‰</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">float</span> p3x = <span class="number">80838.0f</span>;</span><br><span class="line"><span class="keyword">float</span> p2y = <span class="number">-2499.0f</span>;</span><br><span class="line"><span class="keyword">double</span> v321 = p3x * p2y;</span><br><span class="line">Console.WriteLine(v321);</span><br></pre></td></tr></table></figure><p>å¾ˆç®€å•å§ï¼Œé©¬ä¸Šç¬”ç®—ä¸‹ç»“æœä¸º -202014162ï¼Œæ²¡é—®é¢˜ï¼Œéš¾é“C#æ²¡æœ‰äº§ç”Ÿè¿™æ ·çš„ç»“æœï¼Ÿä¸å¯èƒ½å§ï¼Œå¼€å¯ VisualStudioï¼Œcopyä»£ç è¯•è¯•ï¼Œæœç„¶ç»“æœæ˜¯-202014162ã€‚å°±è¿™æ ·å®Œäº†ä¹ˆï¼Ÿæ˜¾ç„¶æ²¡æœ‰ï¼æŠŠç¼–è¯‘æ—¶çš„é€‰é¡¹ä»AnyCPUæ”¹æˆx64è¯•è¯•~(æœåŠ¡å™¨ç¯å¢ƒæ­£æ˜¯64ä½æ»´å“¦ï¼ï¼)ç»“æœå±…ç„¶å˜æˆäº†-202014160ï¼Œå¯¹æ²¡é”™ï¼Œå°±æ˜¯-202014160ã€‚ç»†æƒ³ä¸€ä¸‹ï¼Œå› ä¸ºæµ®ç‚¹è¿ç®—çš„è¯¯å·®ï¼Œ-202014160 è¿™ä¸ªç»“æœæ˜¯åˆç†çš„ã€‚å—¯ï¼Œå†è¯•è¯•C++ã€‚// æµ‹è¯•ç¯å¢ƒIntel(R) i7-3770 CPU, windows OS 64. Visual Studio 2012 é»˜è®¤è®¾ç½®ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">float</span> p3x = <span class="number">80838.0f</span>;</span><br><span class="line"><span class="keyword">float</span> p2y = <span class="number">-2499.0f</span>;</span><br><span class="line"><span class="keyword">double</span> v321 = p3x * p2y;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span>.precision(<span class="number">15</span>);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; v321 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure><p>å‘ƒï¼Œå¥½åƒx86ã€x64éƒ½æ˜¯è¿™ä¸ªåˆç†çš„ç»“æœ -202014160ã€‚å¥‡äº†ä¸ªæ€ªäº†ã€‚å…¶å®ä¸Šé¢è¿™æ®µC++ä»£ç åœ¨ä¸åŒçš„å¹³å°ä¸‹çš„ç»“æœå¦‚ä¸‹ï¼š</p><ul><li>Windows 32/64ä½ä¸‹ï¼š-202014160</li><li>Linux 64ä½ä¸‹ï¼ˆCentOS 6 gcc 4.4.7ï¼‰ï¼š-202014160</li><li>Linux 32ä½ä¸‹ï¼ˆUbuntu 12.04+ gcc 4.6.3ï¼‰æ˜¯ï¼š-202014162</li></ul><blockquote><p>è¡¥å……è¯´æ˜ï¼šå½“åˆè¿™ç¯‡æ–‡ç« æŠ•ç¨¿åˆ°é…·å£³ï¼Œè‘—åç¨‹åºå‘˜å·¦è€³æœµè€—å­é‚£è¾¹ï¼Œè¿™éƒ¨åˆ†ç»“æœæ•°æ®æ¥è‡ªè€—å­å”å¯¹æ–‡ç« åšçš„éƒ¨åˆ†è°ƒæ•´ã€‚ï¼ˆå› ä¸ºå½“åˆè¡Œæ–‡æ²¡æŠ“ä½é‡ç‚¹ï¼Œè¿˜å¼•æ¥äº†ä¸å°‘åæ§½ï¼‰</p></blockquote><p>åˆç†çš„è¿ç®—ç»“æœï¼Œåº”è¯¥æ˜¯-202014160ï¼Œæ­£ç¡®çš„è¿ç®—ç»“æœæ˜¯-202014162ï¼Œåˆç†æ€§æ˜¯æµ®ç‚¹ç²¾åº¦ä¸å¤Ÿé€ æˆçš„ï¼ˆåæ–‡è§£é‡Šäº†åˆç†æ€§ï¼‰ã€‚è‹¥æ˜¯ç”¨ä¸¤ä¸ªdoubleç›¸ä¹˜å¯å¾—æ­£ç¡®ä¸”åˆç†çš„è¿ç®—ç»“æœã€‚// å°±åˆ«çº ç»“æˆ‘ç”¨çš„â€œæ­£ç¡®ã€åˆç†â€è¿™ä¸¤ä¸ªè¯æ˜¯å¦æ°å½“äº†ã€‚é—®é¢˜æ˜¯ä¸ºä½•C#ä¸‹X64å’ŒX86ç»“æœä¸ä¸€è‡´ï¼Ÿ</p><h2 id="æµ®ç‚¹è¿ç®—ç»“æœé”™è¯¯ä½†åˆç†çš„è§£é‡Š"><a href="#æµ®ç‚¹è¿ç®—ç»“æœé”™è¯¯ä½†åˆç†çš„è§£é‡Š" class="headerlink" title="æµ®ç‚¹è¿ç®—ç»“æœé”™è¯¯ä½†åˆç†çš„è§£é‡Š"></a>æµ®ç‚¹è¿ç®—ç»“æœé”™è¯¯ä½†åˆç†çš„è§£é‡Š</h2><p>ä¸ºä½•  80838.0f * -2499.0f = -202014160.0 æ˜¯åˆç†çš„ï¼Ÿ</p><p>32ä½æµ®ç‚¹æ•°åœ¨è®¡ç®—æœºä¸­çš„è¡¨ç¤ºæ–¹å¼ä¸ºï¼š1ä½ç¬¦å·ä½(s)-8ä½æŒ‡æ•°ä½(E)-23ä½æœ‰æ•ˆæ•°å­—(M)ï¼Œå³ï¼š</p><p><img src="/resources/a-bug-relate-with-float-point-cross-platform.md/float.webp" alt></p><p>å…¶ä¸­Eæ˜¯å®é™…è½¬æ¢æˆ1.xxxxx*2^Eçš„æŒ‡æ•°ï¼ŒMæ˜¯å»æ‰ 1 åçš„å‰é¢çš„xxxxx(èŠ‚çº¦1ä½)ã€‚</p><h3 id="1-80838-0-å¦‚ä½•è¡¨è¾¾ï¼Ÿ"><a href="#1-80838-0-å¦‚ä½•è¡¨è¾¾ï¼Ÿ" class="headerlink" title="1.  80838.0 å¦‚ä½•è¡¨è¾¾ï¼Ÿ"></a>1.  80838.0 å¦‚ä½•è¡¨è¾¾ï¼Ÿ</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">80838.0 = 1 0011 1011 1100 0110.0(äºŒè¿›åˆ¶) = 1.0011 1011 1100 0110 0*2^16</span><br><span class="line">æœ‰æ•ˆä½M = 0011 1011 1100 0110 0000 000ï¼ˆä¸€å…± 23 ä½ï¼‰</span><br><span class="line">æŒ‡æ•°ä½E = 16 + 127 = 143 = 10001111</span><br><span class="line">å†…éƒ¨è¡¨ç¤º 80838.0 = 0 [10001111] [0011 1011 1100 0110 0000 000] = 0100 0111 1001 1101 1110 0011 0000 0000 = 47 9d e3 00 //å®é™…è°ƒè¯•æ—¶çœ‹åˆ°çš„å†…å­˜å€¼ å¯èƒ½æ˜¯00 e3 9d 47æ˜¯å› ä¸ºè°ƒè¯•ç¯å¢ƒç”¨äº†å°ç«¯è¡¨ç¤ºæ³•æ³•ï¼šä½ä½å­—èŠ‚æ’å†…å­˜ä½åœ°å€ç«¯ï¼Œé«˜ä½æ’å†…å­˜é«˜åœ°å€</span><br></pre></td></tr></table></figure><h3 id="2-2499-0-å¦‚ä½•è¡¨è¾¾ï¼Ÿ"><a href="#2-2499-0-å¦‚ä½•è¡¨è¾¾ï¼Ÿ" class="headerlink" title="2. -2499.0 å¦‚ä½•è¡¨è¾¾ï¼Ÿ"></a>2. -2499.0 å¦‚ä½•è¡¨è¾¾ï¼Ÿ</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-2499.0 = -100111000011.0 = -1.001110000110 * 2^11</span><br><span class="line">æœ‰æ•ˆä½M = 0011 1000 0110 0000 0000 000</span><br><span class="line">æŒ‡æ•°ä½E = 11+127=138= 10001010</span><br><span class="line">ç¬¦å·ä½s = 1</span><br><span class="line">å†…éƒ¨è¡¨ç¤º-2499.0 = 1 [10001010] [0011 1000 0110 0000 0000 000]</span><br><span class="line">=1100 0101 0001 1100 0011 0000 0000 0000 =c5 1c 30 00</span><br></pre></td></tr></table></figure><h3 id="3-å¦‚ä½•è®¡ç®—-80838-0-2499-0"><a href="#3-å¦‚ä½•è®¡ç®—-80838-0-2499-0" class="headerlink" title="3. å¦‚ä½•è®¡ç®— 80838.0 * -2499.0 = ?"></a>3. å¦‚ä½•è®¡ç®— 80838.0 * -2499.0 = ?</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æŒ‡æ•° e = 11+16 = 27</span><br><span class="line">åˆ™æŒ‡æ•°ä½ E = e + 127 = 154 = 10011010</span><br><span class="line">æœ‰æ•ˆä½ç›¸ä¹˜ç»“æœä¸º 1.1000 0001 0100 1111 1011 1010 01 ï¼ˆå¯ä»¥è‡ªå·±åŠ¨æ‰‹å®é™…ç®—ä¸‹ï¼‰ï¼Œå®é™…ä¸­åªèƒ½æœ‰23ä½ï¼Œåé¢çš„è¢«æˆªæ–­å³1000 0001 0100 1111 1011 1010 01ï¼Œç›¸ä¹˜ç»“æœå†…éƒ¨è¡¨ç¤º=1[10011010][1000 0001 0100 1111 1011 101] = 1100 1101 0100 0000 1010 0111 1101 1101 = cd 40 a7 dd</span><br><span class="line">ç»“æœ = -1.1000 0001 0100 1111 1011 101 *2^27</span><br><span class="line">= -11000 0001 0100 1111 1011 1010000</span><br><span class="line">= -202014160</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢å¾—çŸ¥ï¼Œ32 ä½æµ®ç‚¹æ•°ï¼Œ-202014160 å°±æ˜¯åˆç†çš„ç»“æœï¼Œå®Œå…¨èƒ½è§£é‡Šæ¸…æ¥šã€‚ä½†å¦‚æœæœ‰æ•ˆæ•°å­—æ›´é•¿çš„è¯ï¼Œ ä¸Šé¢çš„å°±ä¸ä¼šè¢«æˆªæ–­ã€‚</p><h3 id="4-æ­£ç¡®çš„ç»“æœ-202014162æ€ä¹ˆå¾—æ¥ï¼Ÿ"><a href="#4-æ­£ç¡®çš„ç»“æœ-202014162æ€ä¹ˆå¾—æ¥ï¼Ÿ" class="headerlink" title="4. æ­£ç¡®çš„ç»“æœ-202014162æ€ä¹ˆå¾—æ¥ï¼Ÿ"></a>4. æ­£ç¡®çš„ç»“æœ-202014162æ€ä¹ˆå¾—æ¥ï¼Ÿ</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æœ‰æ•ˆä½ç›¸ä¹˜ç»“æœä¸º 1.1000 0001 0100 1111 1011 1010 01</span><br><span class="line">å³ç»“æœ = -1.1000 0001 0100 1111 1011 101001 *2^27</span><br><span class="line">= -11000 0001 0100 1111 1011 101001 = -202014162</span><br></pre></td></tr></table></figure><h2 id="æ ¹å› æŒ–æ˜"><a href="#æ ¹å› æŒ–æ˜" class="headerlink" title="æ ¹å› æŒ–æ˜"></a>æ ¹å› æŒ–æ˜</h2><p>ä¸Šé¢éƒ¨åˆ†è§£é‡Šäº†ä¸¤ç§ç»“æœçš„æ¥æºï¼Œä½†è²Œä¼¼æ²¡ä»æ ¹æœ¬å›åˆ°ä¸ºä»€ä¹ˆï¼Ÿç”¨C++åŒæ ·çš„ä»£ç ï¼ŒX86ï¼ŒX64ï¼ˆDEBUGä¸‹ï¼Œè¿™ä¸ªåé¢ä¼šè¯´ï¼‰ä¸‹å¾—åˆ°ä¸€è‡´çš„ç»“æœ-202014160ï¼Œå®¹æ˜“ç†è§£ä¸”ä¹Ÿæ˜¯åˆç†çš„ã€‚åŸå› ä½•åœ¨ï¼Ÿçœ‹ä¸‹ç¼–è¯‘åç”Ÿæˆçš„ä»£ç (æˆªå–å…³é”®éƒ¨åˆ†)</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//C# x86 ä¸‹</span><br><span class="line">......</span><br><span class="line">float p3x = 80838.0f;</span><br><span class="line">0000003b mov dword ptr [ebp-40h],479DE300h</span><br><span class="line">float p2y = -2499.0f;</span><br><span class="line">00000042  mov dword ptr [ebp-44h],0C51C3000h</span><br><span class="line">double v321 = p3x * p2y;</span><br><span class="line">00000049  fld dword ptr [ebp-40h]</span><br><span class="line">0000004c fmul dword ptr [ebp-44h]</span><br><span class="line">0000004f  fstp qword ptr [ebp-4Ch]</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line">//C# X64ä¸‹</span><br><span class="line">......</span><br><span class="line">float p3x = 80838.0f;</span><br><span class="line">00000045  movss xmm0,dword ptr [00000098h]</span><br><span class="line">0000004d  movss dword ptr [rbp+3Ch],xmm0</span><br><span class="line">float p2y = -2499.0f;</span><br><span class="line">00000052  movss xmm0,dword ptr [000000A0h]</span><br><span class="line">0000005a movss dword ptr [rbp+38h],xmm0</span><br><span class="line">double v321 = p3x * p2y;</span><br><span class="line">0000005f  movss xmm0,dword ptr [rbp+38h]</span><br><span class="line">00000064  mulss xmm0,dword ptr [rbp+3Ch]</span><br><span class="line">00000069  cvtss2sd xmm0,xmm0</span><br><span class="line">0000006d  movsd mmword ptr [rbp+30h],xmm0</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>C++ x86 / x64ä¸‹éƒ½ç”Ÿæˆäº†ç±»ä¼¼çš„ä»£ç ï¼ˆè¿™ä¹Ÿå°±æ˜¯ä¸ºä½• C++ x86/x64ä¸C#x64ç»“æœä¸€è‡´ï¼‰å³éƒ½ç”¨äº†å…ˆç”¨æµ®ç‚¹ä¹˜èµ·æ¥(mulss)ï¼Œç„¶åè½¬æˆdouble(cvtss2sd)ã€‚ä»ä¸Šé¢çš„æ±‡ç¼–ä»£ç å¯ä»¥çœ‹å‡º C# X86ç”Ÿæˆä»£ç ç”¨çš„æŒ‡ä»¤fld/fmul/fstpç­‰ã€‚å…¶ä¸­fld/fmul/fstpç­‰æŒ‡ä»¤æ˜¯ç”±FPU(float point unit)æµ®ç‚¹è¿ç®—å¤„ç†å™¨åšçš„ï¼ŒFPUåœ¨è¿›è¡Œæµ®ç‚¹è¿ç®—æ—¶ï¼Œç”¨äº†80ä½çš„å¯„å­˜å™¨åšç›¸å…³æµ®ç‚¹è¿ç®—ï¼Œç„¶åå†æ ¹æ®æ˜¯float/doubleæˆªå–æˆ32ä½æˆ–64ä½ã€‚éFPUçš„æƒ…å†µæ˜¯ç”¨äº†SSEä¸­128ä½å¯„å­˜å™¨(floatå®é™…åªç”¨äº†å…¶ä¸­çš„32ä½ï¼Œè®¡ç®—æ—¶ä¹Ÿæ˜¯ä»¥32ä½è®¡ç®—çš„)ï¼Œè¿™å°±æ˜¯å¯¼è‡´ä¸Šè¿°é—®é¢˜äº§ç”Ÿçš„æœ€ç»ˆåŸå› ã€‚</p><p>æµ®ç‚¹è¿ç®—æ ‡å‡†IEEE-754 æ¨èæ ‡å‡†å®ç°è€…æä¾›æµ®ç‚¹å¯æ‰©å±•ç²¾åº¦æ ¼å¼(Extended precision)ï¼ŒIntel x86å¤„ç†å™¨æœ‰FPU(float point unit)æµ®ç‚¹è¿ç®—å¤„ç†å™¨æ”¯æŒè¿™ç§æ‰©å±•ã€‚C#çš„æµ®ç‚¹æ˜¯æ”¯æŒè¯¥æ ‡å‡†çš„ï¼Œå…¶ä¸­å…¶å®˜æ–¹æ–‡æ¡£ä¹Ÿæåˆ°äº†æµ®ç‚¹è¿ç®—å¯èƒ½ä¼šäº§ç”Ÿæ¯”è¿”å›ç±»å‹æ›´é«˜ç²¾åº¦çš„å€¼ï¼ˆ<strong>æ­£å¦‚ä¸Šé¢çš„è¿”å›å€¼ç²¾åº¦å°±è¶…è¿‡äº†floatçš„ç²¾åº¦</strong>ï¼‰ï¼Œå¹¶è¯´æ˜å¦‚æœç¡¬ä»¶æ”¯æŒå¯æ‰©å±•æµ®ç‚¹ç²¾åº¦çš„è¯ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„æµ®ç‚¹è¿ç®—éƒ½å°†ç”¨æ­¤ç²¾åº¦è¿›è¡Œä»¥æé«˜æ•ˆç‡ï¼Œä¸¾ä¸ªä¾‹å­<code>x*y/z, x*y</code>çš„å€¼å¯èƒ½éƒ½åœ¨doubleçš„èƒ½åŠ›èŒƒå›´ä¹‹å¤–äº†ï¼Œä½†çœŸå®æƒ…å†µå¯èƒ½é™¤ä»¥zååˆèƒ½æŠŠç»“æœæ‹‰å›åˆ°doubleèŒƒå›´å†…ï¼Œè¿™æ ·çš„è¯ï¼Œç”¨äº†FPUçš„ç»“æœå°±ä¼šå¾—åˆ°ä¸€ä¸ªå‡†ç¡®çš„doubleå€¼ï¼Œè€ŒéFPUçš„å°±æ˜¯æ— ç©·å¤§ä¹‹ç±»çš„äº†ã€‚</p><p>å³äº§ç”Ÿå¦‚ä¸Šçš„ç»“æœåŸå› æ˜¯ï¼Œä¸¤ä¸ªæµ®ç‚¹æ•°ç›¸ä¹˜åœ¨éFPUçš„æƒ…å†µä¸‹ï¼Œç”¨äº†32ä½è®¡ç®—äº§ç”Ÿçš„ç»“æœå¯¼è‡´ç»“æœå­˜åœ¨è¯¯å·®ï¼Œè€ŒFPUæ˜¯ç”¨äº†80ä½è¿›è¡Œè®¡ç®—çš„ï¼Œæ‰€ä»¥å¾—åˆ°çš„ç»“æœæ˜¯ç²¾åº¦å¾ˆé«˜çš„ï¼Œä½“ç°åœ¨æœ¬æ–‡çš„æ¡ˆä¾‹ä¸Šå°±æ˜¯ä¸ªä½æ•°ä¸Šçš„2ã€‚æ‰€ä»¥å¤§å®¶åœ¨å†™ä»£ç çš„æ—¶å€™å¾—ä¿è¯å®é™…è¿è¡Œç¯å¢ƒ/æµ‹è¯•ç¯å¢ƒ/å¼€å‘ç¯å¢ƒçš„ä¸€è‡´æ€§(åŒ…æ‹¬OSæ¶æ„å•Šã€ç¼–è¯‘é€‰é¡¹ç­‰)å•Šï¼Œä¸ç„¶è«åå…¶å¦™çš„é—®é¢˜ä¼šäº§ç”Ÿï¼ˆæœ¬æ–‡å°±æ˜¯å¼€å‘ç¯å¢ƒä¸è¿è¡Œç¯å¢ƒä¸ä¸€è‡´å¯¼è‡´çš„é—®é¢˜ï¼Œçº ç»“äº†å¥½ä¹…æ‰å‘ç°æ˜¯è¿™ä¸ªåŸå› ï¼‰ï¼›é‡åˆ°æ¶‰åŠæµ®ç‚¹è¿ç®—çš„æ—¶å€™åˆ«å¿˜äº†æœ‰å¯èƒ½æ˜¯è¿™ä¸ªåŸå› äº§ç”Ÿçš„ï¼›å¦å¤–ï¼Œfloat/doubleæ··ç”¨çš„æƒ…å†µå¾—ç‰¹åˆ«æ³¨æ„ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œæœ¬æ–‡é€šè¿‡åˆ†æä¹‹å‰é‡åˆ°çš„ä¸€ä¸ªç–‘éš¾æ‚ç—‡å¸¦ç€å¤§å®¶ä¸€å—å›é¡¾æˆ–è€…å­¦ä¹ äº†ä¸€ä¸‹è®¡ç®—æœºå†…éƒ¨æµ®ç‚¹æ•°çš„è¡¨è¾¾ï¼Œè§£å†³äº†ç–‘é—®ã€‚æœ‰æ—¶å€™å¯èƒ½éœ€è¦è·Ÿè¿›åˆ°ç¡¬ä»¶åº•å±‚ï¼Œå½“ç„¶éšç€ç¡¬ä»¶æŠ€æœ¯çš„å‘å±•ï¼Œå¯èƒ½ä»¥å‰ç†æ‰€å½“ç„¶çš„ä¸œè¥¿åœ¨æ–°ç¡¬ä»¶çš„æƒ…å†µä¸‹ä¹Ÿä¼šæœ‰æ‰€ä¸åŒï¼ˆä¾‹å¦‚æ–‡ä¸­æåˆ°çš„ FPU ä¹Ÿæœ‰æ›´é«˜ç«¯çš„æŠ€æœ¯æ¥æ›¿æ¢äº†ï¼Œæœ¬äººå¯¹äºç¡¬ä»¶è¿™å—äº†è§£ä¸å¤šï¼Œæ„Ÿå…´è¶£å¯ä»¥æŸ¥é˜…æ›´å¤šææ–™ï¼Œé˜…è¯»åŸæ–‡æœ‰æ›´å¤šå‚è€ƒèµ„æ–™ï¼‰ã€‚</p><p>è€è§„çŸ©ï¼Œå¦‚æœæœ‰å¸®åŠ©ï¼ˆå¯¹ä½ èº«è¾¹çš„å…¶ä»–äººæœ‰å¸®åŠ©ä¹Ÿè¡Œå‘€ï¼‰ï¼Œå†™ç¯‡æ–‡ç« ä¸å®¹æ˜“ï¼Œå¸Œæœ›äº²å¤šå¤šå¸®å¿™â€œåœ¨çœ‹â€ï¼Œè½¬å‘åˆ†äº«æ”¯æŒã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡ä¸º 6 å¹´å‰çš„æ—§æ–‡æ•´ç†é‡å‘ï¼Œå› ä¸ºæœ€å¼€å§‹æ˜¯ workdpress çš„ç¨‹åºï¼Œåæ”¹ä¸ºé™æ€ blog è¿‡ç¨‹ä¸­ï¼Œå¯¼è‡´æ ¼å¼ç­‰æ··ä¹±ï¼Œè¿™ç¯‡&lt;a href=&quot;https://www.tanglei.name/blog/a-bug-relate-with-floa
      
    
    </summary>
    
      <category term="é™¤è‡­è™«" scheme="https://www.tanglei.name/categories/%E9%99%A4%E8%87%AD%E8%99%AB/"/>
    
    
      <category term="ç»éªŒæŠ€å·§" scheme="https://www.tanglei.name/tags/%E7%BB%8F%E9%AA%8C%E6%8A%80%E5%B7%A7/"/>
    
      <category term="é™¤è‡­è™«" scheme="https://www.tanglei.name/tags/%E9%99%A4%E8%87%AD%E8%99%AB/"/>
    
  </entry>
  
</feed>
